import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const y='{"title":"Virtual File System","description":"","frontmatter":{"slug":"virtual-file-system","title":"Virtual File System"},"headers":[{"level":2,"title":"Virtual File Systems Available","slug":"virtual-file-systems-available"},{"level":2,"title":"Embedded Resources","slug":"embedded-resources"},{"level":3,"title":"FileSystem Mappings","slug":"filesystem-mappings"},{"level":3,"title":"Register additional Virtual File Sources in Plugins","slug":"register-additional-virtual-file-sources-in-plugins"},{"level":3,"title":"Empty MemoryVirtualFiles registered in VirtualFileSources","slug":"empty-memoryvirtualfiles-registered-in-virtualfilesources"},{"level":3,"title":"Populate Virtual Files","slug":"populate-virtual-files"},{"level":3,"title":"Registering additional Virtual File Sources","slug":"registering-additional-virtual-file-sources"},{"level":3,"title":"Using a different Virtual Path Provider","slug":"using-a-different-virtual-path-provider"},{"level":3,"title":"Changing Physical File Path","slug":"changing-physical-file-path"},{"level":2,"title":"Overriding Embedded Resources with Static Files","slug":"overriding-embedded-resources-with-static-files"},{"level":2,"title":"GistVirtualFiles","slug":"gistvirtualfiles"},{"level":3,"title":"Batched WriteFiles APIs","slug":"batched-writefiles-apis"},{"level":3,"title":"Updating HTML and Metadata Page Templates","slug":"updating-html-and-metadata-page-templates"},{"level":2,"title":"Writable Virtual File System","slug":"writable-virtual-file-system"},{"level":3,"title":"VirtualFiles vs VirtualFileSources","slug":"virtualfiles-vs-virtualfilesources"},{"level":3,"title":"Examples","slug":"examples"},{"level":3,"title":"ServiceStack.Gap","slug":"servicestack-gap"},{"level":2,"title":"Implementing a new Virtual File System","slug":"implementing-a-new-virtual-file-system"},{"level":3,"title":"Writable Virtual Files Provider","slug":"writable-virtual-files-provider"}],"relativePath":"virtual-file-system.md","lastUpdated":1634495308454}',e={},p=t(`__VP_STATIC_START__<p>In order to access physical files in view engines from multiple sources, ServiceStack includes its own pluggable virtual file system API that lets it support multiple filesystem backends.</p><p>The virtual file system (VFS) is what allows ServiceStack to support view engines in a standard <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> websites (e.g. serving directories from the root directory) as well in self-hosting stand-alone HttpListener websites and Windows Services serving from the output <code>/bin</code> directory as well as embedded resources inside .dlls, <a href="/html-css-and-javascript-minification.html#minify-static-js-css-and-html-files">in memory filesystems</a> populated at runtime, <a href="https://github.com/ServiceStack/ServiceStack.Aws#S3VirtualFiles" target="_blank" rel="noopener noreferrer">remote datastores like AWS S3</a>, or in a <a href="https://github.com/ServiceStack/ServiceStack.Azure" target="_blank" rel="noopener noreferrer">remote Azure Blob Storage</a> or any combination of either.</p><h2 id="virtual-file-systems-available" tabindex="-1">Virtual File Systems Available <a class="header-anchor" href="#virtual-file-systems-available" aria-hidden="true">#</a></h2><p>ServiceStack has the following Virtual Files Sources available:</p><ul><li><code>FileSystemVirtualFiles</code> - Hard-disk or Network Files and Directories from a specified root directory</li><li><code>MemoryVirtualFiles</code> - Virtual Files and Folders that can be programmatically populated In Memory</li><li><code>ResourceVirtualFiles</code> - Embedded Resource Files in .dlls</li><li><code>FileSystemMapping</code> - Hard-disk or Network files made available under an custom file mapping alias</li><li><code>GistVirtualFiles</code> - Files stored in a GitHub Gist</li><li><code>S3VirtualFiles</code> - Files stored on Amazon&#39;s S3 Managed File Storage in <a href="https://github.com/ServiceStack/ServiceStack.Aws#s3virtualfiles" target="_blank" rel="noopener noreferrer">ServiceStack.Aws</a></li><li><code>AzureBlobVirtualFiles</code> - Files stored on Azure&#39;s Managed Blob Storage in <a href="https://github.com/ServiceStack/ServiceStack.Azure" target="_blank" rel="noopener noreferrer">ServiceStack.Azure</a></li><li><code>MultiVirtualFiles</code> - Any combination of any of the above Virtual File Sources under a cascading configuration</li></ul><h2 id="embedded-resources" tabindex="-1">Embedded Resources <a class="header-anchor" href="#embedded-resources" aria-hidden="true">#</a></h2><p>To enable ServiceStack to serve embedded resources in your Website&#39;s compiled <code>.dll</code> Assembly you&#39;ll need to register either an <code>Assembly</code> or a <code>Type</code> in an Assembly that contains embedded resources, e.g:</p><div class="language-csharp"><pre><code><span class="token function">SetConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HostConfig</span> <span class="token punctuation">{</span>
   EmbeddedResourceSources <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TypeInDllWithEmbeddedResources</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly <span class="token punctuation">}</span><span class="token punctuation">,</span>
   EmbeddedResourceBaseTypes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TypeInDllWithEmbeddedResources</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>By default ServiceStack automatically includes the Assembly where your <code>AppHost</code> is defined which since it&#39;s typically the same top-level assembly where all your Website assets are maintained, no configuration is required to serve any embedded resources which are accessible from the same path as it&#39;s defined in your <a href="http://VS.NET" target="_blank" rel="noopener noreferrer">VS.NET</a> project. E.g. if you have an embedded resource in your project at <code>/dir/file.js</code> it would be available from the same path where ServiceStack is mounted, e.g <code>http://localhost:1337/dir/file.js</code>.</p><h3 id="filesystem-mappings" tabindex="-1">FileSystem Mappings <a class="header-anchor" href="#filesystem-mappings" aria-hidden="true">#</a></h3><p>Custom FileSystem mappings can be easily registered under a specific alias by overriding your AppHost&#39;s <code>AddVirtualFileSources</code> and registering a custom <code>FileSystemMapping</code>, e.g:</p><div class="language-csharp"><pre><code>AddVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemMapping</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;i:\\\\images&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AddVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemMapping</span><span class="token punctuation">(</span><span class="token string">&quot;docs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d:\\\\documents&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This will let you access File System Resources under the custom <code>/img</code> and <code>/doc</code> routes, e.g:</p><ul><li><a href="http://host/img/the-image.jpg" target="_blank" rel="noopener noreferrer">http://host/img/the-image.jpg</a></li><li><a href="http://host/docs/word.doc" target="_blank" rel="noopener noreferrer">http://host/docs/word.doc</a></li></ul><h3 id="register-additional-virtual-file-sources-in-plugins" tabindex="-1">Register additional Virtual File Sources in Plugins <a class="header-anchor" href="#register-additional-virtual-file-sources-in-plugins" aria-hidden="true">#</a></h3><p>As Virtual File Sources are initialized before plugins are registered your plugin will need to implement <code>IPreInitPlugin</code> so any VFS sources are registered in its <code>Configure()</code> method, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Disk1Plugin</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IPlugin</span><span class="token punctuation">,</span> <span class="token class-name">IPreInitPlugin</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BeforePluginsLoaded</span><span class="token punctuation">(</span><span class="token class-name">IAppHost</span> appHost<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Insert higher priority Virtual Files and the start of VirtualFileSources</span>
        <span class="token class-name"><span class="token keyword">var</span></span> s3Client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AmazonS3Client</span><span class="token punctuation">(</span>AwsAccessKey<span class="token punctuation">,</span> AwsSecretKey<span class="token punctuation">,</span> RegionEndpoint<span class="token punctuation">.</span>USEast1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        appHost<span class="token punctuation">.</span>InsertVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">S3VirtualFiles</span><span class="token punctuation">(</span>s3Client<span class="token punctuation">,</span> AwsConfig<span class="token punctuation">.</span>S3BucketName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Add additional low priority Virtual Files and the end of VirtualFileSources</span>
        <span class="token class-name"><span class="token keyword">var</span></span> mountPath <span class="token operator">=</span> appHost<span class="token punctuation">.</span><span class="token function">MapProjectPath</span><span class="token punctuation">(</span><span class="token string">&quot;~/App_Data/mount/hdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        appHost<span class="token punctuation">.</span>AddVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemMapping</span><span class="token punctuation">(</span><span class="token string">&quot;disk1&quot;</span><span class="token punctuation">,</span> mountPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        appHost<span class="token punctuation">.</span>AddVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemMapping</span><span class="token punctuation">(</span><span class="token string">&quot;disk2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d:\\\\hdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token class-name">IAppHost</span> appHost<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If needed you can use the <code>MapProjectPath()</code> API to resolve a physical file path from your projects ContentPath folder.</p><p>Then you can register the plugin with your AppHost as normal, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Disk1Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Where your AppHost will serve static files from your plugin&#39;s registered path mappings, e.g:</p><div class="language-"><pre><code>/disk1/file.html -&gt; /path/to/project/App_Data/mount/hdd/file.html
/disk2/file.html -&gt; d:\\hdd\\file.html
</code></pre></div><h3 id="empty-memoryvirtualfiles-registered-in-virtualfilesources" tabindex="-1">Empty MemoryVirtualFiles registered in VirtualFileSources <a class="header-anchor" href="#empty-memoryvirtualfiles-registered-in-virtualfilesources" aria-hidden="true">#</a></h3><p>To enable <strong>shadowing</strong> of the <code>WebRoot</code> cascading Virtual File Sources, an empty <code>MemoryVirtualFiles</code> has been added to <code>InsertVirtualFileSources</code> by default where it gets inserted at the start of <code>VirtualFileSources</code>, i.e:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppHost</span> <span class="token punctuation">{</span>
    InsertVirtualFileSources <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>If needed, the individual Memory and FileSystem VFS providers in the WebRoot VFS Sources can be accessed with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> memFs <span class="token operator">=</span> appHost<span class="token punctuation">.</span>VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetMemoryVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> diskFs <span class="token operator">=</span> appHost<span class="token punctuation">.</span>VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetFileSystemVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which are also available from the <code>HostContext</code> singleton:</p><ul><li><code>HostContext.MemoryVirtualFiles</code> - <strong>WebRoot</strong> MemoryVirtualFiles</li><li><code>HostContext.FileSystemVirtualFiles</code> - <strong>WebRoot</strong> FileSystem</li></ul><p>The <strong>WebRoot</strong> Directory and <strong>ContentRoot</strong> Directories are also available from:</p><ul><li><code>HostContext.RootDirectory</code> - <strong>WebRoot</strong> <code>wwwroot/</code></li><li><code>HostContext.ContentRootDirectory</code> - <strong>ContentRoot</strong> <code>/</code></li></ul><h3 id="populate-virtual-files" tabindex="-1">Populate Virtual Files <a class="header-anchor" href="#populate-virtual-files" aria-hidden="true">#</a></h3><p>We can leverage this to provide an elegant solution for minifying static <code>.html</code>, <code>.css</code> and <code>.js</code> resources by simply pre-loading a new <strong>Memory Virtual FileSystem</strong> with minified versions of existing files and giving the Memory FS a higher precedence so any matching requests serve up the minified version first with:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IPlugin</span><span class="token punctuation">,</span> <span class="token class-name">IPostInitPlugin</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token class-name">IAppHost</span> appHost<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AfterPluginsLoaded</span><span class="token punctuation">(</span><span class="token class-name">IAppHost</span> appHost<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> memFs <span class="token operator">=</span> appHost<span class="token punctuation">.</span>VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetMemoryVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Get FileSystem Provider</span>
        <span class="token class-name"><span class="token keyword">var</span></span> fs <span class="token operator">=</span> appHost<span class="token punctuation">.</span>VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetFileSystemVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Process all .html files:</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> file <span class="token keyword">in</span> fs<span class="token punctuation">.</span><span class="token function">GetAllMatchingFiles</span><span class="token punctuation">(</span><span class="token string">&quot;*.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> contents <span class="token operator">=</span> Minifiers<span class="token punctuation">.</span>HtmlAdvanced<span class="token punctuation">.</span><span class="token function">Compress</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            memFs<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>VirtualPath<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//Process all .css files:</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> file <span class="token keyword">in</span> fs<span class="token punctuation">.</span><span class="token function">GetAllMatchingFiles</span><span class="token punctuation">(</span><span class="token string">&quot;*.css&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>file <span class="token operator">=&gt;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span>VirtualPath<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.min.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> contents <span class="token operator">=</span> Minifiers<span class="token punctuation">.</span>Css<span class="token punctuation">.</span><span class="token function">Compress</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            memFs<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>VirtualPath<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//Process all .js files</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> file <span class="token keyword">in</span> fs<span class="token punctuation">.</span><span class="token function">GetAllMatchingFiles</span><span class="token punctuation">(</span><span class="token string">&quot;*.js&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>file <span class="token operator">=&gt;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span>VirtualPath<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.min.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> js <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> contents <span class="token operator">=</span> Minifiers<span class="token punctuation">.</span>JavaScript<span class="token punctuation">.</span><span class="token function">Compress</span><span class="token punctuation">(</span>js<span class="token punctuation">)</span><span class="token punctuation">;</span>
                memFs<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>VirtualPath<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//Report any errors in StartUpErrors collection on ?debug=requestinfo</span>
                <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnStartupException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span>
                    <span class="token interpolation-string"><span class="token string">$&quot;JSMin Error in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">file<span class="token punctuation">.</span>VirtualPath</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="registering-additional-virtual-file-sources" tabindex="-1">Registering additional Virtual File Sources <a class="header-anchor" href="#registering-additional-virtual-file-sources" aria-hidden="true">#</a></h3><p>The <code>InsertVirtualFileSources</code> can be used to <strong>prepend</strong> additional Virtual File Sources at start giving them the highest priority whilst <code>AddVirtualFileSources</code> <strong>appends</strong> at the end giving them the lowest priority, which your AppHost or plugins can use to register additional Virtual File Sources:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IPlugin</span><span class="token punctuation">,</span> <span class="token class-name">IPostInitPlugin</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token class-name">IAppHost</span> appHost<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span> 
        appHost<span class="token punctuation">.</span>InsertVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GistVirtualFiles</span><span class="token punctuation">(</span><span class="token string">&quot;6de7993333b457445793f51f6f520ea8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        appHost<span class="token punctuation">.</span>AddVirtualFileSources<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemMapping</span><span class="token punctuation">(</span><span class="token string">&quot;docs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d:\\\\documents&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="using-a-different-virtual-path-provider" tabindex="-1">Using a different Virtual Path Provider <a class="header-anchor" href="#using-a-different-virtual-path-provider" aria-hidden="true">#</a></h3><p>You can also globally replace the VFS used by setting it in your AppHost, e.g. If you only want to use an InMemory File System:</p><div class="language-csharp"><pre><code><span class="token keyword">base</span><span class="token punctuation">.</span>VirtualFileSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Fine-grained control on which VFS to use can also be specified on any <a href="/plugins.html">Plugins</a> requiring access to the FileSystem like ServiceStack&#39;s built-in HTML ViewEngines, here&#39;s how you could override the VFS used in ServiceStack&#39;s Razors support:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RazorFormat</span> <span class="token punctuation">{</span> 
    VirtualFileSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryVirtualFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="changing-physical-file-path" tabindex="-1">Changing Physical File Path <a class="header-anchor" href="#changing-physical-file-path" aria-hidden="true">#</a></h3><p>You can change the physical root path from where ServiceStack serves your files from by changing <code>Config.WebHostPhysicalPath</code>, e.g. the current directory for self-hosts is where the <strong>.exe</strong> is run from, during development this is typically <code>\\bin\\Release</code>. You can change the self-host to serve files from your project folder with:</p><div class="language-csharp"><pre><code><span class="token function">SetConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HostConfig</span> <span class="token punctuation">{</span>
    WebHostPhysicalPath <span class="token operator">=</span> <span class="token function">MapProjectPath</span><span class="token punctuation">(</span><span class="token string">&quot;~/&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Where <code>~/</code> is resolved from your App&#39;s configured <code>ContentRootPath</code></p></div><h2 id="overriding-embedded-resources-with-static-files" tabindex="-1">Overriding Embedded Resources with Static Files <a class="header-anchor" href="#overriding-embedded-resources-with-static-files" aria-hidden="true">#</a></h2><p>The VFS supports multiple file source locations where you can override embedded files by including your own custom files in the same location as the embedded files. We can see how this works by overriding the built-in templates used in metadata pages:</p><h2 id="gistvirtualfiles" tabindex="-1">GistVirtualFiles <a class="header-anchor" href="#gistvirtualfiles" aria-hidden="true">#</a></h2><p>The <code>GistVirtualFiles</code> is a particular exciting addition to the collection of available <a href="/virtual-file-system.html#virtual-file-systems-available">Virtual File System providers</a>. Gist&#39;s are the perfect way to capture and share a publicly versionable snapshot of files that&#39;s validated against a authenticated user account - adding an important layer of trust and verification over an anonymous archive download.</p><p>GitHub also provide public HTTP API&#39;s to access Gist&#39;s and their metadata, that scales nicely to support small fileset snapshots where all content is returned in the public API resource request, as well as supporting larger fileset snapshots where the contents of the gist are truncated and its contents are instead downloaded from its <code>raw_url</code> in an alternative HTTP Request.</p><p><code>GistVirtualFiles</code> provides a transparent VFS abstraction over GitHub&#39;s Gist APIs so they can be used interchangeably with all other VFS providers.</p><h4 id="heirachal-and-binary-file-support" tabindex="-1">Heirachal and Binary file Support <a class="header-anchor" href="#heirachal-and-binary-file-support" aria-hidden="true">#</a></h4><p>On its surface Gists appear to only support a flat list of text files, but <code>GistVirtualFiles</code> is able to overcome these limitations by transparently encoding Binary files to <strong>Base 64</strong> behind the scenes and utilizing <code>\\</code> back-slashes in file names to maintain a heirachal file structure where it&#39;s able to implement the full VFS Provider abstraction.</p><p>ServiceStack includes good heuristics for determining which files are binary on its extension and Content Type, if your Binary file isn&#39;t recognized you can register its extension with a known binary content type or override the <code>IsBinaryFilter</code> predicate:</p><div class="language-csharp"><pre><code>MimeTypes<span class="token punctuation">.</span>ExtensionMimeTypes<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">=</span> contentType<span class="token punctuation">;</span> <span class="token comment">// e.g. MimeTypes.Binary</span>
<span class="token comment">//MimeTypes.IsBinaryFilter = contentType =&gt; ...;</span>
</code></pre></div><h4 id="read-write-and-readonly-gists" tabindex="-1">Read/Write and ReadOnly Gists <a class="header-anchor" href="#read-write-and-readonly-gists" aria-hidden="true">#</a></h4><p>It supports both public read-only and read/write gists with a GitHub <code>accessToken</code> being needed in order to perform any writes:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> gistFs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GistVirtualFiles</span><span class="token punctuation">(</span>gistId<span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> gistFsReadOnly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GistVirtualFiles</span><span class="token punctuation">(</span>gistId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="gist-refresh" tabindex="-1">Gist Refresh <a class="header-anchor" href="#gist-refresh" aria-hidden="true">#</a></h4><p>Behaviourally they differ from other VFS providers in that they&#39;re used more as a snapshot instead of a actively modified file system and their updates and are noticeably slower to both read and write then the other VFS providers.</p><p>To maximize performance the files are stored in memory after the first access and its internal cache only updated when a <strong>Write</strong> operation is performed.</p><p>If you&#39;re instead using a Gist that changes frequently you can specify how long before refreshing the cache:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> gistFs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GistVirtualFiles</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RefreshAfter <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>GitHub truncates large Gists which <code>GistVirtualFiles</code> transparently fetches behind-the-scenes on-demand, you can also eagerly fetch all truncated content with:</p><div class="language-csharp"><pre><code><span class="token keyword">await</span> gistFs<span class="token punctuation">.</span><span class="token function">LoadAllTruncatedFilesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="batched-writefiles-apis" tabindex="-1">Batched WriteFiles APIs <a class="header-anchor" href="#batched-writefiles-apis" aria-hidden="true">#</a></h3><p>As Gist HTTP API&#39;s are relatively slow, we recommend using the <code>WriteFiles</code> <strong>Batched APIs</strong> so multiple files can be updated in a single HTTP Request.</p><h3 id="updating-html-and-metadata-page-templates" tabindex="-1">Updating HTML and Metadata Page Templates <a class="header-anchor" href="#updating-html-and-metadata-page-templates" aria-hidden="true">#</a></h3><p>The HTML templates for the metadata pages are maintained as <a href="https://github.com/ServiceStack/ServiceStack/tree/master/src/ServiceStack/Templates" target="_blank" rel="noopener noreferrer">embedded html template resources</a>.</p><p>The VFS lets you replace built-in ServiceStack templates with your own by simply copying the metadata or <a href="http://bit.ly/164YbrQ" target="_blank" rel="noopener noreferrer">HtmlFormat Template files</a> you want to customize and placing them in your Website Directory at:</p><div class="language-"><pre><code>/Templates/HtmlFormat.html        // The auto HtmlFormat template
/Templates/IndexOperations.html   // The /metadata template
/Templates/OperationControl.html  // Individual operation template
</code></pre></div><p>Which you can customize locally that ServiceStack will pick up and use instead.</p><h2 id="writable-virtual-file-system" tabindex="-1">Writable Virtual File System <a class="header-anchor" href="#writable-virtual-file-system" aria-hidden="true">#</a></h2><p>The Virtual File System extended <code>IVirtualFiles</code> interface extends the read-only <code>IVirtualPathProvider</code> interface to offer a read/write API:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualFiles</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IVirtualPathProvider</span></span>
<span class="token punctuation">{</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> textContents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name">Stream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">,</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> toPath<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> textContents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name">Stream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFiles</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> filePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFolder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> textFiles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//text files only</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//binary or text files</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The single and multi-write File APIs support <code>object</code> content values of either <code>string</code>, <code>ReadOnlyMemory&lt;char&gt;</code>, <code>byte[]</code>, <code>ReadOnlyMemory&lt;byte&gt;</code>, <code>Stream</code> and <code>IVirtualFile</code> Types.</p><p>Additional allocation-efficient <code>ReadOnlyMemory&lt;T&gt;</code> APIs are also available as extension methods:</p><div class="language-csharp"><pre><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">,</span> <span class="token class-name">ReadOnlyMemory<span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">&gt;</span></span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">,</span> <span class="token class-name">ReadOnlyMemory<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">,</span> <span class="token class-name">ReadOnlyMemory<span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">&gt;</span></span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">,</span> <span class="token class-name">ReadOnlyMemory<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Folders are implicitly created when writing a file to folders that don&#39;t exist</p></div><p>The new <code>IVirtualFiles</code> API is available in local FileSystem, In Memory, Gists and S3 Virtual path providers:</p><ul><li><code>FileSystemVirtualFiles</code></li><li><code>MemoryVirtualFiles</code></li><li><code>GistVirtualFiles</code></li><li><code>S3VirtualFiles</code></li></ul><p>All <code>IVirtualFiles</code> providers share the same <a href="https://github.com/ServiceStack/ServiceStack.Aws/blob/master/tests/ServiceStack.Aws.Tests/S3/VirtualPathProviderTests.cs" target="_blank" rel="noopener noreferrer">VirtualPathProviderTests</a> ensuring a consistent behavior where it&#39;s now possible to swap between different file storage backends with simple configuration as seen in the <a href="https://github.com/ServiceStackApps/AwsApps/tree/master/src/AwsApps/imgur" target="_blank" rel="noopener noreferrer">Imgur</a> and <a href="https://github.com/ServiceStackApps/AwsApps/tree/master/src/AwsApps/restfiles" target="_blank" rel="noopener noreferrer">REST Files</a> examples.</p><h4 id="object-apis" tabindex="-1">Object APIs <a class="header-anchor" href="#object-apis" aria-hidden="true">#</a></h4><p>The <code>object GetContents()</code> API allow VFS Providers to implement more efficient file access which by default returns <code>ReadOnlyMemory&lt;char&gt;</code> for text files and <code>ReadOnlyMemory&lt;byte&gt;</code> for binary files:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualFile</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">GetContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>object</code> APIs also let you use the same source code to read/write both text and binary files which VFS providers can implement more efficiently:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> content <span class="token operator">=</span> vfs<span class="token punctuation">.</span><span class="token function">GetFile</span><span class="token punctuation">(</span>fromVirtualPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vfs<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>toVirtualPath<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In <a href="https://sharpscript.net" target="_blank" rel="noopener noreferrer">#Script</a> you can access a files text or binary contents with either:</p><div class="language-js"><pre><code>vfs<span class="token punctuation">.</span><span class="token function">fileContents</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token parameter">to</span> <span class="token operator">=&gt;</span> fileContents
vfs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fileContents<span class="token punctuation">)</span>

vfs<span class="token punctuation">.</span><span class="token function">fileTextContents</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token parameter">to</span> <span class="token operator">=&gt;</span> textContents
vfs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> textContents<span class="token punctuation">)</span>

vfs<span class="token punctuation">.</span><span class="token function">fileBytesContent</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token parameter">to</span> <span class="token operator">=&gt;</span> binaryContents
vfs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> binaryContents<span class="token punctuation">)</span>
</code></pre></div><h3 id="virtualfiles-vs-virtualfilesources" tabindex="-1">VirtualFiles vs VirtualFileSources <a class="header-anchor" href="#virtualfiles-vs-virtualfilesources" aria-hidden="true">#</a></h3><p>As typically when saving uploaded files you&#39;d only want files written to a single explicit File Storage provider, ServiceStack keeps a distinction between the existing read-only Virtual File Sources it uses internally whenever a static file is requested and the new <code>IVirtualFiles</code> which is maintained in a separate <code>VirtualFiles</code> property on <code>IAppHost</code> and <code>Service</code> base class for easy accessibility:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IAppHost</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Read/Write Virtual FileSystem. Defaults to Local FileSystem.</span>
    <span class="token return-type class-name">IVirtualFiles</span> VirtualFiles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token comment">// Cascading file sources, inc. Embedded Resources, File System, In Memory, S3.</span>
    <span class="token return-type class-name">IVirtualPathProvider</span> VirtualFileSources <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IService</span></span> <span class="token comment">//ServiceStack&#39;s convenient concrete base class</span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IVirtualFiles</span> VirtualFiles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IVirtualPathProvider</span> VirtualFileSources <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Internally ServiceStack only uses <code>VirtualFileSources</code> itself to serve static file requests. The new <code>IVirtualFiles</code> is a clean abstraction your Services can bind to when saving uploaded files which can be easily substituted when you want to change file storage backends. If not specified, <code>VirtualFiles</code> defaults to your local filesystem at your host project&#39;s root directory.</p><h3 id="examples" tabindex="-1">Examples <a class="header-anchor" href="#examples" aria-hidden="true">#</a></h3><ul><li><a href="https://github.com/ServiceStack/ServiceStack.Aws#maintain-website-content-in-s3" target="_blank" rel="noopener noreferrer">AWS RazorRockstars</a> - Serving all Razor Views and Markdown Content from a S3 bucket</li><li><a href="https://github.com/ServiceStack/ServiceStack.Aws#aws-imgur" target="_blank" rel="noopener noreferrer">AWS Imgur and REST Files</a> - 1 line configuration switch between saving files to local files or S3 Bucket</li></ul><h3 id="servicestack-gap" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack.Gap" target="_blank" rel="noopener noreferrer">ServiceStack.Gap</a> <a class="header-anchor" href="#servicestack-gap" aria-hidden="true">#</a></h3><p>See the ServiceStack.Gap project for different examples of how to create single <strong>.exe</strong> ILMerged applications with Embedded Resources and Compiled Razor Views.</p><h2 id="implementing-a-new-virtual-file-system" tabindex="-1">Implementing a new Virtual File System <a class="header-anchor" href="#implementing-a-new-virtual-file-system" aria-hidden="true">#</a></h2><p>The VFS is designed to be implementation agnostic so can be changed to use any file repository, e.g. it could easily be made to support a Redis, RDBMS, embedded Sqlite or other NoSQL back-ends.</p><p>Like most of ServiceStack&#39;s substitutable API&#39;s, the interfaces for the VFS lives in the <strong>ServiceStack.Interfaces.dll</strong> under the <a href="https://github.com/ServiceStack/ServiceStack/tree/master/src/ServiceStack.Interfaces/IO" target="_blank" rel="noopener noreferrer">ServiceStack.IO</a> namespace.</p><p>To reduce the amount of effort to implement a VFS provider you can inherit from the <a href="https://github.com/ServiceStack/ServiceStack/tree/master/src/ServiceStack.Common/VirtualPath" target="_blank" rel="noopener noreferrer"><code>ServiceStack.VirtualPath.Abstract*</code></a> that all of ServiceStack&#39;s VFS providers inherit from.</p><p>Otherwise for a clean-room implementation, you&#39;ll need to implement these interfaces in order to create a new VFS Provider:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualPathProvider</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IVirtualDirectory</span> RootDirectory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> VirtualPathSeparator <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> RealPathSeparator <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CombineVirtualPath</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> basePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">FileExists</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">DirectoryExists</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IVirtualFile</span> <span class="token function">GetFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetFileHash</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetFileHash</span><span class="token punctuation">(</span><span class="token class-name">IVirtualFile</span> virtualFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IVirtualDirectory</span> <span class="token function">GetDirectory</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> <span class="token function">GetAllMatchingFiles</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> globPattern<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> maxDepth <span class="token operator">=</span> Int32<span class="token punctuation">.</span>MaxValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> <span class="token function">GetAllFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> <span class="token function">GetRootFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualDirectory<span class="token punctuation">&gt;</span></span> <span class="token function">GetRootDirectories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsSharedFile</span><span class="token punctuation">(</span><span class="token class-name">IVirtualFile</span> virtualFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsViewFile</span><span class="token punctuation">(</span><span class="token class-name">IVirtualFile</span> virtualFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualNode</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IVirtualDirectory</span> Directory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> VirtualPath <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> RealPath <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDirectory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> LastModified <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualFile</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IVirtualNode</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IVirtualPathProvider</span> VirtualPathProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">string</span></span> Extension <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetFileHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Stream</span> <span class="token function">OpenRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">StreamReader</span> <span class="token function">OpenText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Returns ReadOnlyMemory&amp;lt;byte&amp;gt; for binary files or</span>
    <span class="token comment">/// ReadOnlyMemory&amp;lt;char&amp;gt; for text files   </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">GetContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">long</span></span> Length <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Refresh file stats for this node if supported</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualDirectory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IVirtualNode</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualNode<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsRoot <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">IVirtualDirectory</span> ParentDirectory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> Files <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualDirectory<span class="token punctuation">&gt;</span></span> Directories <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name">IVirtualFile</span> <span class="token function">GetFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">IVirtualFile</span> <span class="token function">GetFile</span><span class="token punctuation">(</span><span class="token class-name">Stack<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IVirtualDirectory</span> <span class="token function">GetDirectory</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">IVirtualDirectory</span> <span class="token function">GetDirectory</span><span class="token punctuation">(</span><span class="token class-name">Stack<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> virtualPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> <span class="token function">GetAllMatchingFiles</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> globPattern<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> maxDepth <span class="token operator">=</span> Int32<span class="token punctuation">.</span>MaxValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="writable-virtual-files-provider" tabindex="-1">Writable Virtual Files Provider <a class="header-anchor" href="#writable-virtual-files-provider" aria-hidden="true">#</a></h3><p>If you want your VFS provider to support writes where it can used in your <code>IAppHost.VirtualFiles</code>, your <code>IVirtualPathProvider</code> should also implement the interface below:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IVirtualFiles</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IVirtualPathProvider</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> textContents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name">Stream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Contents can be either:</span>
    <span class="token comment">/// string, ReadOnlyMemory&amp;lt;char&amp;gt;, byte[], \`ReadOnlyMemory&amp;lt;byte&amp;gt;, Stream or IVirtualFile </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IVirtualFile<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> toPath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> textFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> textContents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name">Stream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Contents can be either:</span>
    <span class="token comment">/// string, ReadOnlyMemory&amp;lt;char&amp;gt;, byte[], \`ReadOnlyMemory&amp;lt;byte&amp;gt;, Stream or IVirtualFile </span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFiles</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> filePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFolder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To ensure behavior conformance your VFS provider, it should also be validated against the existing <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/VirtualPathProviderTests.cs" target="_blank" rel="noopener noreferrer">VirtualPathProviderTests</a> test suite.</p>__VP_STATIC_END__`,108),o=[p];function c(l,i,r,u,k,d){return a(),s("div",null,o)}var h=n(e,[["render",c]]);export{y as __pageData,h as default};
