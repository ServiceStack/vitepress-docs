import{_ as n,c as s,o as a,a as e}from"./app.14440598.js";const m=`{"title":"v4.0.56 Release Notes","description":"","frontmatter":{"title":"v4.0.56 Release Notes","slug":"v4-0-56"},"headers":[{"level":2,"title":"Introducing AutoQuery Data!","slug":"introducing-autoquery-data"},{"level":3,"title":"Learn Once, Query Everywhere :)","slug":"learn-once-query-everywhere"},{"level":3,"title":"Use AutoQuery Viewer","slug":"use-autoquery-viewer"},{"level":2,"title":"AutoQuery Data Sources","slug":"autoquery-data-sources"},{"level":3,"title":"Memory Data Source","slug":"memory-data-source"},{"level":3,"title":"Cacheable Data Sources","slug":"cacheable-data-sources"},{"level":3,"title":"Service Data Source","slug":"service-data-source"},{"level":3,"title":"Custom AutoQuery Data Implementation","slug":"custom-autoquery-data-implementation"},{"level":2,"title":"DynamoDB Data Source!","slug":"dynamodb-data-source"},{"level":3,"title":"Optimal DynamoDB Queries","slug":"optimal-dynamodb-queries"},{"level":3,"title":"Simple AutoQuery Data Example","slug":"simple-autoquery-data-example"},{"level":3,"title":"Typed AutoQuery DynamoDB Queries","slug":"typed-autoquery-dynamodb-queries"},{"level":3,"title":"AutoQuery DynamoDB Global Index Queries","slug":"autoquery-dynamodb-global-index-queries"},{"level":3,"title":"Custom POCO Result Mappings","slug":"custom-poco-result-mappings"},{"level":3,"title":"Caching AutoQuery Services","slug":"caching-autoquery-services"},{"level":3,"title":"More Info","slug":"more-info"},{"level":3,"title":"AutoQuery Breaking Changes","slug":"autoquery-breaking-changes"},{"level":3,"title":"Other AutoQuery Features","slug":"other-autoquery-features"},{"level":2,"title":"HTTP Caching","slug":"http-caching"},{"level":3,"title":"Server Caching","slug":"server-caching"},{"level":3,"title":"HTTP Client Caching","slug":"http-client-caching"},{"level":3,"title":"Short-circuiting HTTP Cache Validation","slug":"short-circuiting-http-cache-validation"},{"level":3,"title":"New [CacheResponse] Attribute","slug":"new-cacheresponse-attribute"},{"level":3,"title":"Advanced CacheInfo Customization","slug":"advanced-cacheinfo-customization"},{"level":2,"title":"Cache-Aware Service Clients","slug":"cache-aware-service-clients"},{"level":3,"title":"Improved Performance and Reliability","slug":"improved-performance-and-reliability"},{"level":3,"title":"Community Resources on Caching","slug":"community-resources-on-caching"},{"level":2,"title":"Service Gateway","slug":"service-gateway"},{"level":3,"title":"Service Integration API's","slug":"service-integration-api-s"},{"level":3,"title":"Substitutable Service Gateways","slug":"substitutable-service-gateways"},{"level":2,"title":"Service Discovery Gateways","slug":"service-discovery-gateways"},{"level":3,"title":"ServiceStack.Discovery.Consul","slug":"servicestack-discovery-consul"},{"level":3,"title":"ServiceStack.Discovery.Redis","slug":"servicestack-discovery-redis"},{"level":3,"title":"Designing for Microservices","slug":"designing-for-microservices"},{"level":2,"title":"CSV Deserialization Support","slug":"csv-deserialization-support"},{"level":3,"title":"Super CSV Format","slug":"super-csv-format"},{"level":3,"title":"All Services now accept CSV Content-Types","slug":"all-services-now-accept-csv-content-types"},{"level":3,"title":"Ideal for Auto Batched Requests","slug":"ideal-for-auto-batched-requests"},{"level":3,"title":"CSV Request Logger","slug":"csv-request-logger"},{"level":2,"title":"Virtual FileSystem","slug":"virtual-filesystem"},{"level":2,"title":"OrmLite","slug":"ormlite"},{"level":3,"title":"Updating existing values","slug":"updating-existing-values"},{"level":3,"title":"BelongsTo Attribute","slug":"belongsto-attribute"},{"level":3,"title":"Deprecating Legacy OrmLite API's","slug":"deprecating-legacy-ormlite-api-s"},{"level":2,"title":"PocoDynamo","slug":"pocodynamo"},{"level":2,"title":"ServiceStack.Redis","slug":"servicestack-redis"},{"level":2,"title":"ServiceStackIDEA","slug":"servicestackidea"},{"level":2,"title":"Community","slug":"community"},{"level":3,"title":"ServiceStack.EventStore","slug":"servicestack-eventstore"},{"level":3,"title":"ServiceStackWithQuartz","slug":"servicestackwithquartz"},{"level":3,"title":"Caching Anyone?","slug":"caching-anyone"},{"level":2,"title":"Other Features","slug":"other-features"}],"relativePath":"releases/v4.0.56.md","lastUpdated":1634495308434}`,t={},o=e(`<p>We&#39;ve happy to announce several big ticket features in this release adding an exciting suite of functionality across the ServiceStack board!</p><h2 id="introducing-autoquery-data" tabindex="-1">Introducing AutoQuery Data! <a class="header-anchor" href="#introducing-autoquery-data" aria-hidden="true">#</a></h2><p>ServiceStack&#39;s <a href="/autoquery.html">AutoQuery</a> feature already provides the most productive way to create lightweight, high-performance data-driven Services which are able to naturally benefit from ServiceStack&#39;s wider rich, value-added ecosystem and thanks to OrmLite&#39;s typed RDBMS-agnostic API, AutoQuery has been used to create fully-queryable Services <a href="https://github.com/ServiceStack/ServiceStack.OrmLite#8-flavours-of-ormlite-is-on-nuget" target="_blank" rel="noopener noreferrer">for most major RDBMS&#39;s</a>.</p><p>Whilst AutoQuery is optimized around server-side SQL querying of Relational Databases, we also wanted to adopt its productive dev model and open it up to allow rich querying of other Data Sources as well - which we&#39;re happy to announce is now possible with AutoQuery Data!</p><h3 id="learn-once-query-everywhere" tabindex="-1">Learn Once, Query Everywhere \u{1F603} <a class="header-anchor" href="#learn-once-query-everywhere" aria-hidden="true">#</a></h3><p>AutoQuery Data is a new implementation that closely follows the dev model you&#39;re used to with AutoQuery where any experience gained in creating RDBMS AutoQuery Services previously are now also applicable to Querying alternative data sources as well where all features except for the RDBMS-specific <a href="/autoquery.html#joining-tables">Joining Tables</a> and <a href="/autoquery.html#raw-sql-filters">Raw SQL Filters</a> features also have an equivalent in AutoQuery Data as well.</p><p>Like AutoQuery you can declaratively create AutoQuery Data Services using just Request DTO&#39;s but instead of inheriting from <code>QueryBase&lt;T&gt;</code> you&#39;d instead inherit from <code>QueryData&lt;T&gt;</code>, e.g:</p><div class="language-csharp"><pre><code><span class="token comment">//AutoQuery RDBMS</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCustomers</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryBase<span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">//AutoQuery Data - Multiple / Open Data Sources </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCustomers</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>The API to call and consume both RDBMS AutoQuery and AutoQuery Data Services are indistinguishable to external clients where both are queried using the same <a href="/autoquery.html#implicit-conventions">implicit</a> and <a href="/autoquery.html#explicit-conventions">explicit conventions</a> and both return the same <code>QueryResponse&lt;T&gt;</code> Response DTO.</p><h3 id="use-autoquery-viewer" tabindex="-1">Use AutoQuery Viewer <a class="header-anchor" href="#use-autoquery-viewer" aria-hidden="true">#</a></h3><p>A direct result of this means you can reuse <a href="https://github.com/ServiceStack/Admin" target="_blank" rel="noopener noreferrer">AutoQuery Viewer</a> (announced in the previous release) to access a rich auto UI for querying all AutoQuery implementations together in the same UI, whether queries are served from an RDBMS or an alternative data source.</p><p><a href="https://github.com/ServiceStack/Admin" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Admin/master/img/query-default-values.png" alt=""></a></p><h2 id="autoquery-data-sources" tabindex="-1">AutoQuery Data Sources <a class="header-anchor" href="#autoquery-data-sources" aria-hidden="true">#</a></h2><p>AutoQuery Data supports an Open Data provider model requiring an extra piece of configuration Services need to function - the Data Source that it will query. Data Sources are registered with the <code>AutoQueryDataFeature</code> plugin by calling using its fluent <code>AddDataSource()</code> API to register all Data Sources you want available to query.</p><p>At launch there are 3 different data sources that are available - all of which are accessible as extension methods on the <code>QueryDataContext</code> parameter for easy discoverability:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoQueryDataFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">ServiceSource</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">DynamoDBSource</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="memory-data-source" tabindex="-1">Memory Data Source <a class="header-anchor" href="#memory-data-source" aria-hidden="true">#</a></h3><p>The simplest data source we can query is an in-memory .NET collection registered with <code>ctx.MemorySource()</code>. But how the collection is populated remains up to you. The example below shows registering collections from multiple sources inc. <strong>in-line code</strong>, populated <strong>from a CSV file</strong> (utilizing ServiceStack&#39;s new CSV deserialization support) and populated <strong>from a 3rd Party API</strong> using <a href="/http-utils.html">HTTP Utils</a>:</p><div class="language-csharp"><pre><code><span class="token comment">//Declaration in code</span>
<span class="token class-name"><span class="token keyword">var</span></span> countries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Country</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Country</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//From CSV File</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>Currency<span class="token punctuation">&gt;</span></span> currencies <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token string">&quot;currencies.csv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Currency<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//From 3rd Party API</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span></span> repos <span class="token operator">=</span> <span class="token string">&quot;https://api.github.com/orgs/ServiceStack/repos&quot;</span>
    <span class="token punctuation">.</span><span class="token function">GetJsonFromUrl</span><span class="token punctuation">(</span>req <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>UserAgent<span class="token operator">=</span><span class="token string">&quot;AutoQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//AutoQuery Data Plugin</span>
Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoQueryDataFeature</span> <span class="token punctuation">{</span> MaxLimit <span class="token operator">=</span> <span class="token number">100</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span>countries<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span>currencies<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span>repos<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>After data sources are registered, you can then create AutoQuery Data Services to query them:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/countries&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCountries</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>Country<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/currencies&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCurrencies</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>Currency<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/repos&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryGithubRepos</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>With just the empty Request DTO&#39;s above they&#39;re now queryable like any other AutoQuery Service, e.g:</p><ul><li>/countries?code=AU</li><li>/currencies.json?code=AUD</li><li>/repos.csv?watchers_count&gt;=100&amp;orderBy=-watchers_count,name&amp;fields=name,homepage,language</li></ul><h3 id="cacheable-data-sources" tabindex="-1">Cacheable Data Sources <a class="header-anchor" href="#cacheable-data-sources" aria-hidden="true">#</a></h3><p>The examples above provides a nice demonstration of querying static memory collections. But Data Sources offers even more flexibility where you&#39;re also able to query and cache dynamic .NET collections that are customizable per-request.</p><p>The registration below shows an example of this where results are dynamically fetched from <strong>GitHub&#39;s API</strong> and persisted in the <strong>local in-memory cache</strong> for <strong>5 minutes</strong> - throttling the number of requests made to the external 3rd Party API:</p><div class="language-csharp"><pre><code><span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
    <span class="token interpolation-string"><span class="token string">$&quot;https://api.github.com/repos/ServiceStack/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">ctx<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">GetParam</span><span class="token punctuation">(</span><span class="token string">&quot;repo&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/contributors&quot;</span></span>
      <span class="token punctuation">.</span><span class="token function">GetJsonFromUrl</span><span class="token punctuation">(</span>req <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>UserAgent<span class="token operator">=</span><span class="token string">&quot;AutoQuery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>GithubContributor<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    HostContext<span class="token punctuation">.</span>LocalCache<span class="token punctuation">,</span> 
    TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can now create an AutoQuery Data Service to query the above cached <code>GithubContributor</code> Memory Source:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/contributors&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryContributors</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>GithubContributor<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Repo <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Thanks to the Typed Request DTO we also get an end-to-end Typed API for free which we can use to query the contributors result-set returned from GitHub&#39;s API. As an example we can view the <strong>Top 20 Contributors</strong> for the <strong>ServiceStack</strong> Project with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> top20Contributors <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryContributors</span> <span class="token punctuation">{</span>
    Repo <span class="token operator">=</span> <span class="token string">&quot;ServiceStack&quot;</span><span class="token punctuation">,</span>
    OrderByDesc <span class="token operator">=</span> <span class="token string">&quot;Contributions&quot;</span><span class="token punctuation">,</span>
    Take <span class="token operator">=</span> <span class="token number">20</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

top20Contributors<span class="token punctuation">.</span><span class="token function">PrintDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Pretty print results to Console</span>
</code></pre></div><h3 id="service-data-source" tabindex="-1">Service Data Source <a class="header-anchor" href="#service-data-source" aria-hidden="true">#</a></h3><p>The next step in querying for even richer result-sets, whether you want to add custom validation, access multiple dependencies, construct complex queries or other custom business logic, you can use a <strong>Service Source</strong> instead which lets you call a Service and use its Response as the dynamic Data Source that you can apply Auto Querying logic on.</p><p><code>ServiceSource</code> is very similar to <code>MemorySource</code> however instead of passing in the in-memory collection you want to query directly, you&#39;ll need to pass a <strong>Request DTO</strong> of the Service you want called instead. The response of the Service is then further queried just as if its results were passed into a MemorySource directly.</p><p>We&#39;ll illustrate with a few examples how to register and use ServiceSources, explore some of their capabilities and provide some examples of when you may want to use them below.</p><p>The <code>UserLogin</code> ServiceSouce shows you can just pass an empty Request DTO as-is to execute its Service. The <code>RockstarAlbum</code> and <code>GithubRepo</code> Service Sources are however leveraging the built-in <a href="/auto-mapping.html">Auto Mapping</a> to copy any matching properties from the AutoQuery Request DTO to the downstream <code>GetRockstarAlbums</code> and <code>GetGithubRepos</code> Request DTO&#39;s. Finally the responses for the <code>GithubRepo</code> Service is <strong>cached for 5 minutes</strong> so any subsequent matching requests end up querying the cached result set instead of re-executing the <code>GetGithubRepos</code> Service:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoQueryDataFeature</span> <span class="token punctuation">{</span> MaxLimit <span class="token operator">=</span> <span class="token number">100</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ServiceSource</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserLogin<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTodaysUserActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ServiceSource</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Dto<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertTo</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GetRockstarAlbums<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ServiceSource</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Dto<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertTo</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GetGithubRepos<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        HostContext<span class="token punctuation">.</span>Cache<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The implementation of <code>GetTodaysUserActivity</code> Service uses an async OrmLite RDBMS call to get all User Logins within the last day, fetches the Live Activity data from Redis, then <a href="https://github.com/ServiceStack/ServiceStack.OrmLite#merge-disconnected-poco-result-sets" target="_blank" rel="noopener noreferrer">merges the disconnected POCO result sets</a> into the <code>UserLogin</code> POCO which it returns:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/useractivity/today&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryTodaysUserActivity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>UserLogin<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetTodaysUserActivity</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> logins <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserLogin<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>LastLogin <span class="token operator">&gt;=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> activities <span class="token operator">=</span> Redis<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Activity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logins<span class="token punctuation">.</span><span class="token function">Merge</span><span class="token punctuation">(</span>activities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> logins<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>GetRockstarAlbums</code> Service shows an example of a calling an existing ad hoc DB Service executing an arbitrary custom Query. It uses the Request DTO Auto-Mapping at the <code>ServiceSource</code> registration to first copy any matching properties from the initial <code>QueryRockstarAlbums</code> Request DTO to populate a new <code>GetRockstarAlbums</code> instance which is what&#39;s used to execute the Service with.</p><p>In this way the <code>QueryRockstarAlbums</code> AutoQuery Service is essentially decorating the underlying <code>GetRockstarAlbums</code> Service giving it access to AutoQuery features where clients are able to apply further post-querying server logic to an existing Service implementation which now lets them filter, sort, select only a partial list of fields, include additional aggregate queries, etc.</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbums</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> IdBetween <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetRockstarAlbums</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>IdBetween <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        q<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id <span class="token operator">&gt;=</span> request<span class="token punctuation">.</span>IdBetween<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Id <span class="token operator">&lt;=</span> request<span class="token punctuation">.</span>IdBetween<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>Name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        q<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Name <span class="token operator">==</span> request<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetRockstarAlbumsResponse</span> <span class="token punctuation">{</span> Results <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>One thing to notice is that ServiceSource still works whether the results are wrapped in a Response DTO instead of a naked <code>IEnumerable&lt;RockstarAlbum&gt;</code> collection. This is transparently supported as <code>ServiceSource</code> will use the first matching <code>IEnumerable&lt;T&gt;</code> property for Services that don&#39;t return a collection.</p><p>It should be noted that decorating an existing OrmLite Service is rarely necessary as in most cases you&#39;ll be able to get by with just a simple AutoQuery RDBMS query as seen in the Service below which replaces the above 2 Services:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbums</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>The final <code>GetGithubRepos</code> ServiceSource example shows an example of a slightly more complex implementation than a single 3rd Party API call where it adds custom validation logic and call different 3rd Party API Endpoints depending on user input:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryGithubRepo</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> User <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Organization <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">GetGithubRepos</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>User <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span>Organization <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> url <span class="token operator">=</span> request<span class="token punctuation">.</span>User <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token punctuation">?</span> <span class="token string">&quot;https://api.github.com/users/{0}/repos&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token string">&quot;https://api.github.com/orgs/{0}/repos&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Organization<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">GetJsonFromUrl</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">requestFilter</span><span class="token punctuation">:</span>req <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>UserAgent <span class="token operator">=</span> <span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>GithubRepo<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A hidden feature ServiceSources are naturally able to take advantage of due to its behind-the-scenes usage of the new <strong>ServiceGateway</strong> (announced later) is that the exact code above could still function if the <code>QueryGithubRepo</code> AutoQuery Data Service and underlying <code>GetGithubRepos</code> Service were moved to different hosts \u{1F603}</p><h3 id="custom-autoquery-data-implementation" tabindex="-1">Custom AutoQuery Data Implementation <a class="header-anchor" href="#custom-autoquery-data-implementation" aria-hidden="true">#</a></h3><p>Just like you can <a href="/autoquery.html#custom-autoquery-implementations">Create a Custom implementation</a> in AutoQuery, you can do the same in AutoQuery Data by just defining an implementation for your AutoQuery Data Request DTO. But instead of <code>IAutoQueryDb</code> you&#39;d reference the <code>IAutoQueryData</code> dependency to construct and execute your custom AutoQuery Data query.</p><p>When overriding the default implementation of an AutoQuery Data Service you also no longer need to register a Data Source as you can specify the Data Source in-line when calling <code>AutoQuery.CreateQuery()</code>.</p><p>For our custom AutoQuery Data implementation we&#39;ll look at creating a useful Service which reads the daily CSV Request and Error Logs from the new <code>CsvRequestLogger</code> (announced later) and queries it by wrapping the POCO <code>RequestLogEntry</code> results into a <code>MemoryDataSource</code>:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/query/requestlogs&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/query/requestlogs/{Date}&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRequestLogs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> Date <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> ViewErrors <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAutoQueryDataServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IAutoQueryData</span> AutoQuery <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">QueryRequestLogs</span> query<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> date <span class="token operator">=</span> query<span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">GetValueOrDefault</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> logSuffix <span class="token operator">=</span> query<span class="token punctuation">.</span>ViewErrors <span class="token punctuation">?</span> <span class="token string">&quot;-errors&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> csvLogsFile <span class="token operator">=</span> VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetFile</span><span class="token punctuation">(</span><span class="token string">&quot;requestlogs/{0}-{1}/{0}-{1}-{2}{3}.csv&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>
            date<span class="token punctuation">.</span>Year<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            date<span class="token punctuation">.</span>Month<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            date<span class="token punctuation">.</span>Day<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            logSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>csvLogsFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> HttpError<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token string">&quot;No logs found on &quot;</span> <span class="token operator">+</span> date<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> logs <span class="token operator">=</span> csvLogsFile<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> AutoQuery<span class="token punctuation">.</span><span class="token function">CreateQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Request<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">db</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryDataSource<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>logs<span class="token punctuation">,</span> query<span class="token punctuation">,</span> Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> AutoQuery<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This Service now lets you query the Request Logs of any given day, letting you filter, page and sort through the Request Logs of the day. While we&#39;re at it, let&#39;s also create multiple Custom AutoQuery Data implementations to act as canonical smart links for the above Service:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/logs/today&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TodayLogs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/logs/today/errors&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TodayErrorLogs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/logs/yesterday&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">YesterdayLogs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/logs/yesterday/errors&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">YesterdayErrorLogs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RequestLogEntry<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><p>The implementations of which just delegates to <code>QueryRequestLogs</code> with the selected Date and whether or not to show just the error logs:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">TodayLogs</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">Any</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRequestLogs</span> <span class="token punctuation">{</span> Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">TodayErrorLogs</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">Any</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRequestLogs</span> <span class="token punctuation">{</span> Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span> ViewErrors <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">YesterdayLogs</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">Any</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRequestLogs</span> <span class="token punctuation">{</span> Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">YesterdayErrorLogs</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">Any</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRequestLogs</span> <span class="token punctuation">{</span> Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ViewErrors <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And with no more effort we can jump back to <code>/ss_admin/</code> and use AutoQuery Viewer&#39;s nice UI to quickly inspect Todays and Yesterdays Request and Error Logs \u{1F603}</p><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/autoqueryviewer-csv-logs.png" alt=""></p><h2 id="dynamodb-data-source" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack.Aws" target="_blank" rel="noopener noreferrer">DynamoDB Data Source!</a> <a class="header-anchor" href="#dynamodb-data-source" aria-hidden="true">#</a></h2><p>Probably the most exciting Data Source available is <code>DynamoDbSource</code> as it provides the most productive development experience for effortlessly creating rich, queryable and optimized Services for DynamoDB data stores!</p><p><a href="https://github.com/ServiceStack/PocoDynamo" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/dynamodb-banner.png" alt=""></a></p><p>DynamoDB is the near perfect solution if you&#39;re on AWS and in need of a managed NoSQL data storage solution that can achieve near-infinite scale whilst maintaining constant single-digit millisecond performance. The primary issue with DynamoDB however is working with it&#39;s unstructured schema and API&#39;s which is reflected in the official .NET DynamoDB client providing a flexible but low-level and cumbersome development experience to work with directly. Most of these shortcomings are resolved with our POCO-friendly <a href="https://github.com/ServiceStack/PocoDynamo" target="_blank" rel="noopener noreferrer">PocoDynamo</a> client which provides an intuitive and idiomatic Typed .NET API that lets you reuse your DTO&#39;s and OrmLite POCO Data Models for persistence in DynamoDB.</p><p>Querying in DynamoDB is even more cumbersome, unlike an RDBMS which can process ad hoc queries on non-indexed fields with decent performance, every query in DynamoDB needs to be performed on an index defined ahead-of-time. Any queries not on an index needs to be sent as a Filter Expression and even more limiting is that queries can only be executed against rows containing the same hash id. If you need to query data spanning across multiple hash ids you either need to create a separate <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GSI.html" target="_blank" rel="noopener noreferrer">Global Index</a> or perform a full <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#QueryAndScan.Scan" target="_blank" rel="noopener noreferrer">SCAN operation</a> which is even slower than full table scans on an RDBMS as they need to be performed on all underlying sharded nodes which can quickly eat up your reserved provisioned throughput allotted to your DynamoDB table.</p><h3 id="optimal-dynamodb-queries" tabindex="-1">Optimal DynamoDB Queries <a class="header-anchor" href="#optimal-dynamodb-queries" aria-hidden="true">#</a></h3><p>With AutoQuery&#39;s <code>DynamoDbSource</code> a lot of these nuances are transparently handled where it will automatically create the most optimal DynamoDB Query based on the fields populated on the incoming AutoQuery Request DTO. E.g. it will perform a <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#QueryAndScan.Query" target="_blank" rel="noopener noreferrer">DynamoDB Query</a> when the <strong>Hash</strong> field is populated otherwise transparently falls back into a <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#QueryAndScan.Scan" target="_blank" rel="noopener noreferrer">Scan Operation</a>. Any conditions that query an Index field are added to the <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#QueryAndScan.Query" target="_blank" rel="noopener noreferrer">Key Condition</a>, starting first with the <strong>Range Key</strong> (if specified), otherwise uses any populated <strong>Local Indexes</strong> it can find before any of the remaining conditions are added to the <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#FilteringResults" target="_blank" rel="noopener noreferrer">Filter Expression</a>.</p><p>Transparently adopting the most optimal queries dramatically reduces development time as it lets you quickly create, change and delete DynamoDB Services without regard for Indexes where it will often fallback to <strong>SCAN</strong> operations (performance of which is unnoticeable during development). Then once you&#39;re project is ready to deploy to production, go back and analyze all remaining queries your System relies on at the end then re-create tables with the appropriate indexes so that all App queries are efficiently querying an index.</p><blockquote><p>When needed you can specify <code>.DynamoDbSource&lt;T&gt;(allowScans:false)</code> to disable anyone from executing SCAN requests when deployed to production.</p></blockquote><h3 id="simple-autoquery-data-example" tabindex="-1">Simple AutoQuery Data Example <a class="header-anchor" href="#simple-autoquery-data-example" aria-hidden="true">#</a></h3><p>To illustrate how to use AutoQuery with DynamoDB we&#39;ll walk through a simple example of querying Rockstars Albums. For this example we&#39;ll specify <a href="/autoquery.html#explicit-conventions">explicit conventions</a> so we can use ServiceStack&#39;s <a href="/csharp-client.html">typed .NET Service Clients</a> to show which fields we&#39;re going to query and also lets us call the Service with a convenient typed API:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/rockstar-albums&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbums</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>         <span class="token comment">// Primary Key | Range Key</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> RockstarId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Foreign key | Hash Key</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> IdBetween <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here we see that creating DynamoDB Queries is no different to any other AutoQuery Data Service, where the same definition is used irrespective if the data source was populated from a <code>MemorySource</code>, <code>ServiceSource</code> or <code>DynamoDbSource</code> and the only thing that would need to change to have it query an RDBMS instead is the <code>QueryDb&lt;T&gt;</code> base class.</p><p>The text in comments highlight that when the <code>RockstarAlbum</code> POCO is stored in an RDBMS <a href="https://github.com/ServiceStack/ServiceStack.OrmLite" target="_blank" rel="noopener noreferrer">OrmLite</a> creates the table with the <code>Id</code> as the Primary Key and <code>RockstarId</code> as a Foreign Key to the <code>Rockstar</code> table. This is different in DynamoDB where <a href="https://github.com/ServiceStack/PocoDynamo" target="_blank" rel="noopener noreferrer">PocoDynamo</a> behavior is to keep related records together so they can be efficiently queried and will instead Create the <code>RockstarAlbum</code> DynamoDB Table with the <code>RockstarId</code> as the Hash Key and its unique <code>Id</code> as the Range Key.</p><h4 id="register-dynamodbsource" tabindex="-1">Register DynamoDbSource <a class="header-anchor" href="#register-dynamodbsource" aria-hidden="true">#</a></h4><p>To use DynamoDB AutoQuery&#39;s you need to first configure <a href="https://github.com/ServiceStack/PocoDynamo#download" target="_blank" rel="noopener noreferrer">PocoDynamo</a> which is just a matter of passing an an initialized <code>AmazonDynamoDBClient</code> and telling PocoDynamo which DynamoDB tables you intend to use:</p><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PocoDynamo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AmazonDynamoDBClient</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Rockstar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then before using PocoDynamo, call <code>InitSchema()</code> to tell it to automatically go through and create all DynamoDB Tables that were registered but don&#39;t yet exist in DynamoDB:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> dynamo <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IPocoDynamo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dynamo<span class="token punctuation">.</span><span class="token function">InitSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>So the first time <code>InitSchema()</code> is run it will create both <code>Rockstar</code> and <code>RockstarAlbum</code> tables but will no longer create any tables on any subsequent runs. After <code>InitSchema()</code> has completed we&#39;re assured that both <code>Rockstar</code> and <code>RockstarAlbum</code> tables exist so we can start using PocoDynamo&#39;s typed APIs to populate them with Data:</p><div class="language-csharp"><pre><code>dynamo<span class="token punctuation">.</span><span class="token function">PutItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rockstar<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dynamo<span class="token punctuation">.</span><span class="token function">PutItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RockstarAlbum<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>Behind the scenes PocoDynamo efficiently creates the minimum number of <a href="http://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_BatchWriteItem.html" target="_blank" rel="noopener noreferrer">BatchWriteItem</a> requests as necessary to store all Rockstar and RockstarAlbum&#39;s.</p></blockquote><p>Now that we have data we can query we can register the AutoQuery Data plugin along with the <code>Rockstar</code> and <code>RockstarAlbum</code> DynamoDB Tables we want to be able to query:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoQueryDataFeature</span> <span class="token punctuation">{</span> MaxLimit <span class="token operator">=</span> <span class="token number">100</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DynamoDbSource</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Rockstar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DynamoDbSource</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="rockstaralbum-poco-table-definition" tabindex="-1">RockstarAlbum POCO Table Definition <a class="header-anchor" href="#rockstaralbum-poco-table-definition" aria-hidden="true">#</a></h4><p>Where <code>RockstarAlbum</code> is just a simple POCO and can be used as-is throughout all of ServiceStack&#39;s libraries inc. OrmLite, Redis, Caching Providers, Serializers, etc:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RockstarAlbum</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AutoIncrement</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">References</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Rockstar</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RockstarId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Index</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PocoDynamo uses the same generic metadata attributes in <strong>ServiceStack.Interfaces</strong> as OrmLite.</p><p>When this POCO is created in OrmLite it creates:</p><ul><li>A <code>RockstarAlbum</code> table with an <code>Id</code> auto incrementing <strong>Primary Key</strong></li><li>The <code>RockstarId</code> as the <strong>Foreign Key</strong> for the <code>Rockstar</code> table</li><li>Adds an <strong>Index</strong> on the <code>Genre</code> column.</li></ul><p>Whereas in DynamoDB, PocoDynamo creates:</p><ul><li>The <code>RockstarAlbum</code> table with the <code>Id</code> as an auto incrementing <strong>Range Key</strong></li><li>The <code>RockstarId</code> as the <strong>Hash Key</strong></li><li>Creates a <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/LSI.html" target="_blank" rel="noopener noreferrer">Local Secondary Index</a> for the Genre attribute.</li></ul><h3 id="typed-autoquery-dynamodb-queries" tabindex="-1">Typed AutoQuery DynamoDB Queries <a class="header-anchor" href="#typed-autoquery-dynamodb-queries" aria-hidden="true">#</a></h3><p>Since the properties we want to query are explicitly typed we can make use of ServiceStack&#39;s nice typed Service Client API&#39;s to call this Service and fetch Kurt Cobains <strong>Grunge</strong> Albums out of the first 5 recorded:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstarAlbums</span> <span class="token punctuation">{</span> <span class="token comment">//QUERY </span>
    RockstarId <span class="token operator">=</span> kurtCobainId<span class="token punctuation">,</span> <span class="token comment">//Key Condition</span>
    IdBetween <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//Key Condition</span>
    Genre <span class="token operator">=</span> <span class="token string">&quot;Grunge&quot;</span><span class="token punctuation">,</span>          <span class="token comment">//Filter Condition</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

response<span class="token punctuation">.</span><span class="token function">PrintDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Pretty print results to Console</span>
</code></pre></div><p>As illustrated in the comments, DynamoDB AutoQuery performs the most efficient DynamoDB Query required in order to satisfy this request where it will create a <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/QueryAndScan.html#QueryAndScan.Query" target="_blank" rel="noopener noreferrer">Query Request</a> with the <code>RockstarId</code> and <code>IdBetween</code> conditions added to the <strong>Key Condition</strong> and the remaining <code>Genre</code> added as a <strong>Filter Expression</strong>.</p><p>If we instead wanted to fetch all of Kurt Cobains <strong>Grunge</strong> Albums where there was no longer a condition on the Album <code>Id</code> <strong>Range Key</strong>, i.e:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstarAlbums</span> <span class="token punctuation">{</span> <span class="token comment">//QUERY</span>
    RockstarId <span class="token operator">=</span> kurtCobainId<span class="token punctuation">,</span> <span class="token comment">//Key Condition</span>
    Genre <span class="token operator">=</span> <span class="token string">&quot;Grunge&quot;</span><span class="token punctuation">,</span>          <span class="token comment">//Key Condition</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It would instead create a <strong>Query Request</strong> configured to use the Genre <strong>Local Secondary Index</strong> and have added both <code>RockstarId</code> Hash Key and index <code>Genre</code> to the <strong>Key Condition</strong>.</p><p>But if you instead wanted to view all Grunge Albums, i.e:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstarAlbums</span> <span class="token punctuation">{</span> <span class="token comment">//SCAN</span>
    Genre <span class="token operator">=</span> <span class="token string">&quot;Grunge&quot;</span>            <span class="token comment">//Filter Condition</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As no Hash Key was specified it would instead create a <strong>SCAN Request</strong> where as there&#39;s no index, it adds all conditions to the <strong>Filter Expression</strong>.</p><h3 id="autoquery-dynamodb-global-index-queries" tabindex="-1">AutoQuery DynamoDB Global Index Queries <a class="header-anchor" href="#autoquery-dynamodb-global-index-queries" aria-hidden="true">#</a></h3><p>For times when you need to perform an efficient <strong>Query Request</strong> across multiple hash keys you will need to create a <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GSI.html" target="_blank" rel="noopener noreferrer">Global Secondary Index</a>. Luckily this is easy to do in PocoDynamo where you can define Global Indexes with a simple POCO class definition:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RockstarAlbumGenreIndex</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IGlobalIndex<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HashKey</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RangeKey</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token comment">// projected property</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RockstarId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// projected property</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Global Indexes can be thought of as &quot;automatically synced tables&quot; specified with a different Hash Key. Just like DynamoDB tables you can specify the <strong>Hash Key</strong> you want to globally query and create the Index on as well as a separate <strong>Range Key</strong> you want to be able to perform efficient <strong>Key Condition</strong> queries on. You&#39;ll also want to specify any properties you want returned when querying the Global Index so they&#39;ll be automatically projected and stored with the Global Index, ensuring fast access.</p><p>Then to have PocoDynamo create the Global Index it should be referenced on the table the Global Index is on:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">References</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">RockstarAlbumGenreIndex</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RockstarAlbum</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre></div><p>When referenced, <code>InitSchema()</code> will create the <code>RockstarAlbumGenreIndex</code> Global Secondary Index when it creates the <code>RockstarAlbum</code> DynamoDB Table.</p><p>With the Global Index created we can now query it just like we would any other DynamoDB AutoQuery but instead of querying a table, we query the Index instead:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbumsGenreIndex</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbumGenreIndex<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>     <span class="token comment">// Hash Key</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> IdBetween <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// Range Key</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once defined you can query it just like any other AutoQuery Service where you&#39;re now able to perform efficient queries by <strong>Genre</strong> across all Rockstar Album&#39;s:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> QueryRockstarAlbumsGenreIndex <span class="token comment">//QUERY</span>
<span class="token punctuation">{</span>
    Genre <span class="token operator">=</span> <span class="token string">&quot;Grunge&quot;</span><span class="token punctuation">,</span>              <span class="token comment">//Key Condition</span>
    IdBetween <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//Key Condition</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="custom-poco-result-mappings" tabindex="-1">Custom POCO Result Mappings <a class="header-anchor" href="#custom-poco-result-mappings" aria-hidden="true">#</a></h3><p>A noticeable difference from querying a Global Index instead of the Table directly is that results are returned in a different <code>RockstarAlbumGenreIndex</code> POCO. Luckily we can use AutoQuery&#39;s <a href="/autoquery.html#returning-custom-results">Custom Results Feature</a> to map the properties back into the original table <code>RockstarAlbum</code> with:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbumsGenreIndex</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbumGenreIndex<span class="token punctuation">,</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> IdBetween <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now when we query the Index we get our results populated in <code>RockstarAlbum</code> DTO&#39;s instead:</p><div class="language-csharp"><pre><code><span class="token class-name">QueryResponse<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstarAlbumsGenreIndex</span>
<span class="token punctuation">{</span>
    Genre <span class="token operator">=</span> <span class="token string">&quot;Grunge&quot;</span><span class="token punctuation">,</span>              <span class="token comment">//Key Condition</span>
    IdBetween <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//Key Condition</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="caching-autoquery-services" tabindex="-1">Caching AutoQuery Services <a class="header-anchor" href="#caching-autoquery-services" aria-hidden="true">#</a></h3><p>One of the many benefits of AutoQuery Services being just regular ServiceStack Services is that we get access to ServiceStack&#39;s rich ecosystem of enhanced functionality around existing Services. An example added in this release is ServiceStack&#39;s new HTTP Caching feature which lets you easily cache a Service with the new <code>[CacheResponse]</code> attribute, letting you declaratively specify how long you want to cache identical requests for on the <strong>Server</strong> as well as a <code>MaxAge</code> option for instructing the <strong>Client</strong> how long they should consider their local cache is valid for and any custom <code>Cache-Control</code> behavior you want them to have, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/rockstar-albums&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> MaxAge <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> CacheControl <span class="token operator">=</span> CacheControl<span class="token punctuation">.</span>MustRevalidate<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbums</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>         
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> RockstarId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Genre <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> IdBetween <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So with just the above single Request DTO we&#39;ve declaratively created a fully-queryable DynamoDB AutoQuery Service that transparently executes the most ideal DynamoDB queries for each request, has it&#39;s optimal representation efficiently cached on both Server and clients, whose Typed DTO can be reused as-is on the client to call Services with an end-to-end Typed API using any <a href="/csharp-client.html">.NET Service Client</a>, that&#39;s also available to external developers in a clean typed API, natively in their preferred language of choice, accessible with just a right-click menu integrated inside <a href="http://VS.NET" target="_blank" rel="noopener noreferrer">VS.NET</a>, Xcode, Android Studio, IntelliJ and Eclipse - serving both PCL Xamarin.iOS/Android as well as native iOS and Android developers by just<br><a href="/add-servicestack-reference.html">Adding a ServiceStack Reference</a> to the base URL of a remote ServiceStack Instance - all without needing to write any implementation!</p><h3 id="more-info" tabindex="-1">More Info <a class="header-anchor" href="#more-info" aria-hidden="true">#</a></h3><p>For more examples exploring different AutoQuery Data features checkout the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/AutoQueryDataTests.cs" target="_blank" rel="noopener noreferrer">AutoQuery Data Tests</a> and <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/AutoQueryDataTests.Dynamo.cs" target="_blank" rel="noopener noreferrer">AutoQuery DynamoDB Tests</a> that can be compared on a feature-by-feature basis against the existing <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/AutoQueryTests.cs" target="_blank" rel="noopener noreferrer">AutoQuery Tests</a> they were originally based on.</p><h3 id="autoquery-breaking-changes" tabindex="-1">AutoQuery Breaking Changes <a class="header-anchor" href="#autoquery-breaking-changes" aria-hidden="true">#</a></h3><p>As there are now 2 independent AutoQuery implementations we felt it necessary to rename the existing AutoQuery Types to establish a clear naming convention making it obvious which implementation the different Types are for. Types that are specific to the existing <strong>RDBMS</strong> AutoQuery now starts with <code>QueryDb*</code> whereas equivalent Types for AutoQuery <strong>Data</strong> start with <code>QueryData*</code>. The decorated example below shows an example of these differences:</p><div class="language-csharp"><pre><code><span class="token comment">//AutoQuery RDBMS</span>
<span class="token punctuation">[</span><span class="token function">QueryDb</span><span class="token punctuation">(</span>QueryTerm<span class="token punctuation">.</span>Or<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCustomers</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">QueryDbField</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Term <span class="token operator">=</span> QueryTerm<span class="token punctuation">.</span>Or<span class="token punctuation">,</span> Operand <span class="token operator">=</span> <span class="token string">&quot;&gt;=&quot;</span><span class="token punctuation">,</span> Field <span class="token operator">=</span> <span class="token string">&quot;LastName&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> OrAgeOlderThan <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoQueryRDBMSServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IAutoQueryDb</span> AutoQuery <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">//AutoQuery Data - Multiple / Open Data Sources </span>
<span class="token punctuation">[</span><span class="token function">QueryData</span><span class="token punctuation">(</span>QueryTerm<span class="token punctuation">.</span>Or<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryCustomers</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">QueryDataField</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Term <span class="token operator">=</span> QueryTerm<span class="token punctuation">.</span>Or<span class="token punctuation">,</span> Condition <span class="token operator">=</span> <span class="token string">&quot;&gt;=&quot;</span><span class="token punctuation">,</span> Field <span class="token operator">=</span> <span class="token string">&quot;LastName&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> OrAgeOlderThan <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoQueryDataServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IAutoQueryData</span> AutoQuery <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For backwards compatibility we&#39;re continuing to support the most common usage for creating AutoQuery Services that just inherit <code>QueryBase&lt;T&gt;</code>, but this is now deprecated in favor of <code>QueryDb&lt;T&gt;</code>. All other existing <code>[Query*]</code> attributes will need to be renamed to <code>[QueryDb*]</code> as seen above, likewise <code>IAutoQuery</code> is also deprecated and renamed to <code>IAutoQueryDb</code>. If in doubt please check any the deprecation message on types with any build errors as they&#39;ll indicate the name of the new Type it should be renamed to.</p><p>We deeply regret any inconvenience these changes causes as we didn&#39;t foresee we&#39;d extend AutoQuery Services to support multiple Data Sources beyond the RDBMS of which it was designed for. Introducing a clear naming convention now establishes a clear symmetry between both implementations which we expect to reduce a lot of confusion in future.</p><h3 id="other-autoquery-features" tabindex="-1">Other AutoQuery Features <a class="header-anchor" href="#other-autoquery-features" aria-hidden="true">#</a></h3><h4 id="customizable-fields" tabindex="-1">Customizable Fields <a class="header-anchor" href="#customizable-fields" aria-hidden="true">#</a></h4><p>AutoQuery&#39;s <a href="/autoquery.html#customizable-fields">Customizable Fields</a> received some improvements where the fields list are now <strong>case-insensitive</strong>, e.g:</p><pre><code>?fields=columnA,COLUMNB 
</code></pre><p>There&#39;s also now support for <strong>wildcards</strong> which let you quickly reference all fields on a table using the <code>table.*</code> format, e.g:</p><pre><code>?fields=id,departmentid,department,employee.*
</code></pre><p>Which is a shorthand that expands to manually listing each field in the <code>Employee</code> table, useful for queries which joins multiple tables, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryEmployees</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IJoin<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">,</span> EmployeeType<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IJoin<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">,</span> Department<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IJoin<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">,</span> Title<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="exclude-autoquery-collections-from-being-initialized" tabindex="-1">Exclude AutoQuery Collections from being initialized <a class="header-anchor" href="#exclude-autoquery-collections-from-being-initialized" aria-hidden="true">#</a></h4><p>The default configuration for all languages supported in <a href="/add-servicestack-reference.html">Add ServiceStack Reference</a> is to <a href="/csharp-add-servicestack-reference.html#initializecollections">InitializeCollections</a> which allows for a nicer client API in which clients can assume Request DTO&#39;s have their collections initialized allowing them to use the shorthand collection initializer syntax, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SearchQuestions</span> <span class="token punctuation">{</span> 
    Tags <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;redis&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ormlite&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>A problem with this is that AutoQuery encourages having multiple collection properties, most of which will remain unused but would still have an empty collection initialized for all unused properties that are then emitted on the wire. To help with this we&#39;ve made it easy to prevent collections from being emitted in AutoQuery DTO&#39;s by configuring the pre-registered <code>NativeTypesFeature</code> plugin below with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> nativeTypes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetPlugin</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NativeTypesFeature<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nativeTypes<span class="token punctuation">.</span>InitializeCollectionsForType <span class="token operator">=</span> NativeTypesFeature<span class="token punctuation">.</span>DontInitializeAutoQueryCollections<span class="token punctuation">;</span>
</code></pre></div><h2 id="http-caching" tabindex="-1">HTTP Caching <a class="header-anchor" href="#http-caching" aria-hidden="true">#</a></h2><p>Another big ticket feature we expect to prove extremely valuable is the improved story around HTTP Caching that transparently improves the behavior of existing <code>ToOptimized</code> Cached Responses, provides a typed API to to opt-in to <strong>HTTP Client</strong> features, introduces a simpler declarative API for enabling both <strong>Server and Client Caching</strong> of Services and also includes Cache-aware clients that are able to improve the performance and robustness of all existing .NET Service Clients - functionality that&#39;s especially valuable to bandwidth-constrained Xamarin.iOS / Xamarin.Android clients offering improved performance and greater resilience.</p><p>The new caching functionality is encapsulated in the new <code>HttpCacheFeature</code> plugin that&#39;s pre-registered by default and can be removed to disable the new HTTP Caching behavior with:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">RemoveAll</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token keyword">is</span> <span class="token class-name">HttpCacheFeature</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="server-caching" tabindex="-1">Server Caching <a class="header-anchor" href="#server-caching" aria-hidden="true">#</a></h3><p>To explain the new HTTP Caching features we&#39;ll revisit the ServiceStack&#39;s previous caching support which enables what we refer to as <strong>Server Caching</strong> where the response of a Service is cached in the registered <a href="/caching.html">Caching Provider</a> by calling the <code>ToOptimizedResult*</code> API&#39;s which lets you programmatically construct the Cache Key and/or how long the cache should be persisted for, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomers</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//Good candidates: request.ToGetUrl() or base.Request.RawUrl</span>
        <span class="token class-name"><span class="token keyword">var</span></span> cacheKey <span class="token operator">=</span> <span class="token string">&quot;unique_key_for_this_request&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> expireCacheIn <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> Request<span class="token punctuation">.</span><span class="token function">ToOptimizedResultUsingCache</span><span class="token punctuation">(</span>Cache<span class="token punctuation">,</span> cacheKey<span class="token punctuation">,</span> expireCacheIn<span class="token punctuation">,</span> 
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//Delegate executed only if item doesn&#39;t already exist in cache </span>
                <span class="token comment">//Any response DTO returned is cached on subsequent requests</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As the name indicates this stores the most optimal representation of the Service Response in the registered <code>ICacheClient</code>, so for example if a client called the above API with <code>Accept: application/json</code> and <code>Accept-Encoding: deflate, gzip</code> HTTP Request Headers ServiceStack would store the deflated serialized JSON bytes in the Cache and on subsequent requests resulting in the same cache key would write the compressed deflated bytes directly to the Response OutputStream - saving both CPU and bandwidth.</p><h4 id="more-optimal-optimizedresults" tabindex="-1">More Optimal OptimizedResults <a class="header-anchor" href="#more-optimal-optimizedresults" aria-hidden="true">#</a></h4><p>But there&#39;s an even more optimal result we could return instead: <strong>Nothing</strong> \u{1F603} and save even more CPU and bandwidth! Which is precisely what the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html" target="_blank" rel="noopener noreferrer">HTTP Caching</a> directives built into the HTTP spec allow for. To enable it you&#39;d need to return additional HTTP Headers to the client containing the necessary metadata they can use to determine when their locally cached responses are valid. Typically this is the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.3.1" target="_blank" rel="noopener noreferrer">Last-Modified</a> date of when the Response/Resource was last modified or an <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.3.2" target="_blank" rel="noopener noreferrer">Entity Tag</a> containing an opaque string the Server can use to determine whether the client has the most up-to-date response.</p><p>The most optimal cache validator we can use for existing <code>ToOptimizedResult*</code> API&#39;s is the <strong>Last Modified</strong> date which is now being cached along with the response. An additional instruction we need to return to the client is the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9" target="_blank" rel="noopener noreferrer">Cache-Control</a> HTTP Response Header which instructs the client what caching behavior to apply to the server response. As we want the new behavior to work transparently without introducing caching issues to existing Services, we&#39;ve opted for a conservative:</p><pre><code>Cache-Control: max-age=0
</code></pre><p>Which tells the client to treat the server response as immediately stale and that it should send another request to the Server for identical requests, but this time the client will append a <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.25" target="_blank" rel="noopener noreferrer">If-Modified-Since</a> HTTP Request Header which ServiceStack now automatically looks up to determine if the cache the client has is valid. If no newer cache for this request has been created since, ServiceStack returns a <strong>304 NotModified</strong> Response with an empty Request Body which tells the client it&#39;s safe to use their local cache instead.</p><h4 id="modify-cache-control-for-optimizedresults" tabindex="-1">Modify Cache-Control for OptimizedResults <a class="header-anchor" href="#modify-cache-control-for-optimizedresults" aria-hidden="true">#</a></h4><p>You can change the <code>Cache-Control</code> Header returned for existing <code>ToOptimizedResult</code> responses by modifying the pre-registered <code>HttpCacheFeature</code>, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> cacheFeature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetPlugin</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HttpCacheFeature<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cacheFeature<span class="token punctuation">.</span>CacheControlForOptimizedResults <span class="token operator">=</span> <span class="token string">&quot;max-age=3600, must-revalidate&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>This tells the client that they can treat their locally cached server responses as <strong>valid for 1hr</strong><br> but <strong>after 1hr</strong> they must check back with the Server to determine if their cache is still valid.</p><h3 id="http-client-caching" tabindex="-1">HTTP Client Caching <a class="header-anchor" href="#http-client-caching" aria-hidden="true">#</a></h3><p>The Caching features above revolve around enhancing existing <strong>Server Cached</strong> responses with <strong>HTTP Caching</strong> features to further reduce latency and save CPU and bandwidth resources. In addition to <strong>Server Caching</strong> pure stand-alone <strong>HTTP Caching</strong> features (i.e. that don&#39;t cache server responses) are now available as first-class properties on <code>HttpResult</code>:</p><div class="language-csharp"><pre><code><span class="token comment">// Only one Cache Validator below needs to be specified:</span>
<span class="token keyword">string</span> ETag            <span class="token comment">// opaque string representing integrity of response</span>
DateTime<span class="token punctuation">?</span> LastModified <span class="token comment">// the last time the response was Modified</span>

<span class="token comment">// Specify Client/Middleware Cache Behavior</span>
TimeSpan<span class="token punctuation">?</span> MaxAge          <span class="token comment">// How long cached response is considered valid</span>
CacheControl CacheControl <span class="token comment">// More options to specify Cache-Control behavior:</span>
<span class="token keyword">enum</span> <span class="token class-name">CacheControl</span> <span class="token punctuation">{</span>
    None<span class="token punctuation">,</span>
    Public<span class="token punctuation">,</span>
    Private<span class="token punctuation">,</span>
    MustRevalidate<span class="token punctuation">,</span>
    NoCache<span class="token punctuation">,</span>
    NoStore<span class="token punctuation">,</span>
    NoTransform<span class="token punctuation">,</span>
    ProxyRevalidate<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Available, but rarely used</span>
TimeSpan<span class="token punctuation">?</span> Age      <span class="token comment">// Used by proxies to indicate how old cache is</span>
DateTime<span class="token punctuation">?</span> Expires  <span class="token comment">// Less preferred alternative to MaxAge</span>
</code></pre></div><p>We&#39;ll walk through a couple of real-world examples to show how we can make use of these new properties and explain the HTTP Caching behavior they enable.</p><h4 id="using-etags" tabindex="-1">Using ETags <a class="header-anchor" href="#using-etags" aria-hidden="true">#</a></h4><p>The minimum properties required for HTTP Caching is to specify either an <code>ETag</code> or <code>LastModified</code> Caching Validator. You can use any opaque string for the <code>ETag</code> that uniquely represents a version of the response that you can use to determine what version the client has, which could be an MD5 or SHA Hash of the response but can also be a unique version string. E.g. Adding a <code>RowVersion</code> property to your OrmLite POCO Data Models turns on <a href="https://github.com/ServiceStack/ServiceStack.OrmLite#optimistic-concurrency" target="_blank" rel="noopener noreferrer">OrmLite&#39;s Optimistic Concurrency</a> feature where each time a record is modified it&#39;s automatically populated with a new version, these characteristics makes it ideal for use as an ETag which we can just return as a string:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomer</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpResult</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ETag <span class="token operator">=</span> response<span class="token punctuation">.</span>RowVersion<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Whilst this is the minimum info required in your Services, the client also needs to know how long the cache is valid for as typically indicated by the <code>MaxAge</code> property. If it&#39;s omitted ServiceStack falls back to use the <code>HttpCacheFeature.DefaultMaxAge</code> of <strong>10 minutes</strong> which can be changed in your <code>AppHost</code> with:</p><div class="language-csharp"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetPlugin</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HttpCacheFeature<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DefaultMaxAge <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>So the HTTP Response Headers the client receives when calling this Service for the first time is something similar to:</p><pre><code>ETag: &quot;42&quot;
Cache-Control: max-age=600
</code></pre><p>Which tells the client that they can use their local cache for identical requests issued within the next 10 minutes. After 10 minutes the cache is considered stale and the client will issue a new request to the server but this time it will include the <strong>ETag</strong> it has associated with the Response, i.e:</p><pre><code>If-None-Match: &quot;42&quot;
</code></pre><p>When this happens the Service is still executed as normal and if the Customer hasn&#39;t changed, the <code>HttpCacheFeature</code> will compare the <code>HttpResult.ETag</code> response with the clients <strong>ETag</strong> above and if they match ServiceStack will instead return a <strong>304 NotModified</strong> with an Empty Response Body to indicate to the client that it can continue to use their locally cached response.</p><p>So whilst using a <code>HttpResult</code> <strong>doesn&#39;t cache</strong> the response <strong>on the Server</strong> and save further resources used in executing the Service, it still benefits from allowing the client to use their local cache for <strong>10 minutes</strong> - eliminating server requests and yielding instant response times. Then after <strong>10 minutes</strong> the <strong>304 NotModified</strong> Response Status and <strong>Empty Body</strong> improves latency and saves the Server CPU and bandwidth resources it didn&#39;t have to use for serializing and writing the executed Services response it would have need to do if no Caching was enabled.</p><h4 id="using-lastmodified" tabindex="-1">Using LastModified <a class="header-anchor" href="#using-lastmodified" aria-hidden="true">#</a></h4><p>The alternative to using an <code>ETag</code> is to use the <code>Last-Modified</code> Caching Validator. When you&#39;re constructing a complex response you&#39;ll want to use the <strong>most recent</strong> Last Modified Date from all sources so that you can determine that the cache is no longer valid when any of the sources have been updated.</p><p>If you also want to customize the clients <strong>Cache-Control</strong> behavior you can use the additional <code>HttpResult</code> properties, below is an example of doing both:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomerOrders</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomerOrdersResponse</span> <span class="token punctuation">{</span>
        Customer <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Orders <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CustomerId <span class="token operator">==</span> request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> allDates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>DateTime<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ModifiedDate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span>Customer<span class="token punctuation">.</span>ModifiedDate<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpResult</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        LastModified <span class="token operator">=</span> allDates<span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        MaxAge <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        CacheControl <span class="token operator">=</span> CacheControl<span class="token punctuation">.</span>Public <span class="token operator">|</span> CacheControl<span class="token punctuation">.</span>MustRevalidate<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Which returns the Last Modified Date of the <code>Customer</code> record or any of their <code>Orders</code> as well as the customized <strong>Cache-Control</strong> Header which together returns Response Headers similar to:</p><pre><code>Last-Modified: Fri, 19 April 2016 05:00:00 GMT
Cache-Control: max-age=60, public, must-revalidate
</code></pre><p>Then after <strong>60 seconds</strong> have elapsed the client will re-issue a request but instead of sending a <code>If-None-Match</code> Request Header and <strong>ETag</strong>, instead sends <code>If-Modified-Since</code> and the <strong>Last-Modified</strong> date:</p><pre><code>If-Modified-Since: Fri, 19 April 2016 05:00:00 GMT
</code></pre><p>The resulting behavior is identical to that of the <strong>ETag</strong> above but instead compares the LastModified dates instead of ETag strings for validity.</p><h3 id="short-circuiting-http-cache-validation" tabindex="-1">Short-circuiting HTTP Cache Validation <a class="header-anchor" href="#short-circuiting-http-cache-validation" aria-hidden="true">#</a></h3><p>A further optimization that can be added to the HTTP Cache workflow is using <code>IRequest.HasValidCache()</code> to short-circuit the execution of a Service after you&#39;ve processed enough information to determine either the <code>ETag</code> or <code>LastModified</code> for the response.</p><p>For example if you had a Service that transcodes video on-the-fly, you can use <code>Request.HasValidCache()</code> to check whether the client already has the latest version of the video, if it does we can return a <strong>304 NotModified</strong> result directly, short-circuiting the Service and saving any resources in executing the remainder of the implementation, which in this case would <strong>bypass reading and transcoding</strong> the .mp4 video:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetOggVideo</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> mp4Video <span class="token operator">=</span> VirtualFileSources<span class="token punctuation">.</span><span class="token function">GetFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;/videos/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">request<span class="token punctuation">.</span>Id</span><span class="token punctuation">}</span></span><span class="token string">.mp4&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mp4Video <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> HttpError<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Video #</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">request<span class="token punctuation">.</span>Id</span><span class="token punctuation">}</span></span><span class="token string"> does not exist&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Request<span class="token punctuation">.</span><span class="token function">HasValidCache</span><span class="token punctuation">(</span>mp4Video<span class="token punctuation">.</span>LastModified<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResult<span class="token punctuation">.</span><span class="token function">NotModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name"><span class="token keyword">var</span></span> encodedOggBytes <span class="token operator">=</span> <span class="token function">EncodeToOggVideo</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpResult</span><span class="token punctuation">(</span>encodedOggBytes<span class="token punctuation">,</span> <span class="token string">&quot;video/ogg&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        LastModified <span class="token operator">=</span> mp4Video<span class="token punctuation">.</span>LastModified<span class="token punctuation">,</span>
        MaxAge <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="new-cacheresponse-attribute" tabindex="-1">New [CacheResponse] Attribute <a class="header-anchor" href="#new-cacheresponse-attribute" aria-hidden="true">#</a></h3><p>We&#39;ve briefly had a look at the existing <code>ToOptimizedResult*</code> API&#39;s to create <strong>Server Caches</strong> in ServiceStack as well as using a customized <code>HttpResult</code> to take advantage of <strong>HTTP Caching</strong> Client features. To make it even easier to use both, we&#39;ve combined them together in a new declarative <code>[CacheResponse]</code><a href="/filter-attributes.html">Request Filter attribute</a> which as it&#39;s non-invasive and simple to add, we expect it to be the most popular option for adding caching to your Services in future.</p><p>As a normal <a href="/filter-attributes.html">Request Filter Attribute</a> it can be added at the top-level of your Service class in which case it will cache the response of <strong>All</strong> Service implementations for <strong>60 seconds</strong>, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachedServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span> 
<span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomer</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomerOrders</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It can also be applied individually on a single Service implementation:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomer</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Or on Request DTO&#39;s, as we saw earlier on the <code>QueryRockstarAlbums</code> AutoQuery DynamoDB Request DTO:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstarAlbums</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>RockstarAlbum<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre></div><p>However adding Request Filter Attributes <strong>on Request DTO&#39;s</strong> goes against our recommendation for keeping your DTO&#39;s in a separate implementation and dependency-free <strong>ServiceModel.dll</strong> as it would require a dependency on the non-PCL <strong>ServiceStack.dll</strong> which would prohibit being able to reuse your existing DTO .dll in PCL libraries, limiting their potential re-use.</p><p>You can still take advantage of the <code>[CacheResponse]</code> attribute on AutoQuery Services by defining a custom implementation, at which point adding the <code>[CacheResponse]</code> attribute behaves as normal and applies caching to your Service implementations. E.g. you can enable caching for multiple AutoQuery Services with:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCachedAutoQueryServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IAutoQueryData</span> AutoQuery <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">QueryRockstars</span> query<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        AutoQuery<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> AutoQuery<span class="token punctuation">.</span><span class="token function">CreateQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">QueryRockstarAlbums</span> query<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        AutoQuery<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> AutoQuery<span class="token punctuation">.</span><span class="token function">CreateQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="server-cached-and-http-caching-enabled-responses" tabindex="-1">Server Cached and HTTP Caching enabled responses <a class="header-anchor" href="#server-cached-and-http-caching-enabled-responses" aria-hidden="true">#</a></h4><p>When only specifying a <code>Duration=60</code> ServiceStack only <strong>caches the Server Response</strong> so it behaves similar to using the existing <code>ToOptimizedResult()</code> API, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomer</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Request<span class="token punctuation">.</span><span class="token function">ToOptimizedResultUsingCache</span><span class="token punctuation">(</span>Cache<span class="token punctuation">,</span> 
        Request<span class="token punctuation">.</span>RawUrl<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To also enable <strong>HTTP Caching</strong> features you&#39;ll need to opt-in by specifying an additional HTTP Caching directive. E.g. including a <code>MaxAge</code> instructs ServiceStack to apply <strong>HTTP Caching</strong> logic and return the appropriate headers:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> MaxAge<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomer</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where subsequent identical requests from a <strong>cache-aware client</strong> will return their locally cached version within the first <strong>30 seconds</strong>, between <strong>30-60 seconds</strong> the client will re-validate the request with the Server who will return a <strong>304 NotModified</strong> Response with an <strong>Empty Body</strong>, after <strong>60 seconds</strong> the cache expires and the next request will <strong>re-execute the Service</strong> and populate the cache with a new response.</p><h4 id="cacheresponse-properties" tabindex="-1">CacheResponse Properties <a class="header-anchor" href="#cacheresponse-properties" aria-hidden="true">#</a></h4><p>The Caching behavior of the <code>[CacheResponse]</code> attribute can be further customized using any of the additional properties below:</p><div class="language-csharp"><pre><code><span class="token keyword">int</span> Duration              <span class="token comment">// Cache expiry in seconds</span>
<span class="token keyword">int</span> MaxAge                <span class="token comment">// MaxAge in seconds</span>
CacheControl CacheControl <span class="token comment">// Customize Cache-Control HTTP Headers</span>
<span class="token keyword">bool</span> VaryByUser           <span class="token comment">// Vary cache per user</span>
<span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> VaryByRoles      <span class="token comment">// Vary cache for users in these roles</span>
<span class="token keyword">bool</span> LocalCache           <span class="token comment">// Use In Memory HostContext.LocalCache or HostContext.Cache</span>
</code></pre></div><p>Using any of the other HTTP Cache properties will also trigger the HTTP Caching features. When a <code>MaxAge</code> isn&#39;t specified, i.e:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> VaryByUser <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetUserActivity</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre></div><p>ServiceStack falls back to use the <code>HttpCacheFeature.DefaultMaxAge</code> which defaults to <strong>10 minutes</strong>, in addition to the <code>VaryByUser</code> flag will construct a unique cache key for each user and return an additional <code>Vary: Cookie</code> HTTP Response Header.</p><h3 id="advanced-cacheinfo-customization" tabindex="-1">Advanced CacheInfo Customization <a class="header-anchor" href="#advanced-cacheinfo-customization" aria-hidden="true">#</a></h3><p>One limitation of using a .NET Attribute to specify caching behavior is that we&#39;re limited to using .NET constant primitives prohibiting the use of allowing custom lambda&#39;s to capture custom behavior. This is also the reason why we need to use <code>int</code> for <code>Duration</code> and <code>MaxAge</code> instead of a more appropriate <code>TimeSpan</code>.</p><p>But we can still intercept the way the <code>[CacheResponse]</code> attribute works behind-the-scenes and programmatically enhance it with custom logic. <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/CacheResponseAttribute.cs" target="_blank" rel="noopener noreferrer">CacheResponseAttribute</a> is just a wrapper around initializing a populated <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/CacheInfo.cs" target="_blank" rel="noopener noreferrer">CacheInfo</a> POCO that it drops into the <code>IRequest.Items</code> dictionary where it&#39;s visible to your Service and any remaining Filters in ServiceStack&#39;s <a href="/order-of-operations.html">Request Pipeline</a>. Essentially it&#39;s just doing this:</p><div class="language-csharp"><pre><code>req<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Keywords<span class="token punctuation">.</span>CacheInfo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CacheInfo</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The actual validation logic for processing the <code>CacheInfo</code> is encapsulated within the <code>HttpCacheFeature</code> Response Filter. This gives our Service a chance to modify it&#39;s behavior, e.g. in order to generically handle all Service responses the <code>[CacheResponse]</code> attribute uses the <code>IRequest.RawUrl</code> (the URL minus the domain) for the base CacheKey. Whilst using a RawUrl is suitable in uniquely identifying most requests, if QueryString params were sent in a different case or in a different order it would generate a different url and multiple caches for essentially the same request. We can remedy this behavior by changing the base CacheKey used which is just a matter retrieving the populated the <code>CacheInfo</code> and change the <code>KeyBase</code> to use the predictable <a href="/routing.html#reverse-routing">Reverse Routing</a><code>ToGetUrl()</code> API instead, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CacheResponse</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">MyRequest</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> cacheInfo <span class="token operator">=</span> <span class="token punctuation">(</span>CacheInfo<span class="token punctuation">)</span><span class="token keyword">base</span><span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">GetItem</span><span class="token punctuation">(</span>Keywords<span class="token punctuation">.</span>CacheInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cacheInfo<span class="token punctuation">.</span>KeyBase <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">ToGetUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//custom cache key</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Request<span class="token punctuation">.</span><span class="token function">HandleValidCache</span><span class="token punctuation">(</span>cacheInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>HandleValidCache()</code> is used to re-validate the client&#39;s request with the new Cache Key and if it&#39;s determined the Client has a valid cache, will short-circuit the Service and return a <strong>304 NotModified</strong> Response.</p><h2 id="cache-aware-service-clients" tabindex="-1">Cache-Aware Service Clients <a class="header-anchor" href="#cache-aware-service-clients" aria-hidden="true">#</a></h2><p>We&#39;ve now covered most of the <strong>Server Caching</strong> and <strong>HTTP Caching</strong> features in ServiceStack whose usage will automatically benefit Websites as browsers have excellent support for HTTP Caching. But .NET Desktop Apps or Xamarin.iOS and Xamarin.Android mobile clients wont see any of these benefits since none of the existing Service Clients have support for <strong>HTTP Caching</strong>.</p><p>To complete the story we&#39;ve also developed a cache-aware <code>CachedServiceClient</code> that can be used to enhance all existing <code>HttpWebRequest</code> based Service Clients which manages its own local cache as instructed by the HTTP Caching directives, whilst the <code>CachedHttpClient</code> does the same for the HttpClient-based <code>JsonHttpClient</code>.</p><p>Both Cache-Aware clients implement the full <a href="https://github.com/ServiceStack/ServiceStack/blob/master/docs/pages/IServiceClient.md" target="_blank" rel="noopener noreferrer">IServiceClient</a> interface so they should be an easy drop-in enhancement for existing applications:</p><div class="language-csharp"><pre><code><span class="token class-name">IServiceClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//equivalent to:</span>
<span class="token class-name">IServiceClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CachedServiceClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Likewise for <code>JsonHttpClient</code>:</p><div class="language-csharp"><pre><code><span class="token class-name">IServiceClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonHttpClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//equivalent to:</span>
<span class="token class-name">IServiceClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CachedHttpClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonHttpClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As seen above they&#39;re essentially decorators over existing .NET Service Clients where they&#39;ll append the appropriate HTTP Request Headers and inspect the HTTP Responses of <strong>GET</strong> Requests that contain HTTP Caching directives. All other HTTP Methods are just delegated through to the underlying Service Client.</p><p>The Service Clients maintain cached responses in an internal dictionary which can also be injected and shared if your app uses multiple Service Clients. For example they could use the fast binary <a href="/messagepack-format.html">MsgPack client</a> for performance-sensitive queries or Services returning binary data and use a JSON client for everything else:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sharedCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> HttpCacheEntry<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IServiceClient</span> msgPackClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MsgPackServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCache</span><span class="token punctuation">(</span>sharedCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IServiceClient</span> jsonClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonHttpClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCache</span><span class="token punctuation">(</span>sharedCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="improved-performance-and-reliability" tabindex="-1">Improved Performance and Reliability <a class="header-anchor" href="#improved-performance-and-reliability" aria-hidden="true">#</a></h3><p>When caching is enabled on Services, the Cache-aware Service Clients can dramatically improve performance by eliminating server requests entirely as well as reducing bandwidth for re-validated requests. They also offer an additional layer of resiliency as re-validated requests that result in Errors will transparently fallback to using pre-existing locally cached responses. For bandwidth-constrained environments like Mobile Apps they can dramatically improve the User Experience and as they&#39;re available in all supported PCL client platforms - we recommend their use where HTTP Caching is enabled on the Server.</p><h3 id="community-resources-on-caching" tabindex="-1">Community Resources on Caching <a class="header-anchor" href="#community-resources-on-caching" aria-hidden="true">#</a></h3><p>The new Caching support was developed in collaboration with members of the ServiceStack Community particularly <a href="https://twitter.com/JezzSantos" target="_blank" rel="noopener noreferrer">@JezzSantos</a> who was also developing his own ServiceStack Caching Solution in parallel which he recently <a href="http://www.mindkin.co.nz/blog/2016/1/5/caching-anyone" target="_blank" rel="noopener noreferrer">wrote about in comprehensive detail</a> - a must read if you want to learn more about HTTP Caching and explore alternative solutions for maintaining dependent caches within ServiceStack.</p><h2 id="service-gateway" tabindex="-1">Service Gateway <a class="header-anchor" href="#service-gateway" aria-hidden="true">#</a></h2><p>Another valuable capability added in this release that despite being trivial to implement on top of ServiceStack&#39;s existing message-based architecture, opens up exciting new possibilities for development of loosely-coupled <a href="/modularizing-services.html">Modularized Service Architectures</a>.</p><p>The new <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/IServiceGateway.cs" target="_blank" rel="noopener noreferrer">IServiceGateway</a> interfaces represent the minimal surface area required to support ServiceStack&#39;s different calling conventions in a formalized API that supports both Sync and Async Service Integrations:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceGateway</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Normal Request/Reply Services</span>
    <span class="token return-type class-name">TResponse</span> <span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> requestDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Auto Batched Request/Reply Requests</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SendAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> requestDtos<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// OneWay Service</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Publish</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> requestDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Auto Batched OneWay Requests</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PublishAll</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> requestDtos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Equivalent Async API&#39;s</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceGatewayAsync</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SendAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> requestDto<span class="token punctuation">,</span> 
        <span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SendAllAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> requestDtos<span class="token punctuation">,</span> 
        <span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task</span> <span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> requestDto<span class="token punctuation">,</span> 
        <span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task</span> <span class="token function">PublishAllAsync</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> requestDtos<span class="token punctuation">,</span> 
        <span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The minimum set of API&#39;s above requires the least burden for <code>IServiceGateway</code> implementers whilst the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Client/ServiceGatewayExtensions.cs" target="_blank" rel="noopener noreferrer">ServiceGatewayExtensions</a> overlays convenience API&#39;s common to all implementations providing the nicest API&#39;s possible for Request DTO&#39;s implementing the recommended <code>IReturn&lt;T&gt;</code> and <code>IReturnVoid</code> interface markers. The extension methods also provide fallback pseudo-async support for <code>IServiceGateway</code> implementations that also don&#39;t implement the optional <code>IServiceGatewayAsync</code>, but will use native async implementations for those that do.</p><p>Naked Request DTO&#39;s without annotations are sent as a <strong>POST</strong> but alternative Verbs are also supported by annotating Request DTO&#39;s with <a href="/csharp-client.html#http-verb-interface-markers">HTTP Verb Interface Markers</a> where Request DTO&#39;s containing <code>IGet</code>, <code>IPut</code>, etc. are sent using the typed Verb API, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/customers/{Id}&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetCustomer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IGet</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span> <span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> customer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//GET /customers/1</span>
<span class="token comment">//Equivalent to:</span>
<span class="token class-name"><span class="token keyword">var</span></span> customer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><h3 id="service-integration-api-s" tabindex="-1">Service Integration API&#39;s <a class="header-anchor" href="#service-integration-api-s" aria-hidden="true">#</a></h3><p>To execute existing ServiceStack Services internally you can call <code>ExecuteRequest(requestDto)</code> which passes the Request DTO along with the current <code>IRequest</code> into the <code>ServiceController.Execute()</code> to execute. The alternative is to call <code>ResolveService&lt;T&gt;</code> to resolve an autowired instance of the Service that&#39;s injected with the current <code>IRequest</code> context letting you call methods on the Service instance directly. Below is an example of using both API&#39;s:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomerOrders</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> orderService <span class="token operator">=</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ResolveService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomerOrders</span> <span class="token punctuation">{</span>
            Customer <span class="token operator">=</span> <span class="token punctuation">(</span>Customer<span class="token punctuation">)</span><span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">ExecuteRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Orders <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryOrders</span> <span class="token punctuation">{</span> CustomerId <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The recommended approach now is to instead use the <code>IServiceGateway</code> accessible from <code>base.Gateway</code> available in all Service, Razor Views, MVC ServiceStackController classes, etc. It works similar to the <code>ExecuteRequest()</code> API (which it now replaces) where you can invoke a Service with just a populated Request DTO, but instead yields an ideal typed API for Request DTO&#39;s implementing the recommended <code>IReturn&lt;T&gt;</code> or <code>IReturnVoid</code> markers:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomerOrders</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomerOrders</span> <span class="token punctuation">{</span>
        Customer <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Orders <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryOrders</span> <span class="token punctuation">{</span> CustomerId <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Or you can use the Async API if you prefer the non-blocking version:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>GetCustomerOrdersResponse<span class="token punctuation">&gt;</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetCustomerOrders</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomerOrdersResponse</span> <span class="token punctuation">{</span>
        Customer <span class="token operator">=</span> <span class="token keyword">await</span> Gateway<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetCustomer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Orders <span class="token operator">=</span> <span class="token keyword">await</span> Gateway<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryOrders</span> <span class="token punctuation">{</span> CustomerId <span class="token operator">=</span> request<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The capability that sets the ServiceGateway apart (other than offering a nicer API to work with) is that this System could later have its <strong>Customer</strong> and <strong>Order</strong> Subsystems split out into different hosts and this exact Service implementation would continue to function as before, albeit a little slower due to the overhead of any introduced out-of-process communications.</p><p>The default implementation of <code>IServiceGateway</code> uses the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/InProcessServiceGateway.cs" target="_blank" rel="noopener noreferrer">InProcessServiceGateway</a> which delegates the Request DTO to the appropriate <code>ServiceController.Execute()</code> or <code>ServiceController.ExecuteAsync()</code> methods to execute the Service. One noticeable difference is that any Exceptions thrown by downstream Services are automatically converted into the same <code>WebServiceException</code> that clients would throw when calling the Service externally, this is so Exceptions are indistinguishable whether it&#39;s calling an internal Service or an external one, which begins touching on the benefits of the Gateway...</p><p>The ServiceGateway is the same interface whether you&#39;re calling an Internal Service on the Server or a remote Service from a client. It exposes an ideal message-based API that&#39;s <a href="http://www.infoq.com/articles/interview-servicestack" target="_blank" rel="noopener noreferrer">optimal for remote Service Integrations</a> that also supports <a href="/auto-batched-requests.html">Auto Batched Requests</a> for combining multiple Service Calls into a single Request, minimizing latency when possible.</p><h3 id="substitutable-service-gateways" tabindex="-1">Substitutable Service Gateways <a class="header-anchor" href="#substitutable-service-gateways" aria-hidden="true">#</a></h3><p>These characteristics makes it easy to substitute and customize the behavior of the Gateway as visible in the examples below. The easiest scenario to support is to redirect all Service Gateway calls to a remote ServiceStack instance which can be done by registering any .NET Service Client against the <code>IServiceGateway</code> interface, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IServiceGateway<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A more likely scenario you&#39;d want to support is a mix where internal requests are executed in-process and external requests call their respective Service. If your system is split in two this becomes a simple check to return the local InProcess Gateway for Requests which are defined in this ServiceStack instance otherwise return a Service Client configured to the alternative host when not, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomServiceGatewayFactory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ServiceGatewayFactoryBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IServiceGateway</span> <span class="token function">GetGateway</span><span class="token punctuation">(</span><span class="token class-name">Type</span> requestType<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> isLocal <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>Metadata<span class="token punctuation">.</span>RequestTypes<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>requestType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> gateway <span class="token operator">=</span> isLocal
            <span class="token punctuation">?</span> <span class="token punctuation">(</span>IServiceGateway<span class="token punctuation">)</span><span class="token keyword">base</span><span class="token punctuation">.</span>localGateway
            <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonServiceClient</span><span class="token punctuation">(</span>alternativeBaseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> gateway<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For this we needed to implement the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Web/IServiceGatewayFactory.cs" target="_blank" rel="noopener noreferrer">IServiceGatewayFactory</a> so we can first capture the current <code>IRequest</code> that&#39;s needed in order to call the In Process Service Gateway with. The convenience <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/ServiceGatewayFactoryBase.cs" target="_blank" rel="noopener noreferrer">ServiceGatewayFactoryBase</a> abstracts the rest of the API away so you&#39;re only tasked with returning the appropriate Service Gateway for the specified Request DTO.</p><p>Capturing the current <code>IRequest</code> makes the Gateway factory instance non-suitable to use as a singleton, so we&#39;ll need to register it with a <code>ReuseScope.None</code> scope so a new instance is resolved each time:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IServiceGatewayFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CustomServiceGatewayFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ReusedWithin</span><span class="token punctuation">(</span>ReuseScope<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="service-discovery-gateways" tabindex="-1">Service Discovery Gateways <a class="header-anchor" href="#service-discovery-gateways" aria-hidden="true">#</a></h2><p>We&#39;re fortunate to have a vibrant community which quickly saw the value in this new capability where they were quick to jump in and contribute their own well-documented and supported value-added OSS solutions:</p><h3 id="servicestack-discovery-consul" tabindex="-1"><a href="https://github.com/MacLeanElectrical/servicestack-discovery-consul" target="_blank" rel="noopener noreferrer">ServiceStack.Discovery.Consul</a> <a class="header-anchor" href="#servicestack-discovery-consul" aria-hidden="true">#</a></h3><p>The <a href="https://github.com/MacLeanElectrical/servicestack-discovery-consul" target="_blank" rel="noopener noreferrer">ConsulFeature</a> plugin by <a href="https://github.com/wwwlicious" target="_blank" rel="noopener noreferrer">Scott Mackay</a> leverages the hardened distributed Discovery Services and highly available features in <a href="https://www.consul.io/" target="_blank" rel="noopener noreferrer">consul.io</a> to provide automatic registration and de-registration of ServiceStack Services on AppHost <strong>StartUp</strong> and <strong>Dispose</strong> that&#39;s available from:</p><pre><code>PM&gt; Install-Package ServiceStack.Discovery.Consul
</code></pre><p>Without any additional effort beyond registering the <code>ConsulFeature</code> plugin and starting a new ServiceStack Instance it provides an auto-updating, self-maintaining and periodically checked registry of available Services:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SetConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HostConfig</span> <span class="token punctuation">{</span>
        WebHostUrl <span class="token operator">=</span> <span class="token string">&quot;http://api.acme.com:1234&quot;</span><span class="token punctuation">,</span> <span class="token comment">// Externally resolvable BaseUrl</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConsulFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Register the plugin, that&#39;s it!</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/ServiceRegistration.png" alt=""></p><p>Once registered, the Service Gateway works as you&#39;d expect where internal requests are executed in process and external requests queries the Consul registry to discover the appropriate and available Service to call:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">RequestDTO</span> dto<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Gateway will automatically route external requests to correct service</span>
        <span class="token class-name"><span class="token keyword">var</span></span> internalCall <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InternalDTO</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> externalCall <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExternalDTO</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/MacLeanElectrical/servicestack-discovery-consul/master/assets/RequestDTOServiceDiscovery.png" alt="RequestDTO Service Discovery"></p><h3 id="servicestack-discovery-redis" tabindex="-1"><a href="https://github.com/rsafier/ServiceStack.Discovery.Redis" target="_blank" rel="noopener noreferrer">ServiceStack.Discovery.Redis</a> <a class="header-anchor" href="#servicestack-discovery-redis" aria-hidden="true">#</a></h3><p>The <a href="https://github.com/rsafier/ServiceStack.Discovery.Redis" target="_blank" rel="noopener noreferrer">RedisServiceDiscoveryFeature</a> by <a href="https://github.com/rsafier" target="_blank" rel="noopener noreferrer">Richard Safier</a> has similar goals to provide transparent service discovery but only requires access to Redis-backed datastore, but is otherwise just as easy to install:</p><pre><code>PM&gt; Install-Package ServiceStack.Discovery.Redis
</code></pre><p>and Configure:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRedisClientsManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisManagerPool</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token function">SetConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HostConfig</span> <span class="token punctuation">{</span>
        WebHostUrl <span class="token operator">=</span> <span class="token string">&quot;http://api.acme.com:1234&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisServiceDiscoveryFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once registered, calling the same Gateway API&#39;s function the same way with internal requests executed internally and external requests sent to the appropriate available node:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">RequestDTO</span> dto<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> internalCall <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InternalDTO</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> externalCall <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExternalDTO</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> 
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> unknown <span class="token operator">=</span> Gateway<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExternalDTOWithNoActiveNodesOnline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">RedisServiceDiscoveryGatewayException</span> e<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
           <span class="token comment">// If a DTO type is not local or resolvable by Redis discovery process </span>
           <span class="token comment">// a RedisServiceDiscoveryGatewayException will be thrown</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since all Redis Discovery data is stored in a redis instance the state of all available nodes can be viewed with any Redis GUI:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/release-notes/RedisDiscoveryScreenshot.png" alt=""></p><h4 id="servicestack-simplecloudcontrol" tabindex="-1"><a href="https://github.com/rsafier/ServiceStack.SimpleCloudControl" target="_blank" rel="noopener noreferrer">ServiceStack.SimpleCloudControl</a> <a class="header-anchor" href="#servicestack-simplecloudcontrol" aria-hidden="true">#</a></h4><p>In addition to this Redis Discovery Service Richard is also developing a series of ServiceStack plugins that enhances the functionality of ServiceStack.Discovery.Redis and provides cluster awareness to additional aspects of a ServiceStack AppHost&#39;s internal state.</p><h3 id="designing-for-microservices" tabindex="-1">Designing for Microservices <a class="header-anchor" href="#designing-for-microservices" aria-hidden="true">#</a></h3><p>Whether or not Systems <a href="http://blog.cleancoder.com/uncle-bob/2014/09/19/MicroServicesAndJars.html" target="_blank" rel="noopener noreferrer">benefit overall from a fine-grained microservices architecture</a>, enough to justify the additional latency, management and infrastructure overhead it requires, we still see value in the development process of <a href="https://channel9.msdn.com/events/Build/2016/C918" target="_blank" rel="noopener noreferrer">designing for Microservices</a> where decoupling naturally isolated components into loosely-coupled subsystems has software-architecture benefits with overall complexity of an entire system being reduced into smaller, more manageable logical scopes which encapsulates their capabilities <a href="http://stackoverflow.com/a/32940275/85785" target="_blank" rel="noopener noreferrer">behind small, re-usable, well-defined facades</a>.</p><p>The ServiceGateway and its Services Discovery ecosystem together with ServiceStack&#39;s recommended use of impl-free reusable POCO DTO&#39;s and its ability to <a href="/modularizing-services.html">modularize Service implementations across multiple projects</a> naturally promote a microservices-ready architecture where Service interactions are loosely-coupled behind well-defined, reusable, coarse-grained messages. Designing systems in this way later allows the isolated Service Implementation .dll to be extracted from the main System and wrapped into its own AppHost. Together with an agreed Service Discovery solution, allows you to spawn multiple instances of the new Service - letting you scale, deploy and maintain it independently from the rest of the system.</p><h2 id="csv-deserialization-support" tabindex="-1">CSV Deserialization Support <a class="header-anchor" href="#csv-deserialization-support" aria-hidden="true">#</a></h2><p>The introduction of the new AutoQuery Data feature and it&#39;s <code>MemorySource</code> suddenly made full CSV support a lot more appealing which caused CSV Deserialization support to be bumped up high on the priority list where it&#39;s implementation is now complete. This now unlocks the ability to create fully-queryable Services over flat-file .csv&#39;s (or Excel spreadsheets exported to .csv) by just deserializing CSV into a List of POCO&#39;s and registering it with AutoQuery Data:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> pocos <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token string">&quot;path/to/data.csv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//AutoQuery Data Plugin</span>
Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoQueryDataFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDataSource</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">MemorySource</span><span class="token punctuation">(</span>pocos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AutoQuery DTO</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">&quot;/pocos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryPocos</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryData<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="super-csv-format" tabindex="-1">Super CSV Format <a class="header-anchor" href="#super-csv-format" aria-hidden="true">#</a></h3><p>A noteworthy feature that sets ServiceStack&#39;s CSV support apart is that it&#39;s built on the compact and very fast <a href="/jsv-format.html">JSV format</a> which not only can deserialize a tabular flat file of scalar values at high-speed, it also supports deeply nested object graphs which are encoded in JSV and escaped in a CSV field as normal. An example of this can be seen in a HTTP sample log fragment below where the HTTP Request Headers are a serialized from a <code>Dictionary&lt;string,string&gt;</code>:</p><pre><code>Id,HttpMethod,AbsoluteUri,Headers
1,GET,http://localhost:55799,&quot;{Connection:keep-alive,Accept:&quot;&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;&quot;,Accept-Encoding:&quot;&quot;gzip, deflate, sdch&quot;&quot;,Accept-Language:&quot;&quot;en-US,en;q=0.8&quot;&quot;,Host:&quot;&quot;localhost:55799&quot;&quot;,User-Agent:&quot;&quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36&quot;&quot;,Upgrade-Insecure-Requests:1}&quot;
</code></pre><p>Being such a versatile file format opens up a lot of new possibilities, e.g. instead of capturing seed data in code you could maintain them in plain-text .csv files and effortlessly load them on App Startup, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateTableIfNotExists</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Country<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//returns true if Table created</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Country<span class="token punctuation">&gt;</span></span> countries <span class="token operator">=</span> <span class="token string">&quot;~/App_Data/countries.csv&quot;</span><span class="token punctuation">.</span><span class="token function">MapHostAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Country<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        db<span class="token punctuation">.</span><span class="token function">InsertAll</span><span class="token punctuation">(</span>countries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="all-services-now-accept-csv-content-types" tabindex="-1">All Services now accept CSV Content-Types <a class="header-anchor" href="#all-services-now-accept-csv-content-types" aria-hidden="true">#</a></h3><p>Another immediate benefit of CSV Deserialization is that now all Services can now process the CSV Content-Type. Being a tabular data format, CSV shines when it&#39;s processing a list of DTO&#39;s, one way to do that in ServiceStack is to have your Request DTO inherit <code>List&lt;T&gt;</code>:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/pocos&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pocos</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IReturn<span class="token punctuation">&lt;</span>Pocos<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Pocos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">Pocos</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It also behaves the same way as CSV Serialization but in reverse where if your Request DTO is annotated with either <code>[DataContract]</code> or the more explicit <code>[Csv(CsvBehavior.FirstEnumerable)]</code> it will automatically deserialize the CSV into the first <code>IEnumerable</code> property, so these 2 Request DTO&#39;s are equivalent to above:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/pocos&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DataContract</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pocos</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>Pocos<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DataMember</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> Items <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/pocos&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Csv</span><span class="token attribute-arguments"><span class="token punctuation">(</span>CsvBehavior<span class="token punctuation">.</span>FirstEnumerable<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pocos</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>Pocos<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> Items <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In addition to the above flexible options for defining CSV-friendly Services, there&#39;s also a few different options for sending CSV Requests to the above Services. You can use the new CSV <code>PostCsvToUrl()</code> extension methods added to <a href="/http-utils.html">HTTP Utils</a>:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">string</span></span> csvText <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token string">&quot;pocos.csv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Send CSV Text</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token string">&quot;http://example.org/pocos&quot;</span>
    <span class="token punctuation">.</span><span class="token function">PostCsvToUrl</span><span class="token punctuation">(</span>csvText<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">//Send POCO DTO&#39;s</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> dtos <span class="token operator">=</span> csvText<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token string">&quot;http://example.org/pocos&quot;</span>
    <span class="token punctuation">.</span><span class="token function">PostCsvToUrl</span><span class="token punctuation">(</span>dtos<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromCsv</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Poco<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
</code></pre></div><p>Alternatively you can use the <code>CsvServiceClient</code> which has the nice Typed API&#39;s you&#39;d expect from a Service Client:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CsvServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Pocos</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Pocos</span><span class="token punctuation">(</span>dtos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ideal-for-auto-batched-requests" tabindex="-1">Ideal for Auto Batched Requests <a class="header-anchor" href="#ideal-for-auto-batched-requests" aria-hidden="true">#</a></h3><p>The <code>CsvServiceClient</code> by virtue of being configured to use a well-defined Tabular data format is perfect for sending <a href="/auto-batched-requests.html">Auto-Batched Requests</a> which by definition send a batch of POCO&#39;s making the CSV format the most compact text format to send them with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> requests <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Request</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Request</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Request</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> responses <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">SendAll</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="csv-request-logger" tabindex="-1">CSV Request Logger <a class="header-anchor" href="#csv-request-logger" aria-hidden="true">#</a></h3><p>Flipping the switch on CSV Deserialization has opened up the potential for a lot more useful features. One of the areas we thought to be particularly valuable is being able to store daily Request Logs in a plain-text structured format, that way they could be immediately inspectable with a text editor or for even better inspection, opened in a spreadsheet and benefit from its filterable, movable, resizable and sortable columns.</p><p>To enable CSV Request Logging you just need to register the <code>RequestLogsFeature</code> and configure it to use the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/CsvRequestLogger.cs" target="_blank" rel="noopener noreferrer">CsvRequestLogger</a>:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RequestLogsFeature</span> <span class="token punctuation">{</span>
    RequestLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CsvRequestLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This will register the CSV Request logger with the following overridable defaults:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RequestLogsFeature</span> <span class="token punctuation">{</span>
    RequestLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CsvRequestLogger</span><span class="token punctuation">(</span>
        files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileSystemVirtualPathProvider</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Config<span class="token punctuation">.</span>WebHostPhysicalPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestLogsPattern <span class="token operator">=</span> <span class="token string">&quot;requestlogs/{year}-{month}/{year}-{month}-{day}.csv&quot;</span><span class="token punctuation">,</span>
        errorLogsPattern <span class="token operator">=</span> <span class="token string">&quot;requestlogs/{year}-{month}/{year}-{month}-{day}-errors.csv&quot;</span>
        appendEvery <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where Request Logs are flushed every <strong>1 second</strong> using a background Timer to a daily log maintained in the logical date format structure above. As it would be useful to be able to inspect any errors in isolation, errors are also written to a separate <code>YYYY-MM-DD-errors.csv</code> format, in addition to the main Request logs.</p><h2 id="virtual-filesystem" tabindex="-1"><a href="/virtual-file-system.html">Virtual FileSystem</a> <a class="header-anchor" href="#virtual-filesystem" aria-hidden="true">#</a></h2><p>To efficiently support Appending to existing files as needed by the <code>CsvRequestLogger</code> we&#39;ve added new <code>AppendFile</code> API&#39;s and implementations for Memory and FileSystem Virtual File Providers:</p><div class="language-csharp"><pre><code><span class="token keyword">interface</span> <span class="token class-name">IVirtualFiles</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> textContents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AppendFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">,</span> <span class="token class-name">Stream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ormlite" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack.OrmLite" target="_blank" rel="noopener noreferrer">OrmLite</a> <a class="header-anchor" href="#ormlite" aria-hidden="true">#</a></h2><h3 id="updating-existing-values" tabindex="-1">Updating existing values <a class="header-anchor" href="#updating-existing-values" aria-hidden="true">#</a></h3><p>The new <code>UpdateAdd</code> API&#39;s contributed by <a href="https://github.com/madaleno" target="_blank" rel="noopener noreferrer">Luis Madaleno</a> provides several Typed API&#39;s for updating existing values:</p><div class="language-csharp"><pre><code><span class="token comment">//Increase everyone&#39;s Score by 3 points</span>
db<span class="token punctuation">.</span><span class="token function">UpdateAdd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span> <span class="token punctuation">{</span> Score <span class="token operator">=</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">fields</span><span class="token punctuation">:</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Score<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//Remove 5 points from Jackson Score</span>
db<span class="token punctuation">.</span><span class="token function">UpdateAdd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span> <span class="token punctuation">{</span> Score <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Score<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> <span class="token keyword">where</span><span class="token punctuation">:</span> x<span class="token punctuation">.</span>LastName <span class="token operator">==</span> <span class="token string">&quot;Jackson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Graduate everyone and increase everyone&#39;s Score by 2 points </span>
<span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>Points<span class="token punctuation">,</span> x<span class="token punctuation">.</span>Graduated <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">UpdateAdd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span> <span class="token punctuation">{</span> Points <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> Graduated <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Add 10 points to Michael&#39;s score</span>
<span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>FirstName <span class="token operator">==</span> <span class="token string">&quot;Michael&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Points<span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">UpdateAdd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span> <span class="token punctuation">{</span> Points <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>Note: Any non-numeric values in an <code>UpdateAdd</code> statement (e.g. strings) are replaced as normal.</p></blockquote><h3 id="belongsto-attribute" tabindex="-1">BelongsTo Attribute <a class="header-anchor" href="#belongsto-attribute" aria-hidden="true">#</a></h3><p>The <code>[BelongTo]</code> attribute can be used for specifying how Custom POCO results are mapped when the resultset is ambiguous, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> AId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> BId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Combined</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BelongTo</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> BId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>A<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Join</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>B<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">LeftJoin</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>B<span class="token punctuation">,</span>C<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> results <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Combined<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Combined.BId = B.Id</span>
</code></pre></div><h3 id="deprecating-legacy-ormlite-api-s" tabindex="-1">Deprecating Legacy OrmLite API&#39;s <a class="header-anchor" href="#deprecating-legacy-ormlite-api-s" aria-hidden="true">#</a></h3><p>In order to gracefully clean up OrmLite&#39;s API Surface area and separate the modern recommended API&#39;s from the Legacy ones we&#39;ve deprecated the Legacy API&#39;s which we plan to move into a separate <code>ServiceStack.OrmLite.Legacy</code> namespace. Once moved, any use of Legacy API&#39;s will require including the additional namespace below:</p><div class="language-"><pre><code>using ServiceStack.OrmLite.Legacy;
</code></pre></div><p>The API&#39;s that have been deprecated are those with <code>*Fmt</code> suffix using in-line escaped string and the old-style C# <code>string.Format()</code> syntax for familiarity, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectFmt</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;Artist = {0} AND Album = {1}&quot;</span><span class="token punctuation">,</span> 
  <span class="token string">&quot;Nirvana&quot;</span><span class="token punctuation">,</span> 
  <span class="token string">&quot;Nevermind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Instead we recommend the use of Typed APIs:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Artist <span class="token operator">==</span> <span class="token string">&quot;Nirvana&quot;</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Album <span class="token operator">==</span> <span class="token string">&quot;Nevermind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Or when needed, Custom SQL API&#39;s that use <code>@parameter</code> names initialized with anonymous objects:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;Artist = @artist AND Album = @album&quot;</span><span class="token punctuation">,</span> 
    <span class="token keyword">new</span> <span class="token punctuation">{</span> artist <span class="token operator">=</span> <span class="token string">&quot;Nirvana&quot;</span><span class="token punctuation">,</span> album <span class="token operator">=</span> <span class="token string">&quot;Nevermind&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SqlList</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token string">&quot;SELECT * FROM Track WHERE Artist = @artist AND Album = @album&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token punctuation">{</span> artist <span class="token operator">=</span> <span class="token string">&quot;Nirvana&quot;</span><span class="token punctuation">,</span> album <span class="token operator">=</span> <span class="token string">&quot;Nevermind&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As they both execute parameterized statements behind-the-scenes.</p><p>The other set of API&#39;s that have been tagged to move out of the primary <code>ServiceStack.OrmLite</code> and reduce ambiguity of the existing API surface area are those that inject an <code>SqlExpression&lt;T&gt;</code>, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>q <span class="token operator">=&gt;</span> 
    q<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Artist <span class="token operator">==</span> <span class="token string">&quot;Nirvana&quot;</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Album <span class="token operator">==</span> <span class="token string">&quot;Nevermind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>These overloaded API&#39;s would often confuse IDE intellisense which were unsure whether to provide intelli-sense for <code>Track</code> or <code>SqlExpression&lt;Track&gt;</code> members. In future only POCO Data Models will be injected so the above API&#39;s should instead be changed to create and pass in an <code>SqlExpression&lt;Track&gt;</code> using <code>db.From&lt;T&gt;</code>, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> tracks <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Track<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Artist <span class="token operator">==</span> <span class="token string">&quot;Nirvana&quot;</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Album <span class="token operator">==</span> <span class="token string">&quot;Nevermind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="pocodynamo" tabindex="-1"><a href="https://github.com/ServiceStack/PocoDynamo" target="_blank" rel="noopener noreferrer">PocoDynamo</a> <a class="header-anchor" href="#pocodynamo" aria-hidden="true">#</a></h2><p>Support for DynamoDB&#39;s <a href="http://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_UpdateItem.html" target="_blank" rel="noopener noreferrer">UpdateItem</a> to modify an existing Item Attribute Value is now available.</p><p>The simplest usage is to pass in a partially populated POCO where any Hash or Range Keys are added to the Key Condition and any non-default values are replaced. E.g the query below updates the Customer&#39;s Age to <strong>42</strong>:</p><div class="language-csharp"><pre><code>db<span class="token punctuation">.</span><span class="token function">UpdateItemNonDefaults</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Customer</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> customer<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Age <span class="token operator">=</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>DynamoDB&#39;s UpdateItem supports 3 different operation types:</p><ul><li><code>PUT</code> to replace an Attribute Value</li><li><code>ADD</code> to add to an existing Attribute Value</li><li><code>DELETE</code> to delete the specified Attributes</li></ul><p>Examples of all 3 are contained in the examples below which changes the Customer&#39;s <code>Nationality</code> to <strong>Australian</strong>, reduces their <code>Age</code> by <strong>1</strong> and deletes their <code>Name</code> and <code>Orders</code>:</p><div class="language-csharp"><pre><code>db<span class="token punctuation">.</span><span class="token function">UpdateItem</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> 
    <span class="token named-parameter punctuation">put</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Customer</span> <span class="token punctuation">{</span>
        Nationality <span class="token operator">=</span> <span class="token string">&quot;Australian&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">add</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Customer</span> <span class="token punctuation">{</span>
        Age <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token named-parameter punctuation">delete</span><span class="token punctuation">:</span> x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> x<span class="token punctuation">.</span>Orders <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The same Typed API above is also available in the more flexible and untyped form below:</p><div class="language-csharp"><pre><code>db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UpdateItem</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Customer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DynamoUpdateItem</span>
<span class="token punctuation">{</span>
    Hash <span class="token operator">=</span> customer<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
    Put <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;Nationality&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Australian&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    Add <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    Delete <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Orders&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="servicestack-redis" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack.Redis" target="_blank" rel="noopener noreferrer">ServiceStack.Redis</a> <a class="header-anchor" href="#servicestack-redis" aria-hidden="true">#</a></h2><p>More robust Exception handling of Sentinel Errors were added and now reconnections that occur in the middle of processing a command are gracefully retried and executed.</p><p>New API&#39;s were added to remove multiple values from a Sorted Set:</p><div class="language-csharp"><pre><code><span class="token keyword">interface</span> <span class="token class-name">IRedisClient</span> <span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">RemoveItemsFromSortedSet</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> setId<span class="token punctuation">,</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">interface</span> <span class="token class-name">IRedisNativeClient</span> <span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">ZRem</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> setId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="servicestackidea" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack.Java" target="_blank" rel="noopener noreferrer">ServiceStackIDEA</a> <a class="header-anchor" href="#servicestackidea" aria-hidden="true">#</a></h2><p>The ServiceStack IDEA Android Studio plugin was updated to support <a href="http://android-developers.blogspot.com/2016/04/android-studio-2-0.html" target="_blank" rel="noopener noreferrer">Android Studio 2.0</a>.</p><h2 id="community" tabindex="-1">Community <a class="header-anchor" href="#community" aria-hidden="true">#</a></h2><h3 id="servicestack-eventstore" tabindex="-1"><a href="https://github.com/MacLeanElectrical/servicestack-eventstore" target="_blank" rel="noopener noreferrer">ServiceStack.EventStore</a> <a class="header-anchor" href="#servicestack-eventstore" aria-hidden="true">#</a></h3><p>The ServiceStack community has been very active in the last month with the developers over at <a href="http://www.maclean-electrical.com/" target="_blank" rel="noopener noreferrer">MacLean Electrical</a> in addition to the Consul Discovery Plugin having also released their <a href="https://github.com/MacLeanElectrical/servicestack-eventstore" target="_blank" rel="noopener noreferrer">CQRS and event-sourced system plugin for ServiceStack</a> using <a href="https://geteventstore.com/" target="_blank" rel="noopener noreferrer">GetEventStore</a>:</p><pre><code>PM&gt; Install-Package ServiceStack.EventStore
</code></pre><h4 id="servicestack-simplecloudcontrol-1" tabindex="-1"><a href="https://github.com/rsafier/ServiceStack.SimpleCloudControl" target="_blank" rel="noopener noreferrer">ServiceStack.SimpleCloudControl</a> <a class="header-anchor" href="#servicestack-simplecloudcontrol-1" aria-hidden="true">#</a></h4><p>Building on capabilities from his <a href="https://github.com/rsafier/ServiceStack.Discovery.Redis" target="_blank" rel="noopener noreferrer">ServiceStack.Discovery.Redis</a> Service <a href="https://github.com/rsafier" target="_blank" rel="noopener noreferrer">Richard Safier</a> is developing a collection of useful plugins which add enhanced introspection of the state, status and health of a cluster of ServiceStack instances. The available plugins in development include:</p><ul><li>SimpleCloudControlFeature</li><li>SimpleMQControlFeature</li><li>SimpleHybridCacheFeature</li><li>SimpleCloudConfig</li><li>SimpleCloudControlAdminFeature</li></ul><h3 id="servicestackwithquartz" tabindex="-1"><a href="https://github.com/CodeRevver/ServiceStackWithQuartz" target="_blank" rel="noopener noreferrer">ServiceStackWithQuartz</a> <a class="header-anchor" href="#servicestackwithquartz" aria-hidden="true">#</a></h3><p><a href="https://github.com/CodeRevver" target="_blank" rel="noopener noreferrer">Michael Clark</a> has created a Plugin that allows an easy registration of all Quartz Jobs within ServiceStack&#39;s Funq container. This allows for dependency injection within any Quartz Job. Get Started with:</p><pre><code>PM&gt; Install-Package ServiceStack.Funq.Quartz
</code></pre><p>Also checkout Michael&#39;s <a href="http://michaelclark.tech/2016/04/16/creating-a-servicestack-windows-service-that-uses-quartz/" target="_blank" rel="noopener noreferrer">Introductory Post</a> for more details.</p><h3 id="caching-anyone" tabindex="-1"><a href="http://www.mindkin.co.nz/blog/2016/1/5/caching-anyone" target="_blank" rel="noopener noreferrer">Caching Anyone?</a> <a class="header-anchor" href="#caching-anyone" aria-hidden="true">#</a></h3><p>If you missed the link to <a href="https://twitter.com/JezzSantos" target="_blank" rel="noopener noreferrer">Jezz Santos</a> comprehensive post on <a href="http://www.mindkin.co.nz/blog/2016/1/5/caching-anyone" target="_blank" rel="noopener noreferrer">HTTP Caching within ServiceStack</a> from earlier, it&#39;s one to checkout when you can set aside time for a long, good read.</p><h2 id="other-features" tabindex="-1">Other Features <a class="header-anchor" href="#other-features" aria-hidden="true">#</a></h2><ul><li>Changed <code>ServiceStack.Interfaces</code> to <strong>Profile 328</strong> adding support <strong>Windows Phone 8.1</strong></li><li>New <code>IHasStatusDescription</code> can be added on <strong>Exceptions</strong> to customize their <code>StatusDescription</code></li><li>New <code>IHasErrorCode</code> can be used to customize the <code>ErrorCode</code> used, instead of its Exception Type</li><li>New <code>AppHost.OnLogError</code> can be used to override and suppress service error logging</li></ul><h1 id="v4-0-54-release-notes" tabindex="-1"><a href="/releases/v4.0.54.html">v4.0.54 Release Notes</a> <a class="header-anchor" href="#v4-0-54-release-notes" aria-hidden="true">#</a></h1>`,364),p=[o];function c(l,u,i,r,k,d){return a(),s("div",null,p)}var y=n(t,[["render",c]]);export{m as __pageData,y as default};
