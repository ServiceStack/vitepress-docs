import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const h='{"title":"Using ASP.NET Identity Auth in ServiceStack","description":"","frontmatter":{"slug":"authentication-identity-aspnet","title":"Using ASP.NET Identity Auth in ServiceStack"},"headers":[{"level":3,"title":"Mapping Customizations","slug":"mapping-customizations"},{"level":3,"title":"Custom Mappings","slug":"custom-mappings"},{"level":3,"title":"Built-in Identity DB APIs","slug":"built-in-identity-db-apis"},{"level":3,"title":"ASP.NET Core Identity Auth Adapter","slug":"asp-net-core-identity-auth-adapter"},{"level":3,"title":"Propagating Extended User Info","slug":"propagating-extended-user-info"}],"relativePath":"authentication-identity-aspnet.md","lastUpdated":1634495307610}',p={},e=t(`<p><a href="https://github.com/NetCoreTemplates/mvcidentity" target="_blank" rel="noopener noreferrer">mvcidentity</a> is a .NET 5.0 MVC Website integrated with ServiceStack using <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> Identity Auth:</p><p><a href="https://github.com/NetCoreTemplates/mvcidentity" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/csharp-templates/mvcidentity.png" alt=""></a></p><p>Create new <code>mvcidentity</code> project with:</p><div class="language-bash"><pre><code>$ x new mvcidentity ProjectName
</code></pre></div><p><a href="https://github.com/NetCoreTemplates/mvcidentity" target="_blank" rel="noopener noreferrer">mvcidentity</a> is essentially the same App with the same functionality as <a href="https://github.com/NetCoreTemplates/mvcauth" target="_blank" rel="noopener noreferrer">mvcauth</a> but rewritten to use <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> Identity Auth instead of ServiceStack Auth, including the registration options which are handled implemented using MVC Controllers instead of ServiceStack&#39;s built-in Services:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/csharp-templates/mvcidentity-login.png" alt=""></p><p><code>mvcidentity</code> defaults to using EF and SQL Server which we expect to be the most popular configuration:</p><div class="language-csharp"><pre><code>services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
    options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;DefaultConnection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddIdentity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationUser<span class="token punctuation">,</span> IdentityRole<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>User<span class="token punctuation">.</span>AllowedUserNameCharacters <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddEntityFrameworkStores</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddDefaultTokenProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The rest of <a href="https://github.com/NetCoreTemplates/mvcidentity/blob/master/MyApp/Startup.cs" target="_blank" rel="noopener noreferrer">Startup.cs</a> contains the standard setup for configuring <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> Identity Auth with the same Twitter, Facebook, Google and Microsoft OAuth Providers.</p><p>A custom <a href="https://github.com/NetCoreTemplates/mvcidentity/blob/master/MyApp/Models/ApplicationUser.cs" target="_blank" rel="noopener noreferrer">ApplicationUser</a> EF DataModel is used to better prepare for real world usage to show how to propagate custom User metadata<br> down into Authenticated UserSessions. <code>mvcidentity</code> starts with an extended <code>ApplicationUser</code> that captures basic info about the user and capture external references to any 3rd Party OAuth providers that Users have signed in with:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationUser</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IdentityUser</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> FirstName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> LastName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TwitterUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TwitterScreenName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> FacebookUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> GoogleUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> GoogleProfilePageUrl <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> MicrosoftUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProfileUrl <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mapping-customizations" tabindex="-1">Mapping Customizations <a class="header-anchor" href="#mapping-customizations" aria-hidden="true">#</a></h3><p>By default the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/Auth/NetCoreIdentityAuthProvider.cs" target="_blank" rel="noopener noreferrer">NetCoreIdentityAuthProvider.cs</a> uses the <code>MapClaimsToSession</code> dictionary to map well known <code>ClaimTypes</code> Properties to their natural <code>AuthUserSession</code> property:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> MapClaimsToSession <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Email</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Email<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Name</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>UserAuthName<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>GivenName</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Surname</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>StreetAddress</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Locality</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>City<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>StateOrProvince</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>State<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>PostalCode</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>PostalCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Country</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Country<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>OtherPhone</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>PhoneNumber<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>DateOfBirth</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>BirthDateRaw<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Gender</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Gender<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Dns</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Dns<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Rsa</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Rsa<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Sid</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Sid<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Hash</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>HomePhone</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>HomePhone<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>MobilePhone</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>MobilePhone<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ClaimTypes<span class="token punctuation">.</span>Webpage</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>AuthUserSession<span class="token punctuation">.</span>Webpage<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Which you can also extend or modify to handle any additional straightforward <strong>1:1 mappings</strong>.</p><h3 id="custom-mappings" tabindex="-1">Custom Mappings <a class="header-anchor" href="#custom-mappings" aria-hidden="true">#</a></h3><p>Alternatively you can use <code>PopulateSessionFilter</code> to apply additional logic when creating a <code>UserSession</code> from a <code>ClaimsPrincipal</code> which is what&#39;s needed to copy over <strong>EF Identity Roles</strong> when using EF Identity Auth with ServiceStack.</p><p>As <code>mvcidentity</code> doesn&#39;t have a dependency on OrmLite you could choose to populate roles using EF&#39;s APIs directly:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetCoreIdentityAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    PopulateSessionFilter <span class="token operator">=</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> principal<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> userManager <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserManager<span class="token punctuation">&lt;</span>ApplicationUser<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> userManager<span class="token punctuation">.</span><span class="token function">FindByIdAsync</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> roles <span class="token operator">=</span> userManager<span class="token punctuation">.</span><span class="token function">GetRolesAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Whilst this works it uses &quot;sync over async&quot; which is <a href="https://github.com/davidfowl/AspNetCoreDiagnosticScenarios/blob/master/AsyncGuidance.md" target="_blank" rel="noopener noreferrer">discouraged and problematic in many use-cases</a>, less efficient than just sync and UserManager&#39;s limited API available forces multiple DB calls and more data over the wire than just the role names needed.</p><h3 id="built-in-identity-db-apis" tabindex="-1">Built-in Identity DB APIs <a class="header-anchor" href="#built-in-identity-db-apis" aria-hidden="true">#</a></h3><p>Instead we recommend instead using the more optimal <code>IDbConnection.GetIdentityUserRolesById()</code> API which returns just the role names in a single indexed DB query.</p><p>If you&#39;re not using OrmLite you can utilize EF&#39;s configured <strong>DB Connection</strong> by adding this extension method to your host project:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AppExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">DbExec</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceProvider</span> services<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IDbConnection<span class="token punctuation">,</span> T<span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> services
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DbContextExec</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">,</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
            x<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">OpenConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="asp-net-core-identity-auth-adapter" tabindex="-1"><a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> Core Identity Auth Adapter <a class="header-anchor" href="#asp-net-core-identity-auth-adapter" aria-hidden="true">#</a></h3><p>Where you&#39;ll able to use it to perform adhoc DB queries, in this case calling <code>GetIdentityUserRolesById()</code> to populate the Users roles:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetCoreIdentityAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    PopulateSessionFilter <span class="token operator">=</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> principal<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span>Roles <span class="token operator">=</span> ApplicationServices<span class="token punctuation">.</span><span class="token function">DbExec</span><span class="token punctuation">(</span>db <span class="token operator">=&gt;</span> db<span class="token punctuation">.</span><span class="token function">GetIdentityUserRolesById</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This gets called whenever <strong>ServiceStack receives an Authenticated Request</strong> which you can intercept and customize how <code>ClaimsPrincipal</code> are mapped to ServiceStack User Sessions.</p><p>To improve performance and save the DB hit, we recommend caching the User Roles into an In Memory Cache:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetCoreIdentityAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    PopulateSessionFilter <span class="token operator">=</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> principal<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span>Roles <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">GetMemoryCacheClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetOrCreate</span><span class="token punctuation">(</span>
            IdUtils<span class="token punctuation">.</span><span class="token function">CreateUrn</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ApplicationServices<span class="token punctuation">.</span><span class="token function">DbExec</span><span class="token punctuation">(</span>db <span class="token operator">=&gt;</span> db<span class="token punctuation">.</span><span class="token function">GetIdentityUserRolesById</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Alternatively use <code>req.GetCacheClient()</code> if you want to use your registered <code>ICacheClient</code> provider instead</p></div><h3 id="propagating-extended-user-info" tabindex="-1">Propagating Extended User Info <a class="header-anchor" href="#propagating-extended-user-info" aria-hidden="true">#</a></h3><p>In addition to populating the Users Roles we also want to populate our custom User metadata on our <code>ApplicationUser</code> EF model, for this we can use the new <code>GetIdentityUserById&lt;T&gt;</code> API which we&#39;ll also want to cache.</p><p>This brings us to the end result in <a href="https://github.com/NetCoreTemplates/mvcidentity" target="_blank" rel="noopener noreferrer">mvcidentity</a> project template:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthFeature</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CustomUserSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IAuthProvider<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetCoreIdentityAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span> <span class="token comment">// Adapter to enable ASP.NET Identity Auth in ServiceStack</span>
        <span class="token punctuation">{</span>
            AdminRoles <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;Manager&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// Automatically Assign additional roles to Admin Users</span>
            PopulateSessionFilter <span class="token operator">=</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> principal<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//Example of populating ServiceStack Session Roles + Custom Info from EF Identity DB</span>
                <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">GetMemoryCacheClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetOrCreate</span><span class="token punctuation">(</span>
                    IdUtils<span class="token punctuation">.</span><span class="token function">CreateUrn</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>ApplicationUser<span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//return cached results before refreshing cache from db /5mins</span>
                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ApplicationServices<span class="token punctuation">.</span><span class="token function">DbExec</span><span class="token punctuation">(</span>db<span class="token operator">=&gt;</span>db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetIdentityUserById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationUser<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                session<span class="token punctuation">.</span>Email <span class="token operator">=</span> session<span class="token punctuation">.</span>Email <span class="token operator">??</span> user<span class="token punctuation">.</span>Email<span class="token punctuation">;</span>
                session<span class="token punctuation">.</span>FirstName <span class="token operator">=</span> session<span class="token punctuation">.</span>FirstName <span class="token operator">??</span> user<span class="token punctuation">.</span>FirstName<span class="token punctuation">;</span>
                session<span class="token punctuation">.</span>LastName <span class="token operator">=</span> session<span class="token punctuation">.</span>LastName <span class="token operator">??</span> user<span class="token punctuation">.</span>LastName<span class="token punctuation">;</span>
                session<span class="token punctuation">.</span>DisplayName <span class="token operator">=</span> session<span class="token punctuation">.</span>DisplayName <span class="token operator">??</span> user<span class="token punctuation">.</span>DisplayName<span class="token punctuation">;</span>
                session<span class="token punctuation">.</span>ProfileUrl <span class="token operator">=</span> user<span class="token punctuation">.</span>ProfileUrl <span class="token operator">??</span> AuthMetadataProvider<span class="token punctuation">.</span>DefaultNoProfileImgUrl<span class="token punctuation">;</span>

                session<span class="token punctuation">.</span>Roles <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">GetMemoryCacheClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetOrCreate</span><span class="token punctuation">(</span>
                    IdUtils<span class="token punctuation">.</span><span class="token function">CreateUrn</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//return cached results before refreshing cache from db /5mins</span>
                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ApplicationServices<span class="token punctuation">.</span><span class="token function">DbExec</span><span class="token punctuation">(</span>db <span class="token operator">=&gt;</span> db<span class="token punctuation">.</span><span class="token function">GetIdentityUserRolesById</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>`,35),o=[e];function c(u,i,l,r,k,d){return a(),s("div",null,o)}var y=n(p,[["render",c]]);export{h as __pageData,y as default};
