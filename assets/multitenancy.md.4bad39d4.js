import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const g='{"title":"Multitenancy","description":"","frontmatter":{"slug":"multitenancy","title":"Multitenancy"},"headers":[{"level":3,"title":"Change Database Connection at Runtime","slug":"change-database-connection-at-runtime"},{"level":3,"title":"ConnectionInfo Attribute","slug":"connectioninfo-attribute"},{"level":3,"title":"Auto Query Named Connection","slug":"auto-query-named-connection"},{"level":3,"title":"Resolving Named Connections in Services","slug":"resolving-named-connections-in-services"},{"level":3,"title":"Override Connection used per request at Runtime","slug":"override-connection-used-per-request-at-runtime"},{"level":2,"title":"Multitenancy RDBMS AuthProvider","slug":"multitenancy-rdbms-authprovider"},{"level":3,"title":"Multi Tenancy Example","slug":"multi-tenancy-example"}],"relativePath":"multitenancy.md","lastUpdated":1634495308422}',p={},e=t(`<p>ServiceStack provides a number of ways of changing the database connection used at runtime based on an incoming Request. You can use a <a href="/request-and-response-filters.html#global-request-filters">Request Filter</a>, use the <code>[ConnectionInfo]</code> <a href="/filter-attributes.html#request-filter-attributes">Request Filter Attribute</a>, use the <code>[NamedConnection]</code> attribute on <a href="/autoquery.html">Auto Query</a> Services, access named connections in Custom Service implementations or override <code>GetDbConnection(IRequest)</code> in your AppHost.</p><h3 id="change-database-connection-at-runtime" tabindex="-1">Change Database Connection at Runtime <a class="header-anchor" href="#change-database-connection-at-runtime" aria-hidden="true">#</a></h3><p>The default implementation of <code>IAppHost.GetDbConnection(IRequest)</code> includes an easy way to change the DB Connection that can be done by populating the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Common/ConnectionInfo.cs" target="_blank" rel="noopener noreferrer">ConnectionInfo</a> POCO in any <a href="/order-of-operations.html">Request Filter in the Request Pipeline</a>:</p><div class="language-csharp"><pre><code>req<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Keywords<span class="token punctuation">.</span>DbInfo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionInfo</span> <span class="token punctuation">{</span>
    NamedConnection  <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token comment">//Use a registered NamedConnection for this Request</span>
    ConnectionString <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token comment">//Use a different DB connection for this Request</span>
    ProviderName     <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token comment">//Use a different Dialect Provider for this Request</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>To illustrate how this works we&#39;ll go through a simple example showing how to create an AutoQuery Service that lets the user change which DB the Query is run on. We&#39;ll control which of the Services we want to allow the user to change the DB it&#39;s run on by having them implement the interface below:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IChangeDb</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> NamedConnection <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> ProviderName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We&#39;ll create one such AutoQuery Service, implementing the above interface:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/rockstars&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryRockstars</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryBase<span class="token punctuation">&lt;</span>Rockstar<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IChangeDb</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> NamedConnection <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ProviderName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For this example we&#39;ll configure our Database to use a default <strong>SQL Server 2012</strong> database, register an optional named connection looking at a &quot;Reporting&quot; <strong>PostgreSQL</strong> database and register an alternative <strong>Sqlite</strong> RDBMS Dialect that we also want the user to be able to use:</p><h4 id="changedb-apphost-registration" tabindex="-1">ChangeDB AppHost Registration <a class="header-anchor" href="#changedb-apphost-registration" aria-hidden="true">#</a></h4><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> 
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteConnectionFactory</span><span class="token punctuation">(</span>defaultDbConn<span class="token punctuation">,</span> SqlServer2012Dialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> dbFactory <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">OrmLiteConnectionFactory</span><span class="token punctuation">;</span>

<span class="token comment">//Register NamedConnection</span>
dbFactory<span class="token punctuation">.</span><span class="token function">RegisterConnection</span><span class="token punctuation">(</span><span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">,</span> ReportConnString<span class="token punctuation">,</span> PostgreSqlDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Register DialectProvider</span>
dbFactory<span class="token punctuation">.</span><span class="token function">RegisterDialectProvider</span><span class="token punctuation">(</span><span class="token string">&quot;Sqlite&quot;</span><span class="token punctuation">,</span> SqliteDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="changedb-request-filter" tabindex="-1">ChangeDB Request Filter <a class="header-anchor" href="#changedb-request-filter" aria-hidden="true">#</a></h4><p>To enable this feature we just need to add a Request Filter that populates the <code>ConnectionInfo</code> with properties from the Request DTO:</p><div class="language-csharp"><pre><code>GlobalRequestFilters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dto<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token class-name"><span class="token keyword">var</span></span> changeDb <span class="token operator">=</span> dto <span class="token keyword">as</span> <span class="token class-name">IChangeDb</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>changeDb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

   req<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Keywords<span class="token punctuation">.</span>DbInfo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionInfo</span> <span class="token punctuation">{</span>
       NamedConnection <span class="token operator">=</span> changeDb<span class="token punctuation">.</span>NamedConnection<span class="token punctuation">,</span>
       ConnectionString <span class="token operator">=</span> changeDb<span class="token punctuation">.</span>ConnectionString<span class="token punctuation">,</span>
       ProviderName <span class="token operator">=</span> changeDb<span class="token punctuation">.</span>ProviderName<span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Since our <code>IChangeDb</code> interface shares the same property names as <code>ConnectionInfo</code>, the above code can be further condensed using a <a href="/request-and-response-filters.html#typed-request-filters">Typed Request Filter</a> and ServiceStack&#39;s built-in <a href="/auto-mapping.html">AutoMapping</a> down to just:</p><div class="language-csharp"><pre><code><span class="token generic-method"><span class="token function">RegisterTypedRequestFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IChangeDb<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dto<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    req<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Keywords<span class="token punctuation">.</span>DbInfo<span class="token punctuation">]</span> <span class="token operator">=</span> dto<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertTo</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ConnectionInfo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="change-databases-via-querystring" tabindex="-1">Change Databases via QueryString <a class="header-anchor" href="#change-databases-via-querystring" aria-hidden="true">#</a></h4><p>With the above configuration the user can now change which database they want to execute the query on, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//SQL Server</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstars</span> <span class="token punctuation">{</span>   <span class="token comment">//Reporting PostgreSQL DB</span>
    NamedConnection <span class="token operator">=</span> <span class="token string">&quot;Reporting&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstars</span> <span class="token punctuation">{</span>   <span class="token comment">//Alternative SQL Server Database</span>
    ConnectionString <span class="token operator">=</span> <span class="token string">&quot;Server=alt-host;Database=Rockstars;User Id=test;Password=test;&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QueryRockstars</span> <span class="token punctuation">{</span>   <span class="token comment">//Alternative SQLite Database</span>
    ConnectionString <span class="token operator">=</span> <span class="token string">&quot;C:\\backups\\2016-01-01.sqlite&quot;</span><span class="token punctuation">,</span>
    ProviderName <span class="token operator">=</span> <span class="token string">&quot;Sqlite&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="connectioninfo-attribute" tabindex="-1">ConnectionInfo Attribute <a class="header-anchor" href="#connectioninfo-attribute" aria-hidden="true">#</a></h3><p>To make it even easier to use we&#39;ve also wrapped this feature in a simple <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/ConnectionInfoAttribute.cs" target="_blank" rel="noopener noreferrer">ConnectionInfoAttribute.cs</a> which allows you to declaratively specify which database a Service should be configured to use, e.g we can configure the <code>Db</code> connection in the Service below to use the PostgreSQL <strong>Reporting</strong> database with:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ConnectionInfo</span><span class="token attribute-arguments"><span class="token punctuation">(</span>NamedConnection <span class="token operator">=</span> <span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReportingServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">Sales</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SalesResponse</span> <span class="token punctuation">{</span> Results <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Sales<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="auto-query-named-connection" tabindex="-1">Auto Query Named Connection <a class="header-anchor" href="#auto-query-named-connection" aria-hidden="true">#</a></h3><p><a href="/autoquery.html">Auto Query</a> can also easily be configured to query any number of <a href="/autoquery-rdbms.html#named-connection">different databases registered in your AppHost</a>.</p><p>In the example below we configure our main RDBMS to use SQL Server and register a <strong>Named Connection</strong> to point to a <strong>Reporting</strong> PostgreSQL RDBMS:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> dbFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteConnectionFactory</span><span class="token punctuation">(</span>connString<span class="token punctuation">,</span> SqlServer2012Dialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>dbFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

dbFactory<span class="token punctuation">.</span><span class="token function">RegisterConnection</span><span class="token punctuation">(</span><span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">,</span> pgConnString<span class="token punctuation">,</span> PostgreSqlDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Any normal AutoQuery Services like <code>QueryOrders</code> will use the default SQL Server connection whilst <code>QuerySales</code> will execute its query on the PostgreSQL <code>Reporting</code> Database instead:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryOrders</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ConnectionInfo</span><span class="token attribute-arguments"><span class="token punctuation">(</span>NamedConnection <span class="token operator">=</span> <span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuerySales</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>Sales<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>An alternative to specifying the <code>[ConnectionInfo]</code> Request Filter Attribute on the AutoQuery Request DTO, is to specify the named connection on the <strong>POCO Table</strong> instead, e.g:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NamedConnection</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sales</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuerySales</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">QueryDb<span class="token punctuation">&lt;</span>Sales<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>Which can also be added on the Request DTO itself:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NamedConnection</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewSales</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>ViewSalesResponse<span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="resolving-named-connections-in-services" tabindex="-1">Resolving Named Connections in Services <a class="header-anchor" href="#resolving-named-connections-in-services" aria-hidden="true">#</a></h3><p>Whilst inside a Service you can change which DB connection to use by passing in the NamedConnection when opening a DB Connection. E.g. The example below allows the user to change which database to retrieve all sales records for otherwise fallbacks to &quot;Reporting&quot; database by default:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SalesServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token return-type class-name">IDbConnectionFactory</span> ConnectionFactory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

   <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetAllSales</span> request<span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
       <span class="token class-name"><span class="token keyword">var</span></span> namedConnection <span class="token operator">=</span> request<span class="token punctuation">.</span>NamedConnection <span class="token operator">??</span> <span class="token string">&quot;Reporting&quot;</span><span class="token punctuation">;</span>
       <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> ConnectionFactory<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>namedConnection<span class="token punctuation">)</span><span class="token punctuation">)</span> 
       <span class="token punctuation">{</span>
           <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Sales<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="override-connection-used-per-request-at-runtime" tabindex="-1">Override Connection used per request at Runtime <a class="header-anchor" href="#override-connection-used-per-request-at-runtime" aria-hidden="true">#</a></h3><p>All built-in dependencies available from <code>Service</code> base class, AutoQuery, Razor View pages, etc are resolved from a central overridable location in your <code>AppHost</code>. This lets you control which pre-configured dependency gets used based on the incoming Request for each Service by overriding any of the <code>AppHost</code> methods below:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IDbConnection</span> Db
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> db <span class="token operator">??</span> <span class="token punctuation">(</span>db <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>AppHost<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ICacheClient</span> Cache
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> cache <span class="token operator">??</span> <span class="token punctuation">(</span>cache <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>AppHost<span class="token punctuation">.</span><span class="token function">GetCacheClient</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">MemoryCacheClient</span> LocalCache
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> localCache <span class="token operator">??</span> 
              <span class="token punctuation">(</span>localCache <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>AppHost<span class="token punctuation">.</span><span class="token function">GetMemoryCacheClient</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IRedisClient</span> Redis
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> redis <span class="token operator">??</span> <span class="token punctuation">(</span>redis <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>AppHost<span class="token punctuation">.</span><span class="token function">GetRedisClient</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IMessageProducer</span> MessageProducer
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> messageProducer <span class="token operator">??</span> 
              <span class="token punctuation">(</span>messageProducer <span class="token operator">=</span> HostContext<span class="token punctuation">.</span>AppHost<span class="token punctuation">.</span><span class="token function">GetMessageProducer</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>E.g. to change the DB Connection your Service uses you can override <code>GetDbConnection(IRequest)</code> in your <code>AppHost</code>.</p><h2 id="multitenancy-rdbms-authprovider" tabindex="-1">Multitenancy RDBMS AuthProvider <a class="header-anchor" href="#multitenancy-rdbms-authprovider" aria-hidden="true">#</a></h2><p>ServiceStack resolves its <code>IAuthProvider</code> from the overridable <code>GetAuthRepository(IRequest)</code> AppHost factory method just like the other &quot;Multitenancy-aware&quot; dependencies above letting you dynamically change which AuthProvider should be used based on the incoming request.</p><p>This can be used with the new <code>OrmLiteAuthRepositoryMultitenancy</code> provider to maintain isolated User Accounts per tenant in all <a href="https://github.com/ServiceStack/ServiceStack.OrmLite#download" target="_blank" rel="noopener noreferrer">major supported RDBMS</a></p><p>Since each tenant database uses their own isolated UserAuth tables we need to provide the list of db connection strings that the OrmLite AuthRepository uses to check and create any missing User Auth tables:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> connectionStrings <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token function">GetConnectionStringForTenant</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteAuthRepositoryMultitenancy</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        connectionStrings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InitSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create any missing UserAuth tables</span>
</code></pre></div><p>However if you&#39;ve already created all UserAuth table schema&#39;s for each tenant or are manually creating them out-of-band you can register it without the list of connection strings:</p><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteAuthRepositoryMultitenancy</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then to specify which AuthRepository should be used for each request we can override <code>GetAuthRepository()</code> in your AppHost and return the <code>OrmLiteAuthRepositoryMultitenancy</code> configured to use the same Multitenant DB connection used in that request, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IAuthRepository</span> <span class="token function">GetAuthRepository</span><span class="token punctuation">(</span><span class="token class-name">IRequest</span> req <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> req <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token punctuation">?</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteAuthRepositoryMultitenancy</span><span class="token punctuation">(</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//At Runtime</span>
        <span class="token punctuation">:</span> <span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//On Startup</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now when <code>GetAuthRepository()</code> is called within the context of a request it uses the same Multitenancy DB as your other services, otherwise when called outside (e.g. on Startup) it uses the default IOC Registration configured with the connectionStrings for each Multitenant DB that it can use to create any missing UserAuth table schemas not found in any of the Multitenant databases.</p><h4 id="extending-userauth-tables" tabindex="-1">Extending UserAuth tables <a class="header-anchor" href="#extending-userauth-tables" aria-hidden="true">#</a></h4><p>In the same way that you can use <a href="/authentication-and-authorization.html#extending-userauth-tables">Custom UserAuth tables in OrmLiteAuthRepository</a>, you can also extend <code>OrmLiteAuthRepositoryMultitenancy</code> to utilize your own custom <code>UserAuth</code> tables with extended fields by configuring them to use its generic class, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserAuth</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">UserAuth</span></span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token range operator">..</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserAuthDetails</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">UserAuthDetails</span></span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token range operator">..</span> <span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteAuthRepositoryMultitenancy<span class="token punctuation">&lt;</span>MyUserAuth<span class="token punctuation">,</span> MyUserAuthDetails<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        UseDistinctRoleTables <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="multi-tenancy-example" tabindex="-1">Multi Tenancy Example <a class="header-anchor" href="#multi-tenancy-example" aria-hidden="true">#</a></h3><p>To show how easy it is to implement a Multi Tenancy Service with this feature we&#39;ve added a stand-alone <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/MultiTenantAppHostTests.cs" target="_blank" rel="noopener noreferrer">Multi Tenancy AppHost Example</a> showing 2 different ways we can configure a Service to use different databases based on an incoming request.</p><p>In this example we&#39;ve configured our AppHost to use the <strong>master.sqlite</strong> database as default and registered 3 different named connections referencing 3 different databases. Each database is then initialized with a different row in the <code>TenantConfig</code> table to identify the database that it&#39;s in.</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiTenantChangeDbAppHost</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AppSelfHostBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MultiTenantChangeDbAppHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token string">&quot;Multi Tenant Test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span><span class="token type-expression class-name">MultiTenantChangeDbAppHost</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteConnectionFactory</span><span class="token punctuation">(</span>
            <span class="token string">&quot;~/App_Data/master.sqlite&quot;</span><span class="token punctuation">.</span><span class="token function">MapAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SqliteDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> dbFactory <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> noOfTenants <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitDb</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;MASTER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Masters inc.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        noOfTenants<span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> tenantId <span class="token operator">=</span> <span class="token string">&quot;T0&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnectionString</span><span class="token punctuation">(</span><span class="token function">GetTenantConnString</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">InitDb</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> tenantId<span class="token punctuation">,</span> <span class="token string">&quot;ACME {0} inc.&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token generic-method"><span class="token function">RegisterTypedRequestFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IForTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>dto<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
            req<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Keywords<span class="token punctuation">.</span>DbInfo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionInfo</span> <span class="token punctuation">{</span> 
                ConnectionString <span class="token operator">=</span> <span class="token function">GetTenantConnString</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span>TenantId<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tenantId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> company<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DropAndCreateTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TenantConfig<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TenantConfig</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> tenantId<span class="token punctuation">,</span> Company <span class="token operator">=</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetTenantConnString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> tenantId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tenantId <span class="token operator">!=</span> <span class="token keyword">null</span> 
        <span class="token punctuation">?</span> <span class="token string">&quot;~/App_Data/tenant-{0}.sqlite&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MapAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This example uses only contains a single Service which returns the first result in the <code>TenantConfig</code> table:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IForTenant</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TenantConfig</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Company <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetTenant</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IForTenant</span><span class="token punctuation">,</span> <span class="token class-name">IReturn<span class="token punctuation">&lt;</span>GetTenantResponse<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetTenantResponse</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TenantConfig</span> Config <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiTenantService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">GetTenant</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenantResponse</span>
        <span class="token punctuation">{</span>
            Config <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TenantConfig<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Calling this Service with a different <code>TenantId</code> value changes which database the Service is configured with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonServiceClient</span><span class="token punctuation">(</span>Config<span class="token punctuation">.</span>AbsoluteBaseUri<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//= Company: Masters inc. </span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenant</span> <span class="token punctuation">{</span> TenantId <span class="token operator">=</span> <span class="token string">&quot;T01&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//= Company: ACME T01 inc.</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenant</span> <span class="token punctuation">{</span> TenantId <span class="token operator">=</span> <span class="token string">&quot;T02&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//= Company: ACME T02 inc.</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenant</span> <span class="token punctuation">{</span> TenantId <span class="token operator">=</span> <span class="token string">&quot;T03&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//= Company: ACME T03 inc.</span>

client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetTenant</span> <span class="token punctuation">{</span> TenantId <span class="token operator">=</span> <span class="token string">&quot;T04&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws WebServiceException</span>
</code></pre></div><p>An alternative way to support Multitenancy using a Custom DB Factory is available in <a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/MultiTennantAppHostTests.cs#L129" target="_blank" rel="noopener noreferrer">MultiTenantAppHostTests.cs</a>.</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiTenantCustomDbFactoryAppHost</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AppSelfHostBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MultiTenantCustomDbFactoryAppHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token string">&quot;Multi Tenant Test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MultiTenantCustomDbFactoryAppHost</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteConnectionFactory</span><span class="token punctuation">(</span>
            <span class="token string">&quot;~/App_Data/master.sqlite&quot;</span><span class="token punctuation">.</span><span class="token function">MapAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SqliteDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> noOfTenants <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

        container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MultiTenantDbFactory</span><span class="token punctuation">(</span>dbFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> multiDbFactory <span class="token operator">=</span> <span class="token punctuation">(</span>MultiTenantDbFactory<span class="token punctuation">)</span>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDbConnectionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> multiDbFactory<span class="token punctuation">.</span><span class="token function">OpenTenant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitDb</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;MASTER&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Masters inc.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        noOfTenants<span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> tenantId <span class="token operator">=</span> <span class="token string">&quot;T0&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> db <span class="token operator">=</span> multiDbFactory<span class="token punctuation">.</span><span class="token function">OpenTenant</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">InitDb</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> tenantId<span class="token punctuation">,</span> <span class="token string">&quot;ACME {0} inc.&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        GlobalRequestFilters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dto<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dto <span class="token keyword">is</span> <span class="token class-name">IForTenant</span> forTenant<span class="token punctuation">)</span>
                RequestContext<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Items<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;TenantId&quot;</span><span class="token punctuation">,</span> forTenant<span class="token punctuation">.</span>TenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tenantId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> company<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DropAndCreateTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TenantConfig<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        db<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TenantConfig</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> tenantId<span class="token punctuation">,</span> Company <span class="token operator">=</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiTenantDbFactory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDbConnectionFactory</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IDbConnectionFactory</span> dbFactory<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">MultiTenantDbFactory</span><span class="token punctuation">(</span><span class="token class-name">IDbConnectionFactory</span> dbFactory<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dbFactory <span class="token operator">=</span> dbFactory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">IDbConnection</span> <span class="token function">OpenDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> tenantId <span class="token operator">=</span> RequestContext<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Items<span class="token punctuation">[</span><span class="token string">&quot;TenantId&quot;</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token class-name"><span class="token keyword">string</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">OpenTenant</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">IDbConnection</span> <span class="token function">OpenTenant</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> tenantId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> tenantId <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token punctuation">?</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnectionString</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;~/App_Data/tenant-{0}.sqlite&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MapAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">:</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">IDbConnection</span> <span class="token function">CreateDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dbFactory<span class="token punctuation">.</span><span class="token function">CreateDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>`,63),o=[e];function c(u,l,i,k,r,d){return a(),s("div",null,o)}var m=n(p,[["render",c]]);export{g as __pageData,m as default};
