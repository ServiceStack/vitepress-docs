import{_ as n,c as s,o as a,a as e}from"./app.14440598.js";const m='{"title":"Server Event Clients","description":"","frontmatter":{"slug":"server-events"},"headers":[{"level":3,"title":"Server Event Clients","slug":"server-event-clients"},{"level":3,"title":"gRPC Server Events Clients","slug":"grpc-server-events-clients"},{"level":3,"title":"Server Event Providers","slug":"server-event-providers"},{"level":2,"title":"Registering","slug":"registering"},{"level":3,"title":"Custom Event Hooks","slug":"custom-event-hooks"},{"level":2,"title":"Sending Server Events","slug":"sending-server-events"},{"level":2,"title":"Event Subscription","slug":"event-subscription"},{"level":3,"title":"Event Subscription Metadata","slug":"event-subscription-metadata"},{"level":2,"title":"Channels","slug":"channels"},{"level":2,"title":"Order of Events","slug":"order-of-events"},{"level":3,"title":"Heartbeats","slug":"heartbeats"},{"level":2,"title":"Chat Features","slug":"chat-features"},{"level":3,"title":"Active Subscribers","slug":"active-subscribers"},{"level":3,"title":"Chat box","slug":"chat-box"},{"level":3,"title":"Specifying a selector","slug":"specifying-a-selector"},{"level":3,"title":"Sending a message to a specific user","slug":"sending-a-message-to-a-specific-user"},{"level":2,"title":"Server Event Services","slug":"server-event-services"},{"level":2,"title":"Updating Channels on Live Subscriptions","slug":"updating-channels-on-live-subscriptions"},{"level":3,"title":"onUpdate Notification","slug":"onupdate-notification"},{"level":3,"title":"ServerEvents Update Channel APIs","slug":"serverevents-update-channel-apis"},{"level":2,"title":"Troubleshooting","slug":"troubleshooting"},{"level":3,"title":"Response Buffering delaying events","slug":"response-buffering-delaying-events"},{"level":2,"title":"ServerEvents Examples","slug":"serverevents-examples"},{"level":3,"title":"Android Java Chat","slug":"android-java-chat"},{"level":3,"title":"Web, Node.js and React Native ServerEvents Apps","slug":"web-node-js-and-react-native-serverevents-apps"},{"level":3,"title":"Gistlyn","slug":"gistlyn"},{"level":3,"title":"React Chat","slug":"react-chat"},{"level":3,"title":"Xamarin.Android Chat","slug":"xamarin-android-chat"},{"level":3,"title":"Networked Time Traveller Shape Creator","slug":"networked-time-traveller-shape-creator"},{"level":3,"title":"Chat","slug":"chat"},{"level":3,"title":"React Chat Desktop","slug":"react-chat-desktop"}],"relativePath":"server-events.md","lastUpdated":1634495308446}',t={},p=e(`__VP_STATIC_START__<p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/server-events/server-events-banner.png" alt=""></p><p><a href="http://www.html5rocks.com/en/tutorials/eventsource/basics/" target="_blank" rel="noopener noreferrer">Server Sent Events</a> (SSE) is an elegant <a href="http://dev.w3.org/html5/eventsource/" target="_blank" rel="noopener noreferrer">web technology</a> for efficiently receiving push notifications from any HTTP Server. It can be thought of as a mix between long polling and one-way WebSockets and contains many benefits over each:</p><ul><li><strong>Simple</strong> - Server Sent Events is just a single long-lived HTTP Request that any HTTP Server can support</li><li><strong>Efficient</strong> - Each client uses a single TCP connection and each message avoids the overhead of HTTP Connections and Headers that&#39;s <a href="http://matthiasnehlsen.com/blog/2013/05/01/server-sent-events-vs-websockets/" target="_blank" rel="noopener noreferrer">often faster than Web Sockets</a>.</li><li><strong>Resilient</strong> - Browsers automatically detect when a connection is broken and automatically reconnects</li><li><strong>Interoperable</strong> - As it&#39;s just plain-old HTTP, it&#39;s introspectable with your favorite HTTP Tools and even works through HTTP proxies (with buffering and <a href="https://www.w3.org/TR/eventsource/#notes" target="_blank" rel="noopener noreferrer">chunked-encoding turned off</a>).</li><li><strong>Well Supported</strong> - As a Web Standard it&#39;s supported in all major browsers except for IE which <a href="http://html5doctor.com/server-sent-events/#yaffle" target="_blank" rel="noopener noreferrer">can be enabled with polyfills</a> - see <a href="https://github.com/ServiceStackApps/Chat/blob/master/src/Chat/default_ieshim.cshtml" target="_blank" rel="noopener noreferrer">default_ieshim.cshtml</a> and its <a href="http://chat.netcore.io/default_ieshim" target="_blank" rel="noopener noreferrer">Live Chat Example</a>.</li></ul><p>We&#39;ve chosen to adopt Server Sent Events for Server Notifications as it&#39;s a beautifully simple and elegant <a href="http://dev.w3.org/html5/eventsource/" target="_blank" rel="noopener noreferrer">Web Standard</a> with better HTTP fidelity than <strong>WebSockets</strong>, that&#39;s perfect fit for Server Push Communications that works in both ServiceStack&#39; <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a>, SelfHosts and .NET Core without requiring any extra .NET dependencies or <a href="http://stackoverflow.com/a/12073593/85785" target="_blank" rel="noopener noreferrer">require the host Windows Server have WebSockets support</a> to use.</p><p>Our integrated and high-performance solution enhances this simple lightweight protocol with rich pub/sub features allowing for <a href="/server-events.html#sending-server-events">flexible and targeted messaging</a> and intelligent clients enabling a variety of different strategies for easily handling events, includes built-in APIs for easily modifying active subscriptions and querying the state of subscribed channels as well as built-in heartbeats and auto-retries for establishing hassle-free persistent connections to backend servers.</p><h3 id="server-event-clients" tabindex="-1">Server Event Clients <a class="header-anchor" href="#server-event-clients" aria-hidden="true">#</a></h3><p>Our native Server Event clients covers the most popular Mobile, Desktop and Server platforms with new first-class implementations for Android, Java and TypeScript which now includes:</p><ul><li><a href="/csharp-server-events-client.html">C# Server Events Client</a><ul><li>Xamarin.iOS</li><li>Xamarin.Android</li><li>UWP</li><li>.NET Framework 4.5+</li><li>.NET Core (.NET Standard 1.3+)</li></ul></li><li><a href="/typescript-server-events-client.html">TypeScript Server Events Client</a><ul><li>Web</li><li>Node.js Server</li><li>React Native <ul><li>iOS</li><li>Android</li></ul></li></ul></li><li><a href="/java-server-events-client.html">Java Server Events Client</a><ul><li>Android</li><li>JVM 1.7+ (Java, Kotlin, Scala, etc) <ul><li>Java Clients</li><li>Java Servers</li></ul></li></ul></li><li><a href="/javascript-server-events-client.html">JavaScript (jQuery plugin)</a><ul><li>Web</li></ul></li></ul><h3 id="grpc-server-events-clients" tabindex="-1">gRPC Server Events Clients <a class="header-anchor" href="#grpc-server-events-clients" aria-hidden="true">#</a></h3><p>In addition to the smart generic HTTP Server Events Clients above, Server Events is also available via a <a href="/server-events-grpc.html">gRPC Server Streaming Endpoint</a> which opens ServiceStack Server Events open to gRPC&#39;s ecosystem of typed generated client proxies, including:</p><ul><li><a href="/grpc-flutter.html">gRPC Flutter</a></li><li><a href="/grpc-android.html">gRPC Android</a></li><li><a href="/grpc-csharp.html">gRPC C#</a></li><li><a href="/grpc-swift.html">gRPC Swift</a></li><li><a href="/grpc-java.html">gRPC Java</a></li><li><a href="/grpc-dart.html">gRPC Dart</a></li><li><a href="/grpc-go.html">gRPC GO</a></li><li><a href="/grpc-nodejs.html">gRPC Node.js</a></li><li><a href="/grpc-python.html">gRPC Python</a></li><li><a href="/grpc-ruby.html">gRPC Ruby</a></li><li><a href="/grpc-php.html">gRPC PHP</a></li></ul><p>Our C#, TypeScript and Java Server Event Clients are ports with full feature parity as C#, offering the same functionality behind idiomatic APIs for their respective programming language. The Integration test suite has also been ported to each platform to assert behavior conformance and provides a good reference showcasing the aesthetics of using Server Events Clients in each language:</p><ul><li><a href="https://github.com/ServiceStack/ServiceStack/blob/master/tests/ServiceStack.WebHost.Endpoints.Tests/ServerEventTests.cs" target="_blank" rel="noopener noreferrer">C# Server Events Integration Tests</a></li><li><a href="https://github.com/ServiceStack/servicestack-client/blob/master/tests/serverevents.spec.ts" target="_blank" rel="noopener noreferrer">TypeScript Server Events Integration Tests</a></li><li><a href="https://github.com/ServiceStack/ServiceStack.Java/blob/master/src/AndroidClient/client/src/test/java/net/servicestack/client/ServerEventClientTests.java" target="_blank" rel="noopener noreferrer">Java 8 / JVM Server Events Integration Tests</a></li><li><a href="https://github.com/ServiceStack/ServiceStack.Java/blob/master/src/AndroidClient/android/src/androidTest/java/net/servicestack/android/ServerEventClientTests.java" target="_blank" rel="noopener noreferrer">Java 7 / Android Server Events Integration Tests</a></li></ul><h3 id="server-event-providers" tabindex="-1">Server Event Providers <a class="header-anchor" href="#server-event-providers" aria-hidden="true">#</a></h3><p>There are 2 Server Implementations of Server Events available, the default In Memory provider enables sending real-time communications to all clients subscribed to the same ServiceStack Instance whilst Redis Server Events utilizes a distributed redis-server back-end to provide a scale-out option capable of serving across multiple fan-out/load-balanced App Servers:</p><ul><li>Memory Server Events (default)</li><li><a href="/redis-server-events.html">Redis Server Events</a></li></ul><h2 id="registering" tabindex="-1">Registering <a class="header-anchor" href="#registering" aria-hidden="true">#</a></h2><p>Like most other <a href="/plugins.html">modular functionality</a> in ServiceStack, Server Sent Events is encapsulated in a single Plugin that can be registered in your AppHost with:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The registration above is all that&#39;s needed for most use-cases which just uses the defaults below:</p><div class="language-csharp"><pre><code><span class="token keyword">class</span> <span class="token class-name">ServerEventsFeature</span>
<span class="token punctuation">{</span>
    StreamPath <span class="token operator">=</span> <span class="token string">&quot;/event-stream&quot;</span><span class="token punctuation">;</span>            <span class="token comment">// The entry-point for Server Sent Events</span>
    HeartbeatPath <span class="token operator">=</span> <span class="token string">&quot;/event-heartbeat&quot;</span><span class="token punctuation">;</span>      <span class="token comment">// Where to send heartbeat pulses</span>
    UnRegisterPath <span class="token operator">=</span> <span class="token string">&quot;/event-unregister&quot;</span><span class="token punctuation">;</span>    <span class="token comment">// Where to unregister your subscription</span>
    SubscribersPath <span class="token operator">=</span> <span class="token string">&quot;/event-subscribers&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// View public info of channel subscribers </span>

    <span class="token comment">// Return \`401 Unauthorized\` to non-authenticated clients</span>
    LimitToAuthenticatedUsers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// How long to wait for heartbeat before unsubscribing</span>
    IdleTimeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token comment">// Client Interval for sending heartbeat messages</span>
    HeartbeatInterval <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send notifications when subscribers join/leave</span>
    NotifyChannelOfSubscriptions <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The paths lets you customize the routes for the built-in Server Events API&#39;s, whilst setting a path to <code>null</code> disables that feature</p></div><h3 id="custom-event-hooks" tabindex="-1">Custom Event Hooks <a class="header-anchor" href="#custom-event-hooks" aria-hidden="true">#</a></h3><p>A number of hooks are available providing entry points where custom logic can be added to modify or enhance existing behavior:</p><div class="language-csharp"><pre><code><span class="token keyword">class</span> <span class="token class-name">ServerEventsFeature</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>IRequest<span class="token punctuation">&gt;</span></span> OnInit<span class="token punctuation">;</span>                          <span class="token comment">// Subscription pre-initialization callback</span>
     <span class="token comment">//Filter OnConnect messages</span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> OnConnect<span class="token punctuation">;</span>

    <span class="token comment">// Events fired when </span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> IRequest<span class="token punctuation">&gt;</span></span> OnCreated<span class="token punctuation">;</span>   <span class="token comment">// Subscription is created</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> Task<span class="token punctuation">&gt;</span></span> OnSubscribeAsync<span class="token punctuation">;</span>  <span class="token comment">// Subscription is registered </span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span>Task<span class="token punctuation">&gt;</span></span> OnUnsubscribeAsync<span class="token punctuation">;</span> <span class="token comment">// Subscription is unregistered</span>
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> Task<span class="token punctuation">&gt;</span></span> OnUpdateAsync<span class="token punctuation">;</span>     <span class="token comment">// Subscription is updated</span>

    <span class="token comment">// Fired when message is published</span>
    <span class="token class-name">Action<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> IResponse<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> OnPublish<span class="token punctuation">;</span> 
    <span class="token class-name">Func<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> IResponse<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">,</span> Task<span class="token punctuation">&gt;</span></span> OnPublishAsync<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="sending-server-events" tabindex="-1">Sending Server Events <a class="header-anchor" href="#sending-server-events" aria-hidden="true">#</a></h2><p>The way your Services send notifications is via the <code>IServerEvents</code> API which defaults to an in-memory <code>MemoryServerEvents</code> implementation which keeps a record of all subscriptions and connections in memory:</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Server Events can be configured to use a <a href="/redis-server-events.html">distributed Redis backend</a> allowing it to work across load-balanced app servers</p></div><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServerEvents</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">// External API&#39;s</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyAllAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyChannelAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifySubscriptionAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyUserIdAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyUserNameAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifySessionAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sessionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> sel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> msg<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>

    <span class="token comment">// Sync APIs</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyAll</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> channel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifySubscription</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyUserId</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyUserName</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifySession</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sessionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">SubscriptionInfo</span> <span class="token function">GetSubscriptionInfo</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SubscriptionInfo<span class="token punctuation">&gt;</span></span> <span class="token function">GetSubscriptionInfosByUserId</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Raw JSON APIs</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyAllJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyChannelJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> channel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifySubscriptionJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyUserIdJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifyUserNameJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">NotifySessionJsonAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sessionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> json<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> chan<span class="token punctuation">)</span>

    <span class="token comment">// Admin API&#39;s</span>
    <span class="token return-type class-name">Task</span> <span class="token function">RegisterAsync</span><span class="token punctuation">(</span><span class="token class-name">IEventSubscription</span> subscription<span class="token punctuation">,</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> conArgs<span class="token punctuation">,</span><span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UnRegisterAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> token<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">GetNextSequence</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">RemoveExpiredSubscriptionsAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Task</span> <span class="token function">SubscribeToChannelsAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UnsubscribeFromChannelsAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SubscriptionInfo<span class="token punctuation">&gt;</span></span> <span class="token function">GetAllSubscriptionInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Client API&#39;s</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetSubscriptionsDetails</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetAllSubscriptionsDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">PulseAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear all Registrations</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We recommend using the non-blocking <code>*Async</code> APIs when possible, especially in .NET Core Apps or high load environments.</p><p>The API&#39;s your Services predominantly deal with are the <strong>External API&#39;s</strong> which allow sending of messages at different levels of granularity. As Server Events have deep integration with ServiceStack&#39;s <a href="/sessions.html">Sessions</a> and <a href="/authentication-and-authorization.html">Authentication Providers</a> you&#39;re also able to notify specific users by either:</p><div class="language-csharp"><pre><code><span class="token function">NotifyUserIdAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// UserAuthId</span>
<span class="token function">NotifyUserNameAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// UserName</span>
<span class="token function">NotifySessionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// Session Id</span>
</code></pre></div><p>Whilst these all provide different ways to send a message to a single authenticated user, any user can be connected to multiple subscriptions at any one time (e.g. by having multiple tabs open). Each one of these subscriptions is uniquely identified by a <code>subscriptionId</code> which you can send a message with using:</p><div class="language-csharp"><pre><code><span class="token function">NotifySubscriptionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Unique Subscription Id</span>
</code></pre></div><p>There are also API&#39;s to retrieve a users single event subscription as well as all subscriptions for a user:</p><div class="language-csharp"><pre><code><span class="token return-type class-name">SubscriptionInfo</span> <span class="token function">GetSubscriptionInfo</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SubscriptionInfo<span class="token punctuation">&gt;</span></span> <span class="token function">GetSubscriptionInfosByUserId</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="event-subscription" tabindex="-1">Event Subscription <a class="header-anchor" href="#event-subscription" aria-hidden="true">#</a></h2><p>An Event Subscription allows you to inspect different metadata contained on each subscription as well as being able to <code>Publish()</code> messages directly to it, manually send a Heartbeat <code>Pulse()</code> (to keep the connection active) as well as <code>Unsubscribe()</code> to revoke the subscription and terminate the HTTP Connection.</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEventSubscription</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IMeta</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">DateTime</span> CreatedAt <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> LastPulseAt <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">long</span></span> LastMessageId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Channels <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> UserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> SessionId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> SubscriptionId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> UserAddress <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsAuthenticated <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UpdateChannels</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">,</span> Task<span class="token punctuation">&gt;</span></span> OnUnsubscribeAsync <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Action<span class="token punctuation">&lt;</span>IEventSubscription<span class="token punctuation">&gt;</span></span> OnUnsubscribe <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UnsubscribeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Publish</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> token<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PublishRaw</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">PublishRawAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> frame<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> token<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Pulse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> ServerArgs <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> ConnectArgs <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>IServerEvents</code> API also offers an API to UnRegister a subscription with:</p><div class="language-csharp"><pre><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UnRegister</span><span class="token punctuation">(</span><span class="token class-name">IEventSubscription</span> subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="event-subscription-metadata" tabindex="-1">Event Subscription Metadata <a class="header-anchor" href="#event-subscription-metadata" aria-hidden="true">#</a></h3><p>The <code>ServerArgs</code> string Dictionary on <code>IEventSubscription</code> and <code>SubscriptionInfo</code> is for storing metadata on a SSE subscription that you only want visible on the Server (e.g. Service implementations), <code>ConnectArgs</code> is for info you want the subscribed client to have access to from its <code>OnConnect</code> event whilst the <code>Meta</code> dictionary is for public info you&#39;d like other channel subscribers to have access to from their <code>OnJoin</code>, <code>OnLeave</code> and <code>OnUpdate</code> on subscriber events.</p><p>Here&#39;s an example of using the server <code>OnCreated</code> callback to populate all 3 Dictionaries:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsFeature</span> <span class="token punctuation">{</span>
    OnCreated <span class="token operator">=</span> <span class="token punctuation">(</span>sub<span class="token punctuation">,</span>req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">.</span>IsAuthenticated<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        sub<span class="token punctuation">.</span>Meta<span class="token punctuation">[</span><span class="token string">&quot;Nickname&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> session<span class="token punctuation">.</span>Nickname<span class="token punctuation">;</span>           <span class="token comment">// channel subscribers</span>
        sub<span class="token punctuation">.</span>ConnectArgs<span class="token punctuation">[</span><span class="token string">&quot;Email&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> session<span class="token punctuation">.</span>Email<span class="token punctuation">;</span>          <span class="token comment">// client subscriber </span>
        sub<span class="token punctuation">.</span>ServerArgs<span class="token punctuation">[</span><span class="token string">&quot;PostalCode&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> session<span class="token punctuation">.</span>PostalCode<span class="token punctuation">;</span> <span class="token comment">// server</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="channels" tabindex="-1">Channels <a class="header-anchor" href="#channels" aria-hidden="true">#</a></h2><p>Standard Publish / Subscribe patterns include the concept of a <strong>Channel</strong> upon which to subscribe and publish messages to. The channel in Server Events can be any arbitrary string which is declared on the fly when it&#39;s first used.</p><div class="info custom-block"><p class="custom-block-title">Tip</p><p>As Request DTO names are unique in ServiceStack they can make for good channel names which benefit from providing a typed API for free, e.g: <code>nameof(Request)</code></p></div><p>The API to send a message to a specific channel is:</p><div class="language-csharp"><pre><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> channel<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which just includes the name of the <code>channel</code>, the <code>selector</code> you wish the message applies to and the <code>message</code> to send which can be any JSON serializable object.</p><p>Along with being able to send a message to everyone on a channel, each API also offers an optional <code>channel</code> filter which when supplied will limit messages only to that channel:</p><div class="language-csharp"><pre><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyUserId</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="order-of-events" tabindex="-1">Order of Events <a class="header-anchor" href="#order-of-events" aria-hidden="true">#</a></h2><p>The following Server and Client callbacks are fired when a client first makes a Server Events Connection:</p><ol><li><code>ServerEventsFeature.OnInit()</code> - Fired when the server receives the initial HTTP connection. This callback can be used to customize any HTTP Headers that are sent back to the client</li><li><code>ServerEventsFeature.OnCreated()</code> - Fired when the server <code>IEventSubscription</code> is created but before it becomes Connected.</li><li><code>ServerEventsFeature.OnConnect()</code> - Fired when the <code>IEventSubscription</code> is about to be connected. This callback can be used to modify the connection info arguments the client receives</li><li><strong>(Client)</strong> - The Client is then sent an <code>cmd.onConnect</code> message with the connection info arguments about the connection.</li><li><code>ServerEventsFeature.OnSubscribe()</code> - Fired after the subscription is registered. This callback can be used to send any custom messages to the client</li><li><code>ServerEventsFeature.OnUpdateAsync()</code> - Fired after the subscription is updated (e.g. subscribed Channels are updated)</li><li><strong>(Client)</strong> - If <code>ServerEventsFeature.NotifyChannelOfSubscriptions = true</code> every client in the same channel receives a <code>cmd.onJoin</code> message to notify them that a new subscription has joined the channel as well as a <code>cmd.onLeave</code> message when subscription leaves the channel</li></ol><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The <code>cmd.onConnect</code>, <code>cmd.onJoin</code> and <code>cmd.onLeave</code> messages can be handled with the <a href="/javascript-server-events-client.html#global-event-handlers">Global Event Handlers</a> on the JavaScript Client and the <a href="/csharp-server-events-client.html#message-event-handlers">Message Event Handlers</a> or the <a href="/csharp-server-events-client.html#the-global-receiver">Global Receiver</a> .NET ServerEventClient</p></div><h3 id="heartbeats" tabindex="-1">Heartbeats <a class="header-anchor" href="#heartbeats" aria-hidden="true">#</a></h3><p>Periodically whilst the client maintains a ServerEvents subscription with the server it will send periodic Heartbeats to the Server. This will fire the <code>ServerEventsFeature.OnHeartbeatInit()</code> server event which if the client is still connected will be sent a <code>cmd.onHeartbeat</code> message. If the subscription no longer exists, heartbeats will return a <code>404 - Subscription {id} does not exist</code> HTTP Response.</p><h2 id="chat-features" tabindex="-1">Chat Features <a class="header-anchor" href="#chat-features" aria-hidden="true">#</a></h2><p>The implementation of Chat is a great way to explore different Server Event features which make it easy to develop highly interactive and responsive web apps with very little effort.</p><h3 id="active-subscribers" tabindex="-1">Active Subscribers <a class="header-anchor" href="#active-subscribers" aria-hidden="true">#</a></h3><p>One feature common to chat clients is to get details of all the active subscribers in a channel which we can get from the built-in <code>/event-subscribers</code> route, e.g:</p><div class="language-javascript"><pre><code>$<span class="token punctuation">.</span><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/event-subscribers?channel=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>channel<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">users</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usersMap<span class="token punctuation">[</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
        refCounter<span class="token punctuation">[</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>refCounter<span class="token punctuation">[</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> html <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>usersMap<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">createUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As a single user can have multiple subscriptions (e.g. multiple tabs open) users are merged into a single <code>usersMap</code> so each user is only listed once in the users list and a <code>refCounter</code> is maintained with the number of subscriptions each user has, so we&#39;re able to tell when the user has no more active subscriptions and can remove them from the list.</p><h3 id="chat-box" tabindex="-1">Chat box <a class="header-anchor" href="#chat-box" aria-hidden="true">#</a></h3><p>Chat&#39;s text box provides a free-text entry input to try out different Server Event features where each text message is posted to a ServiceStack Service which uses the <code>IServerEvents</code> API to send notifications the channels subscribers. When a server event is received on the client, the ss-utils.js client bindings routes the message to the appropriate handler. As all messages go through this same process, the moment the log entry appears in your chat window is also when it appears for everyone else (i.e instant when running localhost).</p><p>Normal chat messages (i.e. that don&#39;t specify a selector) uses the default <code>cmd.chat</code> selector which is sent to the <code>chat</code> handler that just echoes the entry into the chat log with:</p><div class="language-javascript"><pre><code><span class="token function-variable function">chat</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> m<span class="token punctuation">.</span>id<span class="token punctuation">,</span> userId<span class="token operator">:</span> m<span class="token punctuation">.</span>fromUserId<span class="token punctuation">,</span> userName<span class="token operator">:</span> m<span class="token punctuation">.</span>fromName<span class="token punctuation">,</span> msg<span class="token operator">:</span> m<span class="token punctuation">.</span>message<span class="token punctuation">,</span> 
               cls<span class="token operator">:</span> m<span class="token punctuation">.</span>private <span class="token operator">?</span> <span class="token string">&#39; private&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="specifying-a-selector" tabindex="-1">Specifying a selector <a class="header-anchor" href="#specifying-a-selector" aria-hidden="true">#</a></h3><p>You can specify to use an alternative selector by prefixing the message with a <code>/{selector}</code>, e.g:</p><div class="language-"><pre><code>/cmd.announce This is your captain speaking ...
</code></pre></div><p>When a selector is specified in Chat it routes the message to the <code>/channels/{Channel}/raw</code> Service which passes the raw message through as a string. Normal Chat entries are instead posted to the <code>/channels/{Channel}/chat</code> Service, adding additional metadata to the chat message with the user id and name of the sender so it can be displayed in the chat log. The Javascript code that calls both Services is simply:</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parts <span class="token operator">=</span> $<span class="token punctuation">.</span>ss<span class="token punctuation">.</span><span class="token function">splitOnFirst</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/channels/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>channel<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/raw</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> from<span class="token operator">:</span> activeSub<span class="token punctuation">.</span>id<span class="token punctuation">,</span> toUserId<span class="token operator">:</span> to<span class="token punctuation">,</span> message<span class="token operator">:</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> selector<span class="token operator">:</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/channels/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>channel<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/chat</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> from<span class="token operator">:</span> activeSub<span class="token punctuation">.</span>id<span class="token punctuation">,</span> toUserId<span class="token operator">:</span> to<span class="token punctuation">,</span> message<span class="token operator">:</span> msg<span class="token punctuation">,</span> selector<span class="token operator">:</span> <span class="token string">&quot;cmd.chat&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sending-a-message-to-a-specific-user" tabindex="-1">Sending a message to a specific user <a class="header-anchor" href="#sending-a-message-to-a-specific-user" aria-hidden="true">#</a></h3><p>Another special syntax supported in Chat is the ability to send messages to other users by prefixing it with <code>@</code> followed by the username, e.g:</p><div class="language-"><pre><code>@mythz this is a private message
@mythz /tv.watch http://youtu.be/518XP8prwZo
</code></pre></div><p>There&#39;s also a special <code>@me</code> alias to send a message to yourself, e.g:</p><div class="language-"><pre><code>@me /tv.watch http://youtu.be/518XP8prwZo
</code></pre></div><h2 id="server-event-services" tabindex="-1">Server Event Services <a class="header-anchor" href="#server-event-services" aria-hidden="true">#</a></h2><p>By default ServiceStack doesn&#39;t expose any Services that can send notifications to other users by default. It&#39;s left up to your application as to what functionality and level of granularity should be enabled for your Application. Your Services can send notifications via the <code>IServerEvents</code> provider.</p><p>Below is the annotated implementation for both Web Services used by Chat. The <code>PostRawToChannel</code> is a simple implementation that just relays the message sent to all users in the channel or just a specific user if <code>ToUserId</code> parameter is specified.</p><p>The <code>PostChatToChannel</code> Service is used for sending Chat messages which sends a wrapped <code>ChatMessage</code> DTO instead that holds additional metadata about the message that the Chat UI requires:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/channels/{Channel}/chat&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostChatToChannel</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>ChatMessage<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> From <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ToUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Channel <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Selector <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/channels/{Channel}/raw&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostRawToChannel</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturnVoid</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> From <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ToUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Channel <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Selector <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerEventsServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IServerEvents</span> ServerEvents <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IChatHistory</span> ChatHistory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IAppSettings</span> AppSettings <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">PostRawToChannel</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IsAuthenticated <span class="token operator">&amp;&amp;</span> AppSettings<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;LimitRemoteControlToAuthenticatedUsers&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpError</span><span class="token punctuation">(</span>HttpStatusCode<span class="token punctuation">.</span>Forbidden<span class="token punctuation">,</span> <span class="token string">&quot;You must be authenticated to use remote control.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Ensure the subscription sending this notification is still active</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sub <span class="token operator">=</span> ServerEvents<span class="token punctuation">.</span><span class="token function">GetSubscriptionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sub <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> HttpError<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Subscription </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">request<span class="token punctuation">.</span>From</span><span class="token punctuation">}</span></span><span class="token string"> does not exist&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Check to see if this is a private message to a specific user</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>ToUserId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Only notify that specific user</span>
            ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ToUserId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Notify everyone in the channel for public messages</span>
            ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Channel<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">PostChatToChannel</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Ensure the subscription sending this notification is still active</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sub <span class="token operator">=</span> ServerEvents<span class="token punctuation">.</span><span class="token function">GetSubscriptionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sub <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> HttpError<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Subscription </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">request<span class="token punctuation">.</span>From</span><span class="token punctuation">}</span></span><span class="token string"> does not exist&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> channel <span class="token operator">=</span> request<span class="token punctuation">.</span>Channel<span class="token punctuation">;</span>

        <span class="token comment">// Create a DTO ChatMessage to hold all required info about this message</span>
        <span class="token class-name"><span class="token keyword">var</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ChatMessage</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> ChatHistory<span class="token punctuation">.</span><span class="token function">GetNextMessageId</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>
            FromUserId <span class="token operator">=</span> sub<span class="token punctuation">.</span>UserId<span class="token punctuation">,</span>
            FromName <span class="token operator">=</span> sub<span class="token punctuation">.</span>DisplayName<span class="token punctuation">,</span>
            Message <span class="token operator">=</span> request<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// Check to see if this is a private message to a specific user</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>ToUserId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Mark the message as private so it can be displayed differently in Chat</span>
            msg<span class="token punctuation">.</span>Private <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// Send the message to the specific user Id</span>
            ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ToUserId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Also provide UI feedback to the user sending the private message so they</span>
            <span class="token comment">// can see what was sent. Relay it to all senders active subscriptions </span>
            <span class="token class-name"><span class="token keyword">var</span></span> toSubs <span class="token operator">=</span> ServerEvents<span class="token punctuation">.</span><span class="token function">GetSubscriptionInfosByUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ToUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> toSub <span class="token keyword">in</span> toSubs<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Change the message format to contain who the private message was sent to</span>
                msg<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;@</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">toSub<span class="token punctuation">.</span>DisplayName</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">msg<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span>
                ServerEvents<span class="token punctuation">.</span><span class="token function">NotifySubscription</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Notify everyone in the channel for public messages</span>
            ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Channel<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msg<span class="token punctuation">.</span>Private<span class="token punctuation">)</span>
            ChatHistory<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="updating-channels-on-live-subscriptions" tabindex="-1">Updating Channels on Live Subscriptions <a class="header-anchor" href="#updating-channels-on-live-subscriptions" aria-hidden="true">#</a></h2><p>You can update a live Server Events connection with Channels you want to Join or Leave using the built-in ServerEvents <code>UpdateEventSubscriber</code> Service:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/event-subscribers/{Id}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateEventSubscriber</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>UpdateEventSubscriberResponse<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> SubscribeChannels <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> UnsubscribeChannels <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This lets you modify your active subscription with channels you want to join or leave with a HTTP POST Request, e.g:</p><div class="language-"><pre><code>POST /event-subscribers/{subId}
SubscribeChannels=chan1,chan2&amp;UnsubscribeChannels=chan3,chan4
</code></pre></div><h3 id="onupdate-notification" tabindex="-1">onUpdate Notification <a class="header-anchor" href="#onupdate-notification" aria-hidden="true">#</a></h3><p>As this modifies the active subscription it also publishes a new <strong>onUpdate</strong> notification to all channel subscribers so they&#39;re able to maintain up-to-date info on each subscriber.</p><p>In C# <code>ServerEventsClient</code> this can be handled together with <strong>onJoin</strong> and <strong>onLeave</strong> events using <code>OnCommand</code>:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span>OnCommand <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">//= ServerEventJoin, ServerEventLeave or ServerEventUpdate</span>
</code></pre></div><p>In the ss-utils JavaScript Client this can be handled with a Global Event Handler, e.g:</p><div class="language-javascript"><pre><code><span class="token function">$</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleServerEvents</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    handlers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">onConnect</span><span class="token operator">:</span> <span class="token parameter">connectedUserInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onJoin</span><span class="token operator">:</span> <span class="token parameter">userInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token parameter">userInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onUpdate</span><span class="token operator">:</span> <span class="token parameter">userInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="serverevents-update-channel-apis" tabindex="-1">ServerEvents Update Channel APIs <a class="header-anchor" href="#serverevents-update-channel-apis" aria-hidden="true">#</a></h3><p>Whilst internally, from within ServiceStack you can update a channel&#39;s subscription using the <a href="https://github.com/ServiceStack/ServiceStack/blob/b9a33c34d0b0eedbcc6b3483257f1dc37bbf713f/src/ServiceStack/ServerEventsFeature.cs#L1004" target="_blank" rel="noopener noreferrer">IServerEvents</a> APIs:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServerEvents</span> 
<span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SubscribeToChannels</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UnsubscribeFromChannels</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> subscriptionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-hidden="true">#</a></h2><h3 id="response-buffering-delaying-events" tabindex="-1">Response Buffering delaying events <a class="header-anchor" href="#response-buffering-delaying-events" aria-hidden="true">#</a></h3><p>If your web server is configured to automatically buffer the response it will delay when the <a href="http://stackoverflow.com/a/25983774/85785" target="_blank" rel="noopener noreferrer">Server Events get sent to the client</a>. In IIS Express you can disable buffering by disabling compression for dynamic requests by adding this to your <strong>Web.config</strong>:</p><div class="language-xml"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.webServer</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>urlCompression</span> <span class="token attr-name">doStaticCompression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">doDynamicCompression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.webServer</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Alternatively you can switch to use Visual Studio Development Server which doesn&#39;t buffer by default.</p><h2 id="serverevents-examples" tabindex="-1">ServerEvents Examples <a class="header-anchor" href="#serverevents-examples" aria-hidden="true">#</a></h2><h3 id="android-java-chat" tabindex="-1"><a href="https://github.com/ServiceStackApps/AndroidJavaChat" target="_blank" rel="noopener noreferrer">Android Java Chat</a> <a class="header-anchor" href="#android-java-chat" aria-hidden="true">#</a></h3><p>Java Chat client utilizing <a href="/java-server-events-client.html">Server Events</a> for real-time notifications and enabling seamless OAuth Sign In&#39;s using Facebook, Twitter and Google&#39;s native SDKs:</p><p><a href="https://github.com/ServiceStackApps/AndroidJavaChat" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/java/java-android-chat-screenshot-540x960.png" alt=""></a></p><h3 id="web-node-js-and-react-native-serverevents-apps" tabindex="-1"><a href="https://github.com/ServiceStackApps/typescript-server-events" target="_blank" rel="noopener noreferrer">Web, Node.js and React Native ServerEvents Apps</a> <a class="header-anchor" href="#web-node-js-and-react-native-serverevents-apps" aria-hidden="true">#</a></h3><p>Using TypeScript ServerEvents Client to create real-time Web, node.js server and React Native Mobile Apps:</p><p><a href="https://github.com/ServiceStackApps/typescript-server-events" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/typescript-serverevents/typescript-server-events-banner.png" alt=""></a></p><h3 id="gistlyn" tabindex="-1"><a href="https://github.com/ServiceStack/Gistlyn" target="_blank" rel="noopener noreferrer">Gistlyn</a> <a class="header-anchor" href="#gistlyn" aria-hidden="true">#</a></h3><p>Gistlyn is a C# Gist IDE for creating, running and sharing stand-alone, executable C# snippets.</p><p><a href="http://gistlyn.com" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/gistlyn/home-screenshot.png" alt=""></a></p><h3 id="react-chat" tabindex="-1"><a href="https://github.com/ServiceStackApps/ReactChat" target="_blank" rel="noopener noreferrer">React Chat</a> <a class="header-anchor" href="#react-chat" aria-hidden="true">#</a></h3><p>React Chat is a port of <a href="https://github.com/ServiceStackApps/Chat" target="_blank" rel="noopener noreferrer">ServiceStack Chat</a> ES5, jQuery Server Events demo into a <a href="http://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">TypeScript</a>, <a href="http://facebook.github.io/react/" target="_blank" rel="noopener noreferrer">React</a> and <a href="https://github.com/reactjs/redux" target="_blank" rel="noopener noreferrer">Redux</a> App:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/chat-react/screenshot.png" alt=""></p><h3 id="xamarin-android-chat" tabindex="-1"><a href="https://github.com/ServiceStackApps/AndroidXamarinChat" target="_blank" rel="noopener noreferrer">Xamarin.Android Chat</a> <a class="header-anchor" href="#xamarin-android-chat" aria-hidden="true">#</a></h3><p>Xamarin.Android Chat utilizes the <a href="/csharp-server-events-client.html">.NET PCL Server Events Client</a> to create an Android Chat App connecting to the existing <a href="http://chat.netcore.io/" target="_blank" rel="noopener noreferrer">chat.netcore.io</a> Server Events back-end where it&#39;s able to communicate with existing Ajax clients and other connected Android Chat Apps.</p><p><a href="https://www.youtube.com/watch?v=tImAm2LURu0" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/xamarin-android-server-events.png" alt=""></a></p><blockquote><p><a href="https://www.youtube.com/watch?v=tImAm2LURu0" target="_blank" rel="noopener noreferrer">YouTube Video</a> and <a href="https://github.com/ServiceStackApps/AndroidXamarinChat" target="_blank" rel="noopener noreferrer">AndroidXamarinChat Repo</a></p></blockquote><h3 id="networked-time-traveller-shape-creator" tabindex="-1"><a href="https://github.com/ServiceStackApps/typescript-redux#example-9---real-time-networked-time-traveller" target="_blank" rel="noopener noreferrer">Networked Time Traveller Shape Creator</a> <a class="header-anchor" href="#networked-time-traveller-shape-creator" aria-hidden="true">#</a></h3><p>A network-enhanced version of the <a href="https://github.com/ServiceStackApps/typescript-redux#example-8---time-travelling-using-state-snapshots" target="_blank" rel="noopener noreferrer">stand-alone Time Traveller Shape Creator</a> that allows users to <strong>connect to</strong> and <strong>watch</strong> other users using the App in real-time similar to how users can use Remote Desktop to watch another computer&#39;s screen:</p><p><a href="http://redux.servicestack.net" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/redux-chrome-safari.png" alt=""></a></p><blockquote><p>Live demo: <a href="http://redux.servicestack.net" target="_blank" rel="noopener noreferrer">http://redux.servicestack.net</a></p></blockquote><h3 id="chat" tabindex="-1"><a href="https://github.com/ServiceStackApps/Chat" target="_blank" rel="noopener noreferrer">Chat</a> <a class="header-anchor" href="#chat" aria-hidden="true">#</a></h3><blockquote><p>Feature-rich Single Page Chat App, showcasing Server Events support in 170 lines of JavaScript!</p></blockquote><p><a href="http://chat.netcore.io" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/chat.png" alt=""></a></p><h3 id="react-chat-desktop" tabindex="-1"><a href="https://github.com/ServiceStackApps/ReactChatApps" target="_blank" rel="noopener noreferrer">React Chat Desktop</a> <a class="header-anchor" href="#react-chat-desktop" aria-hidden="true">#</a></h3><blockquote><p>Built with <a href="https://github.com/ServiceStackApps/ReactDesktopApps" target="_blank" rel="noopener noreferrer">React Desktop Apps</a><a href="http://VS.NET" target="_blank" rel="noopener noreferrer">VS.NET</a> template and packaged into a native Desktop App for Windows and OSX - showcasing synchronized real-time control of multiple Windows Apps:</p></blockquote><p><a href="https://youtu.be/-9kVqdPbqOM" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/react-desktop-apps/dancing-windows.png" alt=""></a></p><blockquote><p>Downloads for <a href="https://github.com/ServiceStackApps/ReactChatApps#downloads" target="_blank" rel="noopener noreferrer">Windows, OSX, Linux and Web</a></p></blockquote>__VP_STATIC_END__`,131),o=[p];function c(l,r,i,u,k,d){return a(),s("div",null,o)}var g=n(t,[["render",c]]);export{m as __pageData,g as default};
