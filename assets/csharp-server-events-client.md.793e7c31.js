import{_ as a,c as e,o as t,b as n,e as s,a as o}from"./app.14440598.js";const f=`{"title":"C# Server Events Client","description":"","frontmatter":{"slug":"csharp-server-events-client","title":"C# Server Events Client"},"headers":[{"level":3,"title":"Managed Connection","slug":"managed-connection"},{"level":3,"title":"Handling Server Events","slug":"handling-server-events"},{"level":3,"title":"Assigning Callback Handlers","slug":"assigning-callback-handlers"},{"level":3,"title":"Customizing Metadata sent to clients","slug":"customizing-metadata-sent-to-clients"},{"level":3,"title":"Using C# Async/Await friendly API's","slug":"using-c-async-await-friendly-api-s"},{"level":3,"title":"Message Event Handlers","slug":"message-event-handlers"},{"level":3,"title":"Named Receivers","slug":"named-receivers"},{"level":3,"title":"Sending messages to Named Receivers","slug":"sending-messages-to-named-receivers"},{"level":3,"title":"Life-cycle of Receivers","slug":"life-cycle-of-receivers"},{"level":3,"title":"The Global Receiver","slug":"the-global-receiver"},{"level":2,"title":"Event Triggers","slug":"event-triggers"},{"level":2,"title":"Channel Subscriber APIs","slug":"channel-subscriber-apis"},{"level":3,"title":"onUpdate Notification","slug":"onupdate-notification"},{"level":2,"title":"Add Authentication support to .NET ServerEvents Client","slug":"add-authentication-support-to-net-serverevents-client"},{"level":2,"title":"Custom Authentication","slug":"custom-authentication"},{"level":2,"title":"Troubleshooting","slug":"troubleshooting"},{"level":2,"title":"Xamarin.Android Chat","slug":"xamarin-android-chat"}],"relativePath":"csharp-server-events-client.md","lastUpdated":1634495307614}`,p={},c=n("p",null,[s("Like ServiceStack's other "),n("a",{href:"/csharp-client.html"},"C# Service Clients"),s(", the new "),n("code",null,"ServerEventsClient"),s(" is a "),n("a",{href:"https://github.com/ServiceStackApps/HelloMobile",target:"_blank",rel:"noopener noreferrer"},"portable library"),s(" contained in the "),n("code",null,"ServiceStack.Client"),s(" NuGet package:")],-1),i=n("div",{class:"package-reference-box"},[n("div",{class:"flex"},[n("div",{class:"flex-grow pre-container",style:{background:"#002440"}},[n("pre",{class:"sh copy m-0 p-0 pl-2 py-1 align-middle",style:{background:"#002440"}},[n("p",null,[n("code",null,'<PackageReference Include="ServiceStack.Client" Version="5.*" />')]),s(`
`)])]),n("div",{class:"flex-shrink"},[n("i",{class:"svg-copy inline-block w-8 h-full",title:"copy",onclick:"copy(this)"}),n("b")])]),n("div",{class:"copy-text w-full text-right h-6"})],-1),l=o(`<p>And like the Service Clients it requires the <code>BaseUri</code> of your ServiceStack instance as well as an optional <code>channel</code> for the client to subscribe to:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span>
    <span class="token string">&quot;http://chat.netcore.io&quot;</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">channels</span><span class="token punctuation">:</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="managed-connection" tabindex="-1">Managed Connection <a class="header-anchor" href="#managed-connection" aria-hidden="true">#</a></h3><p>The <strong>C# ServerEvent Client</strong> is a managed .NET client with feature parity with the <a href="https://github.com/ServiceStackApps/Chat#client-bindings---ss-utilsjs" target="_blank" rel="noopener noreferrer">ServiceStack&#39;s JavaScript client</a> that <strong>auto-reconnects</strong> when a connection is lost, <strong>sends periodic heartbeats</strong> to maintain an active subscription as well as <strong>auto-unregistering</strong> once the client stops listening for messages, or gets disposed.</p><h3 id="handling-server-events" tabindex="-1">Handling Server Events <a class="header-anchor" href="#handling-server-events" aria-hidden="true">#</a></h3><p>Unlike other C# clients, the ServerEvents Client is mainly reactive in that it&#39;s primarily waiting for Server Events to be initiated from a remote server instead of the typical scenario in which requests are initiated by clients. To maximize utility, there are a number of different API&#39;s to receive and process messages:</p><h3 id="assigning-callback-handlers" tabindex="-1">Assigning Callback Handlers <a class="header-anchor" href="#assigning-callback-handlers" aria-hidden="true">#</a></h3><p>One way to receive messages (useful in long-running clients) is to assign handlers for each of the different events that are fired. This example shows how to capture all the different events a Client can receive:</p><div class="language-csharp"><pre><code><span class="token class-name">ServerEventConnect</span> connectMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> msgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ServerEventMessage<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> commands <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ServerEventMessage<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Exception<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span>baseUri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    OnConnect <span class="token operator">=</span> e <span class="token operator">=&gt;</span> connectMsg <span class="token operator">=</span> e<span class="token punctuation">,</span>
    OnCommand <span class="token operator">=</span> commands<span class="token punctuation">.</span>Add<span class="token punctuation">,</span>
    OnMessage <span class="token operator">=</span> msgs<span class="token punctuation">.</span>Add<span class="token punctuation">,</span>
    OnException <span class="token operator">=</span> errors<span class="token punctuation">.</span>Add<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Once the Client is configured, calling <code>Start()</code> will start listening for messages and calling <code>Stop()</code> or <code>Dispose()</code> will cancel the background HTTP connection and stop it listening for server events.</p><h3 id="customizing-metadata-sent-to-clients" tabindex="-1">Customizing Metadata sent to clients <a class="header-anchor" href="#customizing-metadata-sent-to-clients" aria-hidden="true">#</a></h3><p>As ServerEvents have deep integration with the rest of ServiceStack we&#39;re able to offer <a href="https://github.com/ServiceStack/ServiceStack/blob/71b51d231d1ddb2ba7da39613e216ab75fd181c0/src/ServiceStack.Client/ServerEventsClient.cs#L14-L44" target="_blank" rel="noopener noreferrer">Typed Messages</a> containing the users <code>UserAuthId</code>, <code>DisplayName</code> and <code>ProfileUrl</code> of the users avatar when it&#39;s available. The typed messages also offer an extensible <code>Dictionary&lt;string,string&gt; Meta</code> collection for maintaining custom metadata that can be sent to clients by appending to them in the ServerEventsFeature hooks, which can be defined when registering <code>ServerEventsFeature</code>:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsFeature</span> <span class="token punctuation">{</span> 
    <span class="token comment">// private Connect args</span>
    OnConnect <span class="token operator">=</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">,</span>httpReq<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">AppendTo</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>Meta<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// public Join/Leave args</span>
    OnCreated <span class="token operator">=</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">,</span>httpReq<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">AppendTo</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>Meta<span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Whilst distinct <code>OnJoin</code>, <code>OnLeave</code> <code>OnUpdate</code> and <code>OnReconnect</code> callbacks can be used to handle a specific event, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">,</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    OnJoin <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    OnLeave <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    OnUpdate <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    OnReconnect <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="using-c-async-await-friendly-api-s" tabindex="-1">Using C# Async/Await friendly API&#39;s <a class="header-anchor" href="#using-c-async-await-friendly-api-s" aria-hidden="true">#</a></h3><p>Depending on your use-case, if you only want to use the ServerEvent Client for a short-time to listen for predictable responses (i.e. waiting for a Server callback on a pending request) you can alternatively use the Task-based API&#39;s letting you to participate in C# async/await workflows:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span>baseUri<span class="token punctuation">,</span> channel<span class="token operator">=</span><span class="token string">&quot;Home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wait to receive onConnect event</span>
<span class="token class-name">ServerEventConnect</span> connectMsg <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wait to receive onJoin command event</span>
<span class="token class-name">ServerEventCommand</span> joinMsg <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">WaitForNextCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Hold a future task to get notified once a msg has been received</span>
<span class="token class-name">Task<span class="token punctuation">&lt;</span>ServerEventMessage<span class="token punctuation">&gt;</span></span> msgTask <span class="token operator">=</span> client1<span class="token punctuation">.</span><span class="token function">WaitForNextMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send a Web Service Request using the built-in JsonServiceClient</span>
client<span class="token punctuation">.</span>ServiceClient<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PostChatToChannel</span> <span class="token punctuation">{</span>
    Channel <span class="token operator">=</span> client<span class="token punctuation">.</span>Channel<span class="token punctuation">,</span>     <span class="token comment">// The channel we&#39;re listening on</span>
    From <span class="token operator">=</span> client<span class="token punctuation">.</span>SubscriptionId<span class="token punctuation">,</span> <span class="token comment">// Populated after Connect() </span>
    Message <span class="token operator">=</span> <span class="token string">&quot;Hello, World!&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wait till we receive the chat Msg event we sent earlier</span>
<span class="token class-name">ServerEventMessage</span> msg <span class="token operator">=</span> <span class="token keyword">await</span> msgTask<span class="token punctuation">;</span>
</code></pre></div><p>The above example showcases the <strong>3 Task-based API&#39;s</strong> available:</p><ol><li><code>Connect()</code> wait till receiving confirmation of a successful event subscription</li><li><code>WaitForNextCommand()</code> wait for the next <code>onJoin</code> or <code>onLeave</code> subscription events</li><li><code>WaitForNextMessage()</code> wait for the next message published to the channel</li></ol><p>The <code>ServiceClient</code> property lets you access a <code>JsonServiceClient</code> that&#39;s pre-configured with the clients <code>BaseUri</code> so that is primed for Sending Web Service Requests with.</p><p>After the ServerEvent Client has connected, the <code>ConnectionInfo</code> property is populated with the typed <code>ServerEventConnect</code> response.</p><h3 id="message-event-handlers" tabindex="-1">Message Event Handlers <a class="header-anchor" href="#message-event-handlers" aria-hidden="true">#</a></h3><p>The above examples show generic API&#39;s for receiving any type of message, but just like in the JavaScript client, more fine-grained API&#39;s are available for handling specific message types.</p><p>The <code>Handlers</code> dictionary is akin to the JavaScript Client&#39;s <a href="https://github.com/ServiceStackApps/Chat#global-event-handlers" target="_blank" rel="noopener noreferrer">Global Event Handlers</a> which specify lambda&#39;s to be executed when messages are sent with the <code>cmd.*</code> selector:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span>Handlers<span class="token punctuation">[</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>client<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//Deserialize JSON string to typed DTO</span>
    <span class="token class-name"><span class="token keyword">var</span></span> chatMsg <span class="token operator">=</span> msg<span class="token punctuation">.</span>Json<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ChatMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token string">&quot;Received &#39;{0}&#39; from &#39;{1}&#39;&quot;</span><span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>chatMsg<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> chatMsg<span class="token punctuation">.</span>FromName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Roughly translates to the equivalent JavaScript below:</p><div class="language-javascript"><pre><code><span class="token function">$</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleServerEvents</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  handlers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">chat</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Received &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>fromName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where both methods handle the <code>ChatMessage</code> sent with the <code>cmd.chat</code> selector.</p><h3 id="named-receivers" tabindex="-1">Named Receivers <a class="header-anchor" href="#named-receivers" aria-hidden="true">#</a></h3><p>Whilst handlers provide a light way to handle loose-typed messages, there&#39;s a more structured and typed option that works similar to ServiceStack&#39;s <code>IService</code> classes but are used to instead handle typed Server Event Messages.</p><p>To be able to handle messages with your own classes, get them to implement the <code>IReceiver</code> empty marker interface:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IReceiver</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NoSuchMethod</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Whilst primarily a marker interface, <code>IReceiver</code> does include a <code>NoSuchMethod</code> API to be able to handle messages sent with a unknown selector <strong>target</strong> that doesn&#39;t match any defined method or property.</p><p><strong>Named Receivers</strong> are equivalent to <a href="https://github.com/ServiceStackApps/Chat#receivers" target="_blank" rel="noopener noreferrer">Receivers</a> in the JavaScript client which can be assigned to handle all messages sent to a receiver with the selector format:</p><div class="language-"><pre><code>{receiver}.{target}
</code></pre></div><p>A Named Receiver can be registered with the API below:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterNamedReceiver</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestNamedReceiver<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which will forward all messages with a <code>test.*</code> selector to an instance of the <code>TestNamedReceiver</code> Type</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestNamedReceiver</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ServerEventReceiver</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FooMethod</span><span class="token punctuation">(</span><span class="token class-name">CustomType</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// void return type</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">CustomType</span> <span class="token function">BarMethod</span><span class="token punctuation">(</span><span class="token class-name">CustomType</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>        
        <span class="token keyword">return</span> request<span class="token punctuation">;</span> <span class="token comment">// works with any return type, which are ignored</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">CustomType</span> BazSetter <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// Auto populate properties</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NoSuchMethod</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> selector<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>ServerEventMessage<span class="token punctuation">)</span>message<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> nonExistentMethodType <span class="token operator">=</span> msg<span class="token punctuation">.</span>Json<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromJson</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomType<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This is roughly equivalent to the following JavaScript code:</p><div class="language-javascript"><pre><code><span class="token function">$</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleServerEvents</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    receivers<span class="token operator">:</span> <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">FooMethod</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">BarMethod</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            BazSetter<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>The <a href="https://github.com/ServiceStack/ServiceStack/blob/68c7159037e7cf2a519d482b7dae524ca073da20/src/ServiceStack.Client/ServerEventsClient.Receiver.cs#L16-L28" target="_blank" rel="noopener noreferrer">ServerEventReceiver</a> is a convenient base class that in addition to implementing <code>IReceiver</code> interface, gets injected with the <code>Client</code> as well as additional context about the raw message available in <code>base.Request</code>.</p></blockquote><h4 id="unknown-message-handling" tabindex="-1">Unknown Message Handling <a class="header-anchor" href="#unknown-message-handling" aria-hidden="true">#</a></h4><p>One difference in the JavaScript client is that messages with <strong>unknown</strong> targets are assigned as properties on the <code>test</code> receiver, e.g <code>test.QuxTarget = {..}</code>.</p><h3 id="sending-messages-to-named-receivers" tabindex="-1">Sending messages to Named Receivers <a class="header-anchor" href="#sending-messages-to-named-receivers" aria-hidden="true">#</a></h3><p>Once registered, an instance of <code>TestNamedReceiver</code> will process messages sent with a <code>test.*</code> selector. The example below shows how to send a DTO to each of <code>TestNamedReceiver</code> defined methods and properties:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEventServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IServerEvents</span> ServerEvents <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">CustomType</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test.FooMethod&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test.BarMethod&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test.BazSetter&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test.QuxTarget&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="life-cycle-of-receivers" tabindex="-1">Life-cycle of Receivers <a class="header-anchor" href="#life-cycle-of-receivers" aria-hidden="true">#</a></h3><p>Similar to <strong>Services</strong> in ServiceStack, each message is processed with an instance of the Receiver that&#39;s resolved from <code>ServerEventsClient.Resolver</code> which by default uses the <a href="https://github.com/ServiceStack/ServiceStack/blob/ec0226b97227048c3bd7c24667a71e7af7e1ff31/src/ServiceStack.Client/ServerEventsClient.Receiver.cs#L30-L36" target="_blank" rel="noopener noreferrer">NewInstanceResolver</a> to execute messages using a new instance of the Receiver Type:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewInstanceResolver</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IResolver</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateInstance</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This can be changed to re-use the same instance by assigning a <a href="https://github.com/ServiceStack/ServiceStack/blob/ec0226b97227048c3bd7c24667a71e7af7e1ff31/src/ServiceStack.Client/ServerEventsClient.Receiver.cs#L38-L46" target="_blank" rel="noopener noreferrer">SingletonInstanceResolver</a> instead:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonInstanceResolver</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IResolver</span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span>Type<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> Cache <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span>Type<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">TryResolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>Cache<span class="token punctuation">.</span><span class="token function">GetOrAdd</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            type <span class="token operator">=&gt;</span> type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateInstance</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

client<span class="token punctuation">.</span>Resolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SingletonInstanceResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can also have it resolve instances from your preferred IOC. Here&#39;s an example showing how to register all Receiver Types, auto-wire them with any custom dependencies, and instruct the client to resolve instances from our IOC:</p><div class="language-csharp"><pre><code><span class="token comment">// Register all Receivers:</span>
client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterNamedReceiver</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestNamedReceiver<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>

<span class="token comment">// Register all dependencies used in a new Funq.Container:</span>
<span class="token class-name"><span class="token keyword">var</span></span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterAs</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Dependency<span class="token punctuation">,</span> IDependency<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Go through an auto-wire all Registered Receiver Types with Funq:</span>
container<span class="token punctuation">.</span><span class="token function">RegisterAutoWiredTypes</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>ReceiverTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Change the client to resolve receivers from the new Funq Container:</span>
client<span class="token punctuation">.</span>Resolver <span class="token operator">=</span> container<span class="token punctuation">;</span>
</code></pre></div><p>We can assign <code>Funq.Container</code> directly as it already implements the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Configuration/IResolver.cs" target="_blank" rel="noopener noreferrer">IResolver</a> interface, whilst you can re-use the existing IOC <strong>Container Adapters</strong> to <a href="/ioc.html#use-another-ioc-container">enable support for other IOCs</a>.</p><h3 id="the-global-receiver" tabindex="-1">The Global Receiver <a class="header-anchor" href="#the-global-receiver" aria-hidden="true">#</a></h3><p>Whilst Named Receivers are used to handle messages sent to a specific namespaced selector, the client also supports registering a <strong>Global Receiver</strong> for handling messages sent with the special <code>cmd.*</code> selector.</p><h4 id="handling-messages-with-the-default-selector" tabindex="-1">Handling Messages with the Default Selector <a class="header-anchor" href="#handling-messages-with-the-default-selector" aria-hidden="true">#</a></h4><p>All <code>IServerEvents</code> Notify API&#39;s inlcudes <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/ServerEventsFeature.cs#L743-L771" target="_blank" rel="noopener noreferrer">overloads for sending messages without a selector</a> that by convention will take the format <code>cmd.{TypeName}</code>.</p><p>These events can be handled with a Global Receiver <strong>based on Message type</strong>, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalReceiver</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ServerEventReceiver</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">SetterType</span> AnyNamedProperty <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AnyNamedMethod</span><span class="token punctuation">(</span><span class="token class-name">CustomType</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterReceiver</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GlobalReceiver<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which will be called when messages are sent without a selector, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IServerEvents</span> ServerEvents <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CustomType</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span><span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SetterType</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As Global Receivers handle other messages sent with the <code>cmd.*</code> selector and can be re-used as a named receiver, we can define a single class to handle all the different custom messages sent in <a href="http://chat.netcore.io" target="_blank" rel="noopener noreferrer">chat.netcore.io</a> App, E.g:</p><div class="language-"><pre><code>cmd.chat Hi
cmd.announce This is your captain speaking...
cmd.toggle#channels
css.background-image url(https://servicestack.net/img/bg.jpg)
...
</code></pre></div><p>The above messages can all be handled with the Receiver below:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaScriptReceiver</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ServerEventReceiver</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Chat</span><span class="token punctuation">(</span><span class="token class-name">ChatMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Announce</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Toggle</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BackgroundImage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> cssRule<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterReceiver</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JavaScriptReceiver<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterNamedReceiver</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JavaScriptReceiver<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As seen above the <strong>target</strong> names are <strong>case-insensitive</strong> and <code>-</code> are collapsed to cater for JavaScript/CSS naming conventions.</p><h2 id="event-triggers" tabindex="-1">Event Triggers <a class="header-anchor" href="#event-triggers" aria-hidden="true">#</a></h2><p>Triggers enable a pub/sub event model where multiple listeners can subscribe and be notified of an event.</p><p>Registering an event handler can be done at anytime using the <code>addListener()</code> API, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name">Action<span class="token punctuation">&lt;</span>ServerEventMessage<span class="token punctuation">&gt;</span></span> handler <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;received event $</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">msg<span class="token punctuation">.</span>Target</span><span class="token punctuation">}</span></span><span class="token string"> with arg: $</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">msg<span class="token punctuation">.</span>Json</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> channels<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token string">&quot;customEvent&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Register another listener to &#39;customEvent&#39; event</span>
client<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token string">&quot;customEvent&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The selector to trigger this custom event is:</p><div class="language-"><pre><code>trigger.customEvent arg
trigger.customEvent {json}
</code></pre></div><p>Which can be sent in ServiceStack with a simple or complex type argument, e.g:</p><div class="language-csharp"><pre><code>ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;trigger.customEvent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;arg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ServerEvents<span class="token punctuation">.</span><span class="token function">NotifyChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;trigger.customEvent&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ChatMessage</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="removing-listeners" tabindex="-1">Removing Listeners <a class="header-anchor" href="#removing-listeners" aria-hidden="true">#</a></h4><p>Use <code>RemoveListener()</code> to stop listening for an event, e.g:</p><div class="language-csharp"><pre><code><span class="token comment">//Remove first event listener</span>
client<span class="token punctuation">.</span><span class="token function">RemoveListener</span><span class="token punctuation">(</span><span class="token string">&quot;customEvent&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="channel-subscriber-apis" tabindex="-1">Channel Subscriber APIs <a class="header-anchor" href="#channel-subscriber-apis" aria-hidden="true">#</a></h2><p>The sync/async APIs below built into the C# <code>ServerEventsClient</code> will let you modify an active Server Events subscription to join new or leave existing channels:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span><span class="token function">UpdateSubscriber</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateEventSubscriber</span> <span class="token punctuation">{</span> 
    SubscribeChannels <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token string">&quot;chan1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    UnsubscribeChannels <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token string">&quot;chan3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan4&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">SubscribeToChannels</span><span class="token punctuation">(</span><span class="token string">&quot;chan1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">UnsubscribeFromChannels</span><span class="token punctuation">(</span><span class="token string">&quot;chan3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">SubscribeToChannelsAsync</span><span class="token punctuation">(</span><span class="token string">&quot;chan1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">UnsubscribeFromChannelsAsync</span><span class="token punctuation">(</span><span class="token string">&quot;chan3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chan4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="onupdate-notification" tabindex="-1">onUpdate Notification <a class="header-anchor" href="#onupdate-notification" aria-hidden="true">#</a></h3><p>As this modifies the active subscription it also publishes a new <strong>onUpdate</strong> notification to all channel subscribers so they&#39;re able to maintain up-to-date info on each subscriber. This can be handled together with <strong>onJoin</strong> and <strong>onLeave</strong> events using <code>OnCommand</code>:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span>OnCommand <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">//= ServerEventJoin, ServerEventLeave or ServerEventUpdate</span>
</code></pre></div><h2 id="add-authentication-support-to-net-serverevents-client" tabindex="-1">Add Authentication support to .NET ServerEvents Client <a class="header-anchor" href="#add-authentication-support-to-net-serverevents-client" aria-hidden="true">#</a></h2><p>The explicit <code>Authenticate</code> and <code>AuthenticateAsync</code> API&#39;s can be used to authenticate the ServerEvents ServiceClient which <strong>shares cookies</strong> with the WebRequest that connects to the <code>/event-stream</code> so authenticating with the Server Events ServiceClient will also authenticate the <code>/event-stream</code> HTTP Connection:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span><span class="token function">Authenticate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Authenticate</span> <span class="token punctuation">{</span>
    provider <span class="token operator">=</span> CredentialsAuthProvider<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
    UserName <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
    Password <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">,</span>
    RememberMe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This is equivalent to:</p><div class="language-csharp"><pre><code>client<span class="token punctuation">.</span>ServiceClient<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Authenticate</span> <span class="token punctuation">{</span>
    provider <span class="token operator">=</span> CredentialsAuthProvider<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
    UserName <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
    Password <span class="token operator">=</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">,</span>
    RememberMe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="custom-authentication" tabindex="-1">Custom Authentication <a class="header-anchor" href="#custom-authentication" aria-hidden="true">#</a></h2><p>When using a <a href="/jwt-authprovider.html">JWT</a> or <a href="/api-key-authprovider.html">API Key</a> AuthProvider you can <a href="/jwt-authprovider.html#sending-jwt-using-cookies">send it inside a Cookie</a> so it gets sent with client Web Requests. Otherwise you can add the JWT Token or API Key using the <code>EventStreamRequestFilter</code> which gets executed before establishing the Server Events connection, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EventStreamRequestFilter <span class="token operator">=</span> req <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span><span class="token function">AddBearerToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Alternatively you can use <code>ResolveStreamUrl</code> which will let you modify the URL used to establish the Server Events connection which will also allow you to add the JWT Token to the QueryString as, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sseClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerEventsClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">,</span> channels<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    ResolveStreamUrl <span class="token operator">=</span> url <span class="token operator">=&gt;</span> url<span class="token punctuation">.</span><span class="token function">AddQueryParam</span><span class="token punctuation">(</span><span class="token string">&quot;ss-tok&quot;</span><span class="token punctuation">,</span> JWT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    OnConnect <span class="token operator">=</span> e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>IsAuthenticated</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>UserId</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>DisplayName</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This requires that your JWT AuthProvider to accept JWT Tokens via the QueryString which you can enable in ServiceStack&#39;s JWT AuthProvider with:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtAuthProvider</span> <span class="token punctuation">{</span>
    AllowInQueryString <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To configure API Key AuthProvider to accept API Key in Request Params like QueryString or FormData:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ApiKeyAuthProvider</span> <span class="token punctuation">{</span>
    AllowInHttpParams <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-hidden="true">#</a></h2><p>The Server Events Client uses .NET&#39;s <code>HttpWebRequest</code> internally for its long-running SSE connection and periodic heartbeats where if you&#39;re also using other .NET ServiceClients to make API requests back to the same server you&#39;ll quickly hit its default limit (2) on number of requests allowed for a single domain which can be increased by changing <a href="https://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.defaultconnectionlimit(v=vs.110).aspx" target="_blank" rel="noopener noreferrer">ServicePointManager.DefaultConnectionLimit</a>, e.g:</p><div class="language-csharp"><pre><code>ServicePointManager<span class="token punctuation">.</span>DefaultConnectionLimit <span class="token operator">=</span> maxNumOfConcurrentConnections<span class="token punctuation">;</span>
</code></pre></div><h1 id="serverevent-net-examples" tabindex="-1">ServerEvent .NET Examples <a class="header-anchor" href="#serverevent-net-examples" aria-hidden="true">#</a></h1><h2 id="xamarin-android-chat" tabindex="-1"><a href="https://github.com/ServiceStackApps/AndroidXamarinChat" target="_blank" rel="noopener noreferrer">Xamarin.Android Chat</a> <a class="header-anchor" href="#xamarin-android-chat" aria-hidden="true">#</a></h2><p>Xamarin.Android Chat utilizes the <a href="/csharp-server-events-client.html">.NET PCL Server Events Client</a> to create an Android Chat App connecting to the existing <a href="http://chat.netcore.io/" target="_blank" rel="noopener noreferrer">chat.netcore.io</a> Server Events back-end where it&#39;s able to communicate with existing Ajax clients and other connected Android Chat Apps.</p><p><a href="https://www.youtube.com/watch?v=tImAm2LURu0" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/livedemos/xamarin-android-server-events.png" alt=""></a></p><blockquote><p><a href="https://www.youtube.com/watch?v=tImAm2LURu0" target="_blank" rel="noopener noreferrer">YouTube Video</a> and <a href="https://github.com/ServiceStackApps/AndroidXamarinChat" target="_blank" rel="noopener noreferrer">AndroidXamarinChat Repo</a></p></blockquote>`,108),r=[c,i,l];function u(k,d,h,g,v,m){return t(),e("div",null,r)}var w=a(p,[["render",u]]);export{f as __pageData,w as default};
