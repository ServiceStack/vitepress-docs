import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const g='{"title":"Background MQ Service","description":"","frontmatter":{"slug":"background-mq","title":"Background MQ Service"},"headers":[{"level":3,"title":"Using Background Service to send Emails","slug":"using-background-service-to-send-emails"},{"level":3,"title":"Replaying Messages","slug":"replaying-messages"},{"level":3,"title":"MQ Status","slug":"mq-status"},{"level":3,"title":"MQ Collection Stats","slug":"mq-collection-stats"}],"relativePath":"background-mq.md","lastUpdated":1634495307614}',e={},p=t(`__VP_STATIC_START__<p>The <code>BackgroundMqService</code> is a full-featured <code>IMessageService</code> implementation that provides the functionality of <a href="/messaging.html">distributed MQ Server</a> but doesn&#39;t require any infrastructure dependencies. It&#39;s ideal for <strong>queueing long-running background tasks</strong> by publishing Request DTOs, control execution throughput by creating different sized Thread Pools per message type, inspect the status and statistics of different MQ Workers, stop and restart processing messages, etc. It&#39;s a complete implementation implementing the same <a href="/messaging.html#message-workflow">MQ Message flow</a> and passes the existing MQ Test suites so you&#39;ll be able to substitute it for any of the other MQ Servers. But it still doesn&#39;t persist messages across App restarts so we recommend using it in combination with persistence to an external data source - generally a good idea for tracking the status of long-running jobs.</p><p>To illustrate an example we&#39;ll walkthrough TechStacks implementation of what&#39;s likely the most popular use of background job in Web Apps - sending emails...</p><h3 id="using-background-service-to-send-emails" tabindex="-1">Using Background Service to send Emails <a class="header-anchor" href="#using-background-service-to-send-emails" aria-hidden="true">#</a></h3><p>Configuring the <code>BackgroundMqService</code> is the same as every other MQ Server, i.e. register it in the IOC and register handlers for the Request DTO of each Service you want to be able to run in the background:</p><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMessageService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BackgroundMqService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> mqServer <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMessageService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mqServer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SendNotification<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ExecuteMessage<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mqServer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SendSystemEmail<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ExecuteMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

AfterInitCallbacks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>host <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    mqServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ExecuteService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetryPendingNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The one difference is that we also register an <code>AfterInitCallbacks</code> to Execute the <a href="https://github.com/NetCoreApps/TechStacks/blob/c89920d92e1e11a5495bf88a45fea60aea9d199e/src/TechStacks.ServiceInterface/Admin/NotificationServices.cs#L51" target="_blank" rel="noopener noreferrer">RetryPendingNotifications</a> Service after the AppHost has started. We&#39;ll look at the implementation later, but it&#39;s for re-queueing any incomplete Background Jobs that failed to complete.</p><p>With the handlers registered, any Service can queue any of these Services to Execute in the background by publishing a populated Request DTO of that Type. One place where TechStacks does this is to notify all subscribers when someone creates a post, which it does by <a href="https://github.com/NetCoreApps/TechStacks/blob/973eecdc334687e13008aa9f07444e7c6affcfd9/src/TechStacks.ServiceInterface/PostServices.cs#L62" target="_blank" rel="noopener noreferrer">calling SendNotificationAsync()</a>:</p><div class="language-csharp"><pre><code><span class="token keyword">await</span> <span class="token function">SendNotificationAsync</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>CreatePost<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>A common API that inserts an entry in the <code>Notification</code> table and publishes a <code>SendNotification</code> message to have the Service executed in the background by 1 of the 4 MQ Workers configured at Startup:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendNotificationAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> eventName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> refType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">long</span></span> refId<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> notificationId <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span><span class="token function">ToNotification</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> refType<span class="token punctuation">,</span> refId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">selectIdentity</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PublishMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SendNotification</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> notificationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">Notification</span> <span class="token function">ToNotification</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> eventName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> refType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">long</span></span> refId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Notification</span> <span class="token punctuation">{</span>
    Event <span class="token operator">=</span> eventName<span class="token punctuation">,</span>
    RefId <span class="token operator">=</span> refId<span class="token punctuation">,</span>
    RefType <span class="token operator">=</span> refType<span class="token punctuation">,</span>
    RefUrn <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;urn:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">refType</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">refId</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
    Created <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre></div><p><code>SendNotification</code> is a regular ServiceStack Service except we only want it accessible to Admin Users so it&#39;s annotated with <code>[ExcludeMetadata]</code> to hide it from the public metadata services.</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ExcludeMetadata</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/notifications/{Id}/send&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendNotification</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturnVoid</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For the complete reference <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks.ServiceInterface/Admin/NotificationServices.cs" target="_blank" rel="noopener noreferrer">NotificationServices.cs</a> contains all the background Email Services and bespoke code to send the different Email types whilst <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks.ServiceInterface/Admin/NotificationServices.Utils.cs" target="_blank" rel="noopener noreferrer">NotificationServices.Utils.cs</a> contains reusable functionality shared by the different email implementations.</p><p>The <code>SendNotification</code> Service sends a different Email based on the Notification Event Type which are all executed within the same managed implementation below where it takes care of marking the completion of the notification, either with the time it successfully completed or the Exception the notification it failed with:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequiredRole</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">NotificationServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ILog</span> log <span class="token operator">=</span> LogManager<span class="token punctuation">.</span><span class="token function">GetLogger</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">NotificationServices</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>Notification<span class="token punctuation">,</span> Task<span class="token punctuation">&gt;</span></span> <span class="token function">GetEventHandler</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> eventName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventName<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>CreatePost<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> SendNewPostEmail<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>UserPostReport<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> SendReportPostEmail<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>UserPostCommentReport<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> SendReportCommentEmail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">SendNotification</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> notification <span class="token operator">=</span> <span class="token function">AssertNotification</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> eventHandler <span class="token operator">=</span> <span class="token function">GetEventHandler</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> <span class="token function">eventHandler</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token function">UpdateOnlyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Notification</span> <span class="token punctuation">{</span>
                        Completed <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">where</span><span class="token punctuation">:</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id <span class="token operator">==</span> notification<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token function">UpdateOnlyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Notification</span> <span class="token punctuation">{</span>
                        Failed <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>
                        Error <span class="token operator">=</span> ex<span class="token punctuation">.</span>Message <span class="token operator">+</span> Environment<span class="token punctuation">.</span>NewLine <span class="token operator">+</span> ex
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">where</span><span class="token punctuation">:</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id <span class="token operator">==</span> notification<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Received notification of unknown Event Type: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">notification<span class="token punctuation">.</span>Event</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The creation of Email Template is split into different steps to ensure all users are sent the same rendered Email snapshot, even if the task failed midway through and had to be replayed.</p><p>Each template follows the same approach:</p><ul><li><p>Work out all users the email should be sent to</p></li><li><p>Retrieve all data required by the template and inject it into a new <a href="https://sharpscript.net/docs/installation" target="_blank" rel="noopener noreferrer">ServiceStack ScriptContext</a></p></li><li><p>Use the context to render the specified <a href="https://github.com/NetCoreApps/TechStacks/tree/master/src/TechStacks/emails" target="_blank" rel="noopener noreferrer">email template</a>.</p></li></ul><p>In this case it renders the <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks/emails/post-new.html" target="_blank" rel="noopener noreferrer">post-new.html</a> Template inside the <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks/emails/_layout.html" target="_blank" rel="noopener noreferrer">_layout.html</a> - which is based on the <a href="https://github.com/seanpowell/Email-Boilerplate/blob/master/email_commentsremoved.html" target="_blank" rel="noopener noreferrer">Email Bootstrap Template</a> and used as the layout for all email templates.</p><div class="language-csharp"><pre><code><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendNewPostEmail</span><span class="token punctuation">(</span><span class="token class-name">Notification</span> notification<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">EmailTemplate</span> template <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>notification<span class="token punctuation">.</span>EmailTemplateId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> post <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">AssertPost</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>RefId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> org <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Organization<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>OrganizationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomUserAuth<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> q <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrganizationSubscription<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>OrganizationId <span class="token operator">==</span> post<span class="token punctuation">.</span>OrganizationId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token string">&quot;ARRAY[{0}] &amp;&amp; post_types&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> postTypeSubscriberUserIds <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ColumnAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token function">CreateEmailTemplateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> templatePath <span class="token operator">=</span> <span class="token string">&quot;emails/post-new&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> page <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetPage</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PageResult</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Args <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token punctuation">[</span><span class="token string">&quot;baseUrl&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> AppSettings<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;PublicBaseUrl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> post<span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">&quot;organization&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> org<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        template <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">CreateAndSaveEmailTemplate</span><span class="token punctuation">(</span>notification<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>SendNewPostEmail<span class="token punctuation">)</span><span class="token punctuation">,</span> templatePath<span class="token punctuation">,</span> 
            <span class="token named-parameter punctuation">toUserIds</span><span class="token punctuation">:</span> postTypeSubscriberUserIds<span class="token punctuation">,</span> 
            <span class="token named-parameter punctuation">fromName</span><span class="token punctuation">:</span>  user<span class="token punctuation">.</span>DisplayName <span class="token operator">??</span> user<span class="token punctuation">.</span>UserName<span class="token punctuation">,</span> 
            <span class="token named-parameter punctuation">ccName</span><span class="token punctuation">:</span>    org<span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">&quot; Subscribed&quot;</span><span class="token punctuation">,</span> 
            <span class="token named-parameter punctuation">subject</span><span class="token punctuation">:</span>   <span class="token interpolation-string"><span class="token string">$&quot;[</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">post<span class="token punctuation">.</span>Type</span><span class="token punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">post<span class="token punctuation">.</span>Title</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> 
            <span class="token named-parameter punctuation">html</span><span class="token punctuation">:</span>      <span class="token keyword">await</span> result<span class="token punctuation">.</span><span class="token function">RenderToStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        template <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SingleByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EmailTemplate<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>EmailTemplateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> <span class="token function">SendEmailsToRemainingUsers</span><span class="token punctuation">(</span>notification<span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The end result of each email is to create an entry in the generic <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks.ServiceInterface/DataModel/EmailTemplate.cs" target="_blank" rel="noopener noreferrer">EmailTemplate</a> table with the rendered email to send and all users to send it to. It&#39;s then handed to the managed <code>SendEmailsToRemainingUsers</code> routine to send the emails.</p><p>The final step is to send the email to all designated users, which is ultimately done by the <a href="https://github.com/NetCoreApps/TechStacks/blob/master/src/TechStacks.ServiceInterface/Notifications/EmailProvider.cs" target="_blank" rel="noopener noreferrer">EmailProvider</a> which uses an <code>SmtpClient</code> to send the Email to the AWS SES endpoint.</p><p>To handle cases where the long-running process can fail at any point, the email template keeps a record of each user that emails were sent to by updating the <code>emailed_user_ids</code> PostgreSQL Array after each email is sent. So if the <code>SendNotification</code> message is replayed it will start back where it left off and only sends emails to the remaining users.</p><div class="language-csharp"><pre><code><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendEmailsToRemainingUsers</span><span class="token punctuation">(</span><span class="token class-name">Notification</span> notification<span class="token punctuation">,</span> <span class="token class-name">EmailTemplate</span> template<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> remainingUserIds <span class="token operator">=</span> notification<span class="token punctuation">.</span>UserIds<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token operator">!</span>notification<span class="token punctuation">.</span>EmailedUserIds<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingUserIds<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> users <span class="token operator">=</span> <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserEmailInfo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomUserAuth<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> remainingUserIds<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> userMap <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">ToDictionary</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> userId <span class="token keyword">in</span> remainingUserIds<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> userMap<span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Email<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">ToEmailMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> user<span class="token punctuation">.</span>DisplayName <span class="token operator">??</span> user<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">await</span> <span class="token function">RecordEmailSentToUser</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">SendNotificationEmail</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">notification<span class="token punctuation">.</span>UserIds<span class="token punctuation">.</span>Length</span><span class="token punctuation">}</span></span><span class="token string"> subscribers&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SendNotificationEmail</span><span class="token punctuation">(</span><span class="token class-name">EmailTemplate</span> template<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> toName<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> notificationsEmail <span class="token operator">=</span> AppSettings<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;NotificationsFromEmail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> email <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">ToEmailMessage</span><span class="token punctuation">(</span>notificationsEmail<span class="token punctuation">,</span> toName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Email<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RecordEmailSentToUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">long</span></span> notificationId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> Db<span class="token punctuation">.</span><span class="token function">ExecuteSqlAsync</span><span class="token punctuation">(</span><span class="token string">@&quot;UPDATE notification SET emailed_user_ids = emailed_user_ids || @userId
        WHERE id = @id&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> userId<span class="token punctuation">,</span> id <span class="token operator">=</span> notificationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="replaying-messages" tabindex="-1">Replaying Messages <a class="header-anchor" href="#replaying-messages" aria-hidden="true">#</a></h3><p>The <code>RetryPendingNotifications</code> Service replays incomplete notifications by publishing new <code>SendNotification</code> messages which are executed by the <code>BackgroundMqService</code> as normal. This also lets you replay failed notifications by setting <code>Failed</code> to <code>null</code> and recalling the Service. As the state of each task is persisted after each step, it can fail at any point and the replayed task will be able to restart where it left off.</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">RetryPendingNotifications</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> pendingNotificationIds <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Column</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">From</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Notification<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Completed <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Failed <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingNotificationIds<span class="token punctuation">.</span>Length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Resending </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">pendingNotificationIds<span class="token punctuation">.</span>Length</span><span class="token punctuation">}</span></span><span class="token string"> pending notifications: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">pendingNotificationIds</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> notificationId <span class="token keyword">in</span> pendingNotificationIds<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">PublishMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SendNotification</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> notificationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetryPendingNotificationsResponse</span> <span class="token punctuation">{</span>
        ResentIds <span class="token operator">=</span> pendingNotificationIds
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mq-status" tabindex="-1">MQ Status <a class="header-anchor" href="#mq-status" aria-hidden="true">#</a></h3><p>The other benefit from persisting the status of each tasks is being able to inspect the <code>Notification</code> and <code>EmailTemplate</code> table to be able to monitor the progress of each Task.</p><p>We can also call the <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Messaging/IMessageService.cs" target="_blank" rel="noopener noreferrer">IMessageService</a> APIs to inspect the state of the Background MQ Service. We can use the Service below to make the APIs accessible remotely:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/mq/stop&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>  <span class="token comment">// Stop the Background Service and all MQ Workers from processing more messages</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqStop</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/mq/start&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Start the Background Service and process any queued messages</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqStart</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/mq/stats&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqStats</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/mq/status&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqStatus</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackgroundAdminServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IMessageService</span> MqService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequiredRole</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">MqStart</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MqService<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequiredRole</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">MqStop</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MqService<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">MqStats</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> MqService<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AddHeader</span><span class="token attribute-arguments"><span class="token punctuation">(</span>ContentType <span class="token operator">=</span> MimeTypes<span class="token punctuation">.</span>PlainText<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">MqStatus</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> MqService<span class="token punctuation">.</span><span class="token function">GetStatsDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This lets you can call <a href="https://techstacks.io/mq/stats.json" target="_blank" rel="noopener noreferrer">/mq/stats</a> to view a summary of <strong>all messages processed</strong> since the last time the App was restarted and <a href="https://techstacks.io/mq/status" target="_blank" rel="noopener noreferrer">/mq/status</a> to view <strong>all Queues</strong> the Background Service is currently listening to and the <strong>statistics of each individual MQ worker</strong>.</p><p>Here&#39;s a snapshot of what this looks like for TechStacks with 4 threads listening to <code>SendNotification</code> messages and 1 thread listening to <code>SendSystemEmail</code>:</p><div class="language-"><pre><code># MQ SERVER STATS:

STATUS: Started

LISTENING ON: 
  mq:SendNotification.inq
  mq:SendNotification.inq
  mq:SendNotification.inq
  mq:SendNotification.inq
  mq:SendSystemEmail.inq

------------------------------

# COLLECTIONS:

------------------------------
INFO SendNotification:

STATS:
  Thread Count:         4
  Total Messages Added: 27
  Total Messages Taken: 0
  Total .outq Messages: 27
  Total .dlq Messages:  0
QUEUES:
  mq:SendNotification.inq:        0 message(s)
  mq:SendNotification.priorityq:  0 message(s)
  mq:SendNotification.dlq:        0 message(s)
  mq:SendNotification.outq:       27 message(s)
------------------------------
INFO SendSystemEmail:

STATS:
  Thread Count:         1
  Total Messages Added: 1
  Total Messages Taken: 0
  Total .outq Messages: 1
  Total .dlq Messages:  0
QUEUES:
  mq:SendSystemEmail.inq:         0 message(s)
  mq:SendSystemEmail.priorityq:   0 message(s)
  mq:SendSystemEmail.dlq:         0 message(s)
  mq:SendSystemEmail.outq:        1 message(s)
------------------------------

# WORKERS:

------------------------------
WORKER 1 on mq:SendNotification.inq 
STATS for SendNotification:

  TotalNormalMessagesReceived:    7
  TotalPriorityMessagesReceived:  0
  TotalProcessed:                 7
  TotalRetries:                   0
  TotalFailed:                    0
  LastMessageProcessed:           4/9/18 7:44:49 PM
------------------------------
WORKER 2 on mq:SendNotification.inq 
STATS for SendNotification:

  TotalNormalMessagesReceived:    7
  TotalPriorityMessagesReceived:  0
  TotalProcessed:                 7
  TotalRetries:                   0
  TotalFailed:                    0
  LastMessageProcessed:           4/9/18 7:49:17 PM
------------------------------
WORKER 3 on mq:SendNotification.inq 
STATS for SendNotification:

  TotalNormalMessagesReceived:    7
  TotalPriorityMessagesReceived:  0
  TotalProcessed:                 7
  TotalRetries:                   0
  TotalFailed:                    0
  LastMessageProcessed:           4/9/18 8:28:59 PM
------------------------------
WORKER 4 on mq:SendNotification.inq 
STATS for SendNotification:

  TotalNormalMessagesReceived:    6
  TotalPriorityMessagesReceived:  0
  TotalProcessed:                 6
  TotalRetries:                   0
  TotalFailed:                    0
  LastMessageProcessed:           4/9/18 7:41:18 PM
------------------------------
WORKER 5 on mq:SendSystemEmail.inq 
STATS for SendSystemEmail:

  TotalNormalMessagesReceived:    1
  TotalPriorityMessagesReceived:  0
  TotalProcessed:                 1
  TotalRetries:                   0
  TotalFailed:                    0
  LastMessageProcessed:           4/9/18 7:44:47 PM
------------------------------
</code></pre></div><h3 id="mq-collection-stats" tabindex="-1">MQ Collection Stats <a class="header-anchor" href="#mq-collection-stats" aria-hidden="true">#</a></h3><p>You can also get info on the Queue Collection for a specific DTO Type with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> bgService <span class="token operator">=</span> <span class="token punctuation">(</span>BackgroundMqService<span class="token punctuation">)</span>HostContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMessageService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> mqCollection <span class="token operator">=</span> bgService<span class="token punctuation">.</span><span class="token function">GetCollection</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Poco</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">&gt;</span></span> statsMap <span class="token operator">=</span> mqCollection<span class="token punctuation">.</span><span class="token function">GetDescriptionMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which returns the text info that [mqCollection.GetDescription()][/background-mq#mq-status] returns, but in a structured Dictionary using the keys:</p><ul><li><code>ThreadCount</code></li><li><code>TotalMessagesAdded</code></li><li><code>TotalMessagesTaken</code></li><li><code>TotalOutQMessagesAdded</code></li><li><code>TotalDlQMessagesAdded</code></li></ul><p>The dictionary also includes each the snapshot counts of each queue in the MQ Collection, e.g:</p><ul><li><code>mq:Poco.inq</code></li><li><code>mq:Poco.priorityq</code></li><li><code>mq:Poco.outq</code></li><li><code>mq:Poco.dlq</code></li></ul><p>You can also get the Stats of each MQ Worker, or if you have multiple workers for a Request Type you can access them with:</p><div class="language-csharp"><pre><code><span class="token class-name">IMqWorker<span class="token punctuation">[</span><span class="token punctuation">]</span></span> workers <span class="token operator">=</span> bgService<span class="token punctuation">.</span><span class="token function">GetWorkers</span><span class="token punctuation">(</span>QueueNames<span class="token operator">&lt;</span>Type<span class="token operator">&gt;</span><span class="token punctuation">.</span>In<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>IMessageHandlerStats<span class="token punctuation">&gt;</span></span> stats <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then combine them to get their cumulative result:</p><div class="language-csharp"><pre><code><span class="token class-name">IMessageHandlerStats</span> combinedStats <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">CombineStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>__VP_STATIC_END__`,45),o=[p];function c(l,i,u,k,r,d){return a(),s("div",null,o)}var f=n(e,[["render",c]]);export{g as __pageData,f as default};
