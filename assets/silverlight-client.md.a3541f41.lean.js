import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const m='{"title":"Silverlight Client","description":"","frontmatter":{"slug":"silverlight-client","title":"Silverlight Client"},"headers":[{"level":2,"title":"HelloMobile","slug":"hellomobile"},{"level":3,"title":"Building Silverlight JSON Service Client from Scratch","slug":"building-silverlight-json-service-client-from-scratch"},{"level":2,"title":"Please be aware of the following considerations:","slug":"please-be-aware-of-the-following-considerations"},{"level":3,"title":"Uses HttpWebRequest with ClientHttp handling","slug":"uses-httpwebrequest-with-clienthttp-handling"},{"level":3,"title":"Is Cookie-Aware","slug":"is-cookie-aware"},{"level":3,"title":"Talks only JSON","slug":"talks-only-json"},{"level":2,"title":"Example Usage","slug":"example-usage"},{"level":3,"title":"Setting up your DTOs","slug":"setting-up-your-dtos"},{"level":3,"title":"The ServiceClient Implementation","slug":"the-serviceclient-implementation"}],"relativePath":"silverlight-client.md","lastUpdated":1634495308446}',e={},p=t(`__VP_STATIC_START__<p>The <strong>recommended</strong> way to get Silverlight builds of ServiceStack client libraries is from <a href="https://nuget.org/packages/ServiceStack.Client.Silverlight" target="_blank" rel="noopener noreferrer">NuGet</a>:</p><p><a href="https://nuget.org/packages/ServiceStack.Client" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/wikis/nuget-servicestack.client.silverlight.png" alt="ServiceStack Silverlight Client on NuGet"></a></p><p>These binaries are custom builds of the full ServiceStack Service Clients providing JSON, JSV and XML ServiceClients.</p><h4 id="requires-pcl-support-in-v4-x-servicestack-client-nuget-package" tabindex="-1">Requires PCL support in v4.x <a href="https://nuget.org/packages/ServiceStack.Client" target="_blank" rel="noopener noreferrer">ServiceStack.Client</a> NuGet package. <a class="header-anchor" href="#requires-pcl-support-in-v4-x-servicestack-client-nuget-package" aria-hidden="true">#</a></h4><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Due to restrictions in Silverlight only the Async operations are supported.</p></div><h2 id="hellomobile" tabindex="-1"><a href="https://github.com/ServiceStackApps/HelloMobile" target="_blank" rel="noopener noreferrer">HelloMobile</a> <a class="header-anchor" href="#hellomobile" aria-hidden="true">#</a></h2><p>See the <a href="https://github.com/ServiceStackApps/HelloMobile" target="_blank" rel="noopener noreferrer">HelloMobile</a> project for more info on ServiceStack&#39;s Silverlight and PCL client support including showing re-use of shared libraries between each of the different mobile platforms.</p><hr><h3 id="building-silverlight-json-service-client-from-scratch" tabindex="-1">Building Silverlight JSON Service Client from Scratch <a class="header-anchor" href="#building-silverlight-json-service-client-from-scratch" aria-hidden="true">#</a></h3><p>Although it is recommended to use the published binaries above, for illustrative purposes, this section below walks through creating a Silverlight client from scratch. This example below shows how to create a JSON ServiceClient.</p><p><em>Note: The code below has been tested in Silverlight 5. It should work fine in other versions of Silverlight as well.</em></p><h2 id="please-be-aware-of-the-following-considerations" tabindex="-1">Please be aware of the following considerations: <a class="header-anchor" href="#please-be-aware-of-the-following-considerations" aria-hidden="true">#</a></h2><h3 id="uses-httpwebrequest-with-clienthttp-handling" tabindex="-1">Uses HttpWebRequest with ClientHttp handling <a class="header-anchor" href="#uses-httpwebrequest-with-clienthttp-handling" aria-hidden="true">#</a></h3><p>The <a href="http://www.silverlight.net/learn/data-networking/network-services-%28soap,-rest-and-more%29/rest-services-%28silverlight-quickstart%29" target="_blank" rel="noopener noreferrer">Silverlight REST Services Quickstart</a> describes the different mechanisms of how http calls can be made from Silverlight. There is the easier-but-heavier WebClient implementation, and the lighter-but-harder HttpWebRequest implementation. The code below uses the HttpWebRequest implementation, primarily because you cannot manipulate cookies with the WebClient version, but also because it provides better hooks for serializing and deserializing the JSON we want to send to our ServiceStack service.</p><p>It also uses the ClientHttp handling instead of BrowserHttp handling. <a href="http://msdn.microsoft.com/en-us/library/dd920295%28VS.95%29.aspx" target="_blank" rel="noopener noreferrer">See the differences here.</a></p><p>You may need to put a clientaccesspolicy.xml file in the root of your host. It depends on the domains of the host and client, and the trust level of the particular Silverlight client application (differs between out-of-browser and between Silverlight versions). <a href="http://msdn.microsoft.com/en-us/library/cc645032%28v=VS.95%29.aspx" target="_blank" rel="noopener noreferrer">See MSDN documentation for more info.</a></p><h3 id="is-cookie-aware" tabindex="-1">Is Cookie-Aware <a class="header-anchor" href="#is-cookie-aware" aria-hidden="true">#</a></h3><p>In the code below, you will see how cookies can be enabled or disabled. Because we are using ClientHttp handling, when cookies are enabled, we have to create a custom CookieContainer.</p><p>In order to share these cookies with the browser, we are populating from HtmlPage.Document.Cookies before the request, and then setting the cookies back to the browser after getting a response. This technique allows things like ServiceStack&#39;s built-in authentication to work, even if you authenticate in the browser before launching your Silverlight app.</p><p>If you don&#39;t want to share cookies with the browser, you can set EnableCookies = false, or you can modify the code to persist the CookieContainer in some other way.</p><h3 id="talks-only-json" tabindex="-1">Talks only JSON <a class="header-anchor" href="#talks-only-json" aria-hidden="true">#</a></h3><p>The request and response streams are assumed to be JSON, and the Accept and Content-Type headers are set accordingly. If you want to implement xml or jsv, you will have to adjust the headers and the content appropriately.</p><h5 id="using-the-datacontractjsonserializer" tabindex="-1">Using the DataContractJsonSerializer <a class="header-anchor" href="#using-the-datacontractjsonserializer" aria-hidden="true">#</a></h5><p>The only JSON serializer that comes with Silverlight is the <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.json.datacontractjsonserializer%28v=vs.95%29.aspx" target="_blank" rel="noopener noreferrer">DataContractJsonSerializer</a>. While not as performant as ServiceStack&#39;s serializers, performance on the client usually tends not to be as important as on the server (due to load).</p><p>Note that if you decide to apply a [DataContract] attribute to your DTO that you must specifically mark all members that you want to serialize with [DataMember]. If you leave them off, all public members will be serialized.</p><p>The code below uses this serializer by default. If you use it, be aware that there is a bug in the DataContractJsonSerializer related to handling of dates that are not of type DateTimeKind.Local. <a href="http://connect.microsoft.com/VisualStudio/feedback/details/723368" target="_blank" rel="noopener noreferrer">Read more here</a></p><h5 id="using-the-servicestack-jsonserializer" tabindex="-1">Using the ServiceStack JsonSerializer <a class="header-anchor" href="#using-the-servicestack-jsonserializer" aria-hidden="true">#</a></h5><p>The Silverlight build of ServiceStack.Text (the one that comes with the ServiceStack.Client.Silverlight) is easy to implement. There is code in the below sample that is commented out, showing how to do this. Simply uncomment the code and remove the DCJS implementation, then reference ServiceStack.Text and you now have a faster serializer (one without the date bug).</p><h2 id="example-usage" tabindex="-1">Example Usage <a class="header-anchor" href="#example-usage" aria-hidden="true">#</a></h2><h3 id="setting-up-your-dtos" tabindex="-1">Setting up your DTOs <a class="header-anchor" href="#setting-up-your-dtos" aria-hidden="true">#</a></h3><p>The regular ServiceStack example DTOs should work:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloResponse</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Result <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Your DTO projects will need to be accessible from both Silverlight and your other .Net projects. There are two ways to accomplish this:</p><h5 id="shared-projects" tabindex="-1">Shared Projects <a class="header-anchor" href="#shared-projects" aria-hidden="true">#</a></h5><p>You can use a set of shared project for porting your DTOs to Silverlight. One should be a regular .Net Class Library (perhaps named MySilverlightApp.DTOs), and another should be a Silverlight Class Library (perhaps named MySilverlightApp.DTOs.Silverlight). You can use the project linking technique <a href="http://10rem.net/blog/2009/07/13/sharing-entities-between-wcf-and-silverlight" target="_blank" rel="noopener noreferrer">documented here</a>.</p><p>You may also want to use the Visual Studio Project Linker add-in, which is <a href="http://visualstudiogallery.msdn.microsoft.com/5e730577-d11c-4f2e-8e2b-cbb87f76c044" target="_blank" rel="noopener noreferrer">available here</a> and <a href="http://msdn.microsoft.com/en-us/library/ff921108.aspx" target="_blank" rel="noopener noreferrer">documented here</a>.</p><h5 id="portable-class-libraries" tabindex="-1">Portable Class Libraries <a class="header-anchor" href="#portable-class-libraries" aria-hidden="true">#</a></h5><p>You can put your DTOs in a single project that is set up as a <a href="http://msdn.microsoft.com/en-us/library/gg597391.aspx" target="_blank" rel="noopener noreferrer">Portable Class Library</a>. This is a much easier solution, but you will not be able to take on any dependencies.</p><p>This means that you cannot use the [Route] attribute on your DTOs with this approach. Instead, use one of the other ways to register services, such as <code>Routes.Add()</code> in your AppHost.Config.</p><h3 id="the-serviceclient-implementation" tabindex="-1">The ServiceClient Implementation <a class="header-anchor" href="#the-serviceclient-implementation" aria-hidden="true">#</a></h3><p>Here is the actual code that implements the ServiceClient. If you&#39;ve followed all of the above instructions, you should be able to use it easily in your application. Simply change the namespace as you desire.</p><div class="language-csharp"><pre><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Browser</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Browser</span><span class="token punctuation">;</span>
<span class="token comment">//using ServiceStack.Text;  // uncomment if using SS serializer instead of DCJS.</span>

<span class="token keyword">namespace</span> <span class="token namespace">MySilverlightApp</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceClient<span class="token punctuation">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token punctuation">&gt;</span></span>
        <span class="token keyword">where</span> <span class="token class-name">TRequest</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
        <span class="token keyword">where</span> <span class="token class-name">TResponse</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> _baseUri<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> EnableCookies <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">ServiceClient</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> baseUri <span class="token operator">=</span> <span class="token string">&quot;/api&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// make sure the base uri is set appropriately</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseUri<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>InvariantCultureIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> source <span class="token operator">=</span> Application<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Host<span class="token punctuation">.</span>Source<span class="token punctuation">;</span>
                
                <span class="token class-name"><span class="token keyword">string</span></span> rootUri <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span>AbsoluteUri<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;ClientBin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">int</span></span> idx <span class="token operator">=</span> source<span class="token punctuation">.</span>AbsoluteUri<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;ClientBin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    rootUri <span class="token operator">=</span> source<span class="token punctuation">.</span>AbsoluteUri<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                    rootUri <span class="token operator">=</span> source<span class="token punctuation">.</span>AbsoluteUri<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span>AbsoluteUri<span class="token punctuation">.</span>Length <span class="token operator">-</span> source<span class="token punctuation">.</span>AbsolutePath<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseUri<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    baseUri <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> baseUri<span class="token punctuation">;</span>
                baseUri <span class="token operator">=</span> rootUri <span class="token operator">+</span> baseUri<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_baseUri <span class="token operator">=</span> baseUri<span class="token punctuation">;</span>

            <span class="token comment">// cookies are on by default</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>EnableCookies <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> method<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// set up the web request</span>
            <span class="token class-name"><span class="token keyword">var</span></span> webRequest <span class="token operator">=</span> <span class="token punctuation">(</span>HttpWebRequest<span class="token punctuation">)</span>WebRequestCreator<span class="token punctuation">.</span>ClientHttp<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>_baseUri <span class="token operator">+</span> uri<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webRequest<span class="token punctuation">.</span>Method <span class="token operator">=</span> method<span class="token punctuation">;</span>

            <span class="token comment">// if cookies are enabled, pass them in from the browser</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EnableCookies<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                webRequest<span class="token punctuation">.</span>CookieContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CookieContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                webRequest<span class="token punctuation">.</span>CookieContainer<span class="token punctuation">.</span><span class="token function">SetCookies</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>_baseUri<span class="token punctuation">)</span><span class="token punctuation">,</span> HtmlPage<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Cookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// set the accept header so our response is in json</span>
            webRequest<span class="token punctuation">.</span>Accept <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">;</span>

            <span class="token comment">// if we have data to stream, start streaming.  Otherwise we can get the response now.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                webRequest<span class="token punctuation">.</span><span class="token function">BeginGetRequestStream</span><span class="token punctuation">(</span>RequestCallback<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DataContainer</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                webRequest<span class="token punctuation">.</span><span class="token function">BeginGetResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ResponseCallback<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RequestCallback</span><span class="token punctuation">(</span><span class="token class-name">IAsyncResult</span> asyncResult<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Get the web request stream</span>
                <span class="token class-name"><span class="token keyword">var</span></span> container <span class="token operator">=</span> <span class="token punctuation">(</span>DataContainer<span class="token punctuation">)</span>asyncResult<span class="token punctuation">.</span>AsyncState<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> webRequest <span class="token operator">=</span> container<span class="token punctuation">.</span>WebRequest<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> stream <span class="token operator">=</span> webRequest<span class="token punctuation">.</span><span class="token function">EndGetRequestStream</span><span class="token punctuation">(</span>asyncResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// set the content type to json</span>
                webRequest<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">;</span>

                <span class="token comment">// serialize the object to json and write it to the stream</span>
                <span class="token class-name"><span class="token keyword">var</span></span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DataContractJsonSerializer</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRequest</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                serializer<span class="token punctuation">.</span><span class="token function">WriteObject</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> container<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stream<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stream<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// If you want to use ServiceStack&#39;s serializer, replace the previous code block with this one.</span>
                <span class="token comment">//using (var writer = new StreamWriter(stream))</span>
                <span class="token comment">//{</span>
                <span class="token comment">//    var serializer = new JsonSerializer&lt;TRequest&gt;();</span>
                <span class="token comment">//    serializer.SerializeToWriter(container.Data, writer);</span>
                <span class="token comment">//}</span>


                <span class="token comment">// now we can get the response</span>
                webRequest<span class="token punctuation">.</span><span class="token function">BeginGetResponse</span><span class="token punctuation">(</span>ResponseCallback<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Raise our own event for the error on the UI thread</span>
                <span class="token class-name"><span class="token keyword">var</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Deployment<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">OnCompleted</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ResponseCallback</span><span class="token punctuation">(</span><span class="token class-name">IAsyncResult</span> asyncResult<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Get the web response</span>
                <span class="token class-name"><span class="token keyword">var</span></span> webRequest <span class="token operator">=</span> <span class="token punctuation">(</span>HttpWebRequest<span class="token punctuation">)</span>asyncResult<span class="token punctuation">.</span>AsyncState<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> webResponse <span class="token operator">=</span> webRequest<span class="token punctuation">.</span><span class="token function">EndGetResponse</span><span class="token punctuation">(</span>asyncResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Get the web response stream</span>
                <span class="token class-name"><span class="token keyword">var</span></span> stream <span class="token operator">=</span> webResponse<span class="token punctuation">.</span><span class="token function">GetResponseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Deserialize the json data in the response stream</span>
                <span class="token class-name"><span class="token keyword">var</span></span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DataContractJsonSerializer</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TResponse</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token punctuation">(</span>TResponse<span class="token punctuation">)</span>serializer<span class="token punctuation">.</span><span class="token function">ReadObject</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// If you want to use ServiceStack&#39;s serializer, replace the previous code block with this one.</span>
                <span class="token comment">//TResponse response;</span>
                <span class="token comment">//using (var reader = new StreamReader(stream))</span>
                <span class="token comment">//{</span>
                <span class="token comment">//    var serializer = new JsonSerializer&lt;TResponse&gt;();</span>
                <span class="token comment">//    response = serializer.DeserializeFromReader(reader);</span>
                <span class="token comment">//}</span>


                <span class="token comment">// Switch to the UI thread</span>
                <span class="token class-name"><span class="token keyword">var</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Deployment<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">BeginInvoke</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">// if cookies are enabled, pass them back to the browser</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EnableCookies <span class="token operator">&amp;&amp;</span> webRequest<span class="token punctuation">.</span>CookieContainer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token class-name"><span class="token keyword">var</span></span> cookieHeader <span class="token operator">=</span> webRequest<span class="token punctuation">.</span>CookieContainer<span class="token punctuation">.</span><span class="token function">GetCookieHeader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>_baseUri<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            HtmlPage<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Cookies <span class="token operator">=</span> cookieHeader<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">//Raise our own event for the response</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">OnCompleted</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Raise our own event for the error on the UI thread</span>
                <span class="token class-name"><span class="token keyword">var</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Deployment<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">OnCompleted</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">&quot;PUT&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Patch</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">&quot;PATCH&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uri<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">&quot;DELETE&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> Completed<span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCompleted</span><span class="token punctuation">(</span><span class="token class-name">ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Completed<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DataContainer</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token function">DataContainer</span><span class="token punctuation">(</span><span class="token class-name">HttpWebRequest</span> webRequest<span class="token punctuation">,</span> <span class="token class-name">TRequest</span> data<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>WebRequest <span class="token operator">=</span> webRequest<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token return-type class-name">HttpWebRequest</span> WebRequest <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token keyword">public</span> <span class="token return-type class-name">TRequest</span> Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceClientEventArgs<span class="token punctuation">&lt;</span>TResponse<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EventArgs</span></span>
        <span class="token keyword">where</span> <span class="token class-name">TResponse</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TResponse</span> _response<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Exception</span> _error<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">ServiceClientEventArgs</span><span class="token punctuation">(</span><span class="token class-name">TResponse</span> response<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_response <span class="token operator">=</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">ServiceClientEventArgs</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> error<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">TResponse</span> Response
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_response<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">Exception</span> Error
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_error<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="community-resources" tabindex="-1">Community Resources <a class="header-anchor" href="#community-resources" aria-hidden="true">#</a></h1><ul><li><a href="http://skov-boisen.dk/?p=214" target="_blank" rel="noopener noreferrer">Silverlight, GZip and ServiceStack</a> by <a href="https://twitter.com/ssboisen" target="_blank" rel="noopener noreferrer">@ssboisen</a></li></ul>__VP_STATIC_END__`,44),o=[p];function c(l,i,u,r,k,d){return a(),s("div",null,o)}var w=n(e,[["render",c]]);export{m as __pageData,w as default};
