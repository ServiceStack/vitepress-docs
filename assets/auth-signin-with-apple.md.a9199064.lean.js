import{_ as n,c as s,o as a,a as t}from"./app.14440598.js";const g='{"title":"Sign in with Apple Auth Provider","description":"","frontmatter":{"slug":"signin-with-apple","title":"Sign in with Apple Auth Provider"},"headers":[{"level":3,"title":"Sign In with Apple Requirements","slug":"sign-in-with-apple-requirements"},{"level":2,"title":"Getting Started","slug":"getting-started"},{"level":3,"title":"Create project with preferred Auth Configuration","slug":"create-project-with-preferred-auth-configuration"},{"level":3,"title":"Clone working Client & Server Project","slug":"clone-working-client-server-project"},{"level":2,"title":"Flutter iOS & Android App","slug":"flutter-ios-android-app"},{"level":3,"title":"signinwith_apple package","slug":"sign-in-with-apple-package"},{"level":3,"title":"New User Registration","slug":"new-user-registration"},{"level":3,"title":"Persistent Authenticated Sessions","slug":"persistent-authenticated-sessions"},{"level":3,"title":"Authenticated API Requests","slug":"authenticated-api-requests"},{"level":3,"title":"Resetting App Sign in","slug":"resetting-app-sign-in"},{"level":3,"title":"Flutter Android signinwith_apple requirements","slug":"flutter-android-sign-in-with-apple-requirements"},{"level":2,"title":"SwiftUI App","slug":"swiftui-app"},{"level":3,"title":"Enabling Sign In With Apple Capability","slug":"enabling-sign-in-with-apple-capability"},{"level":3,"title":"SwiftUI Layout","slug":"swiftui-layout"},{"level":3,"title":"Loading persistent JWT Auth Tokens","slug":"loading-persistent-jwt-auth-tokens"},{"level":3,"title":"Authenticated Requests","slug":"authenticated-requests"},{"level":3,"title":"Advanced Configuration","slug":"advanced-configuration"}],"relativePath":"auth-signin-with-apple.md","lastUpdated":1634495307610}',e={},p=t(`__VP_STATIC_START__<p>ServiceStack Sign In with Apple Auth Provider docs &amp; Integration docs from <a href="https://github.com/NetCoreApps/AppleSignIn" target="_blank" rel="noopener noreferrer">github.com/NetCoreApps/AppleSignIn</a>.</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/web-signin-with-apple-login.png" alt=""></p><h3 id="sign-in-with-apple-requirements" tabindex="-1">Sign In with Apple Requirements <a class="header-anchor" href="#sign-in-with-apple-requirements" aria-hidden="true">#</a></h3><ul><li>Membership <strong>Team ID</strong> from <a href="https://developer.apple.com/account/#/membership/" target="_blank" rel="noopener noreferrer">developer.apple.com/account/#/membership/</a></li><li>Create &amp; configure <strong>App ID</strong> from <a href="https://developer.apple.com/account/resources/identifiers/list" target="_blank" rel="noopener noreferrer">developer.apple.com/account/resources/identifiers/list</a></li><li>Use <strong>App ID</strong> to create &amp; configure <strong>Service ID</strong> from <a href="https://developer.apple.com/account/resources/identifiers/list/serviceId" target="_blank" rel="noopener noreferrer">developer.apple.com/account/resources/identifiers/list/serviceId</a></li><li>Use <strong>App ID</strong> to create &amp; configure <strong>Private Key</strong> from <a href="https://developer.apple.com/account/resources/authkeys/list" target="_blank" rel="noopener noreferrer">developer.apple.com/account/resources/authkeys/list</a></li></ul><h4 id="app-requirements-walkthrough" tabindex="-1">App Requirements Walkthrough <a class="header-anchor" href="#app-requirements-walkthrough" aria-hidden="true">#</a></h4><p>Okta has a <a href="https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple" target="_blank" rel="noopener noreferrer">good walkthrough explaining Sign In with Apple</a> and steps required to create the above resources.</p><p>Note: Service ID must be configured with non-localhost trusted domain and HTTPS callback URL, for development you can use:</p><ul><li>Domain: <code>dev.servicestack.com</code></li><li>Callback URL: <code>https://dev.servicestack.com:5001/auth/apple</code></li></ul><p>See docs on <a href="/netcore-localhost-cert.html">Configure localhost development dev certificate</a> for instructions &amp; info for being able to use a single <code>local.servicestack.com</code> or <code>dev.servicestack.com</code> local DNS names to support local development of all platforms.</p><h4 id="apple-services-id-configuration" tabindex="-1">Apple Services ID configuration <a class="header-anchor" href="#apple-services-id-configuration" aria-hidden="true">#</a></h4><p>If you also need to support Android you&#39;ll also need to register the <code>https://dev.servicestack.com:5001/auth/apple?ReturnUrl=android:com.servicestack.auth</code> URL will as a valid Callback URL in your Apple <strong>Services ID</strong> configuration.</p><h2 id="getting-started" tabindex="-1">Getting Started <a class="header-anchor" href="#getting-started" aria-hidden="true">#</a></h2><p>As the elliptic curve algorithms required to integrate with Sign In with Apple requires .NET Core 3 APIs the <code>AppleAuthProvider</code> is implemented in the <strong>ServiceStack.Extensions</strong> NuGet Package.</p><h3 id="create-project-with-preferred-auth-configuration" tabindex="-1">Create project with preferred Auth Configuration <a class="header-anchor" href="#create-project-with-preferred-auth-configuration" aria-hidden="true">#</a></h3><p>A quick way to can create a working project from scratch with your preferred configuration using the <a href="/mix-tool.html">mix tool</a>, e.g:</p><div class="language-bash"><pre><code>$ <span class="token function">mkdir</span> web <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> web
$ x mix init auth-ext auth-db sqlite
</code></pre></div><p>This creates an empty project, with Auth Enabled, adds the <strong>ServiceStack.Extensions</strong> NuGet package, registers OrmLite, SQLite and the <code>OrmLiteAuthRepository</code>.</p><p>Copy your Apple <strong>Private Key</strong> to your Apps <strong>Content Folder</strong> then configure your OAuth providers in <strong>appsettings.json</strong>:</p><div class="language-json"><pre><code><span class="token punctuation">{</span>
  <span class="token property">&quot;oauth.apple.RedirectUrl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://dev.servicestack.com:5001/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.CallbackUrl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://dev.servicestack.com:5001/auth/apple&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.TeamId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{Team ID}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.ClientId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{Service ID}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.BundleId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{Bundle ID}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.KeyId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{Private KeyId}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth.apple.KeyPath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AuthKey_{Private KeyId}.p8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jwt.AuthKeyBase64&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{Base64 JWT Auth Key}&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>See JWT docs for how to <a href="/jwt-authprovider.html#generate-new-auth-key">Generate a new Auth Key</a></p></div><p>When needing to support Mobile or Desktop Apps using OAuth Providers like Sign In with Apple, we recommend using it in combination with the <a href="/jwt-authprovider.html">JWT Auth Provider</a> with <code>UseTokenCookie</code> enabled so the Authorization is returned in a stateless JWT Token that can be persisted for optimal Authentication across App restarts, e.g:</p><div class="language-csharp"><pre><code>Plugins<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthFeature</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CustomUserSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IAuthProvider<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            UseTokenCookie <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppleAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>AppleAuthFeature<span class="token punctuation">.</span>FlutterSignInWithApple<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="clone-working-client-server-project" tabindex="-1">Clone working Client &amp; Server Project <a class="header-anchor" href="#clone-working-client-server-project" aria-hidden="true">#</a></h3><p>For a working example you can <strong>clone</strong> or <strong>fork</strong> the <a href="https://github.com/NetCoreApps/AppleSignIn" target="_blank" rel="noopener noreferrer">/NetCoreApps/AppleSignIn</a> repo or alternatively download the latest master <code>.zip</code> with:</p><div class="language-bash"><pre><code>$ x download NetCoreApps/AppleSignIn
</code></pre></div><p>Then after updating <strong>appsettings.json</strong> with your iOS App&#39;s configuration, copying your Private Key into the <code>web</code> Content Folder you&#39;re all set to run your App:</p><div class="language-bash"><pre><code>$ dotnet run
</code></pre></div><h4 id="android-support" tabindex="-1">Android Support <a class="header-anchor" href="#android-support" aria-hidden="true">#</a></h4><p>To support Android we recommend using <code>dev.servicestack.com</code> which resolves to the <code>10.0.2.2</code> special IP in the Android Emulator that maps to <code>127.0.0.1</code> on your Host OS. To also be able to use it during development you&#39;ll need to add an entry in your OS&#39;s <code>hosts</code> file (e.g. <code>%SystemRoot%\\System32\\drivers\\etc\\hosts</code> for Windows or <code>/system/etc/hosts</code> on macOS/Linux):</p><div class="language-"><pre><code>127.0.0.1       dev.servicestack.com
</code></pre></div><p>If you don&#39;t need to support android you can use <code>local.servicestack.com</code> instead which resolves to <code>127.0.0.1</code>, please see <a href="/netcore-localhost-cert.html">configuring localhost development dev certificate</a> for more info.</p><p>Then you can view your App using the non-localhost domain name:</p><ul><li><a href="https://dev.servicestack.com:5001/" target="_blank" rel="noopener noreferrer">https://dev.servicestack.com:5001/</a></li></ul><p>You can then use the <a href="/authentication-and-authorization.html#embedded-login-page-fallback">Embedded Login Page</a> which renders the Sign In button for each of the registered OAuth providers in your <code>AuthFeature</code>:</p><ul><li><a href="https://dev.servicestack.com:5001/login" target="_blank" rel="noopener noreferrer">https://dev.servicestack.com:5001/login</a></li></ul><p>Clicking on <strong>Sign in with Apple</strong> button should let you Sign In with Apple. After successfully signing in you can view the <code>AllUsersInfo</code> Service to view a dump of all User Sessions &amp; User Auth Info stored in the registered RDBMS:</p><ul><li><a href="https://dev.servicestack.com:5001/users" target="_blank" rel="noopener noreferrer">https://dev.servicestack.com:5001/users</a></li></ul><h2 id="flutter-ios-android-app" tabindex="-1">Flutter iOS &amp; Android App <a class="header-anchor" href="#flutter-ios-android-app" aria-hidden="true">#</a></h2><p>A reference client Flutter iOS &amp; Android App showcasing integration with Sign In with Apple is available at <a href="https://github.com/NetCoreApps/AppleSignIn/tree/master/flutter/auth" target="_blank" rel="noopener noreferrer">/flutter/auth</a>.</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/android-flutter-auth.png" alt=""></p><p>The first task the App does is to create an instance of the <code>IServiceClient</code> it should use using the recommended <code>ClientFactory</code> API which in combination with the conditional import below returns the appropriate configured Service Client implementation for the platform it&#39;s running on, for iOS &amp; Android it uses the native <code>JsonServiceClient</code>:</p><div class="language-dart"><pre><code><span class="token keyword">import</span> <span class="token string">&#39;package:servicestack/web_client.dart&#39;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dart<span class="token punctuation">.</span><span class="token keyword">library</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token string">&#39;package:servicestack/client.dart&#39;</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>

<span class="token class-name">AppState</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> kDebugMode
  <span class="token operator">?</span> <span class="token class-name">ClientFactory</span><span class="token punctuation">.</span><span class="token function">createWith</span><span class="token punctuation">(</span><span class="token class-name">ClientOptions</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">:</span><span class="token string">&#39;https://dev.servicestack.com:5001&#39;</span><span class="token punctuation">,</span> ignoreCert<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span> <span class="token class-name">ClientFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;https://prod.app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Using a constant like <code>kDebugMode</code> ensures that create Service Clients that ignore SSL Certificate errors are stripped from production builds.</p><h3 id="sign-in-with-apple-package" tabindex="-1">sign_in_with_apple package <a class="header-anchor" href="#sign-in-with-apple-package" aria-hidden="true">#</a></h3><p>To support both iOS and Android we&#39;re utilizing the <a href="https://pub.dev/packages/sign_in_with_apple" target="_blank" rel="noopener noreferrer">sign_in_with_apple</a> <code>SignInWithAppleButton</code> which takes care of invoking iOS&#39;s native Sign In with Apple behavior as well as enabling support for Android by wrapping an OAuth Web Flow in a WebView. Both approaches, if successful will result in an Authenticated IdentityToken which you can use to Authenticate with your ServiceStack instance to establish an Authenticated session.</p><p>The <code>SignInWithAppleButton</code> functions as a normal button which is placed in your Widgets <code>build()</code> method where you want the UI Button to appear, in this case it&#39;ll render the <strong>Sign in with Apple</strong> button if the user is not Authenticated otherwise it renders a <strong>Sign Out</strong> <code>FlatButton</code>:</p><div class="language-dart"><pre><code>state<span class="token punctuation">.</span>isAuthenticated
  <span class="token operator">?</span> <span class="token class-name">FlatButton</span><span class="token punctuation">(</span>onPressed<span class="token punctuation">:</span> state<span class="token punctuation">.</span>signOut<span class="token punctuation">,</span> child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string">&#39;Sign Out&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span> <span class="token class-name">SignInWithAppleButton</span><span class="token punctuation">(</span>onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> <span class="token function">handleSignIn</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>When either is pressed it invokes its <code>onPressed</code> event where the Apple Sign in functionality is initiated, within the <code>handleSignIn</code> implementation which reflects the behavior of the different platforms with Android using the OAuth Web Flow to authenticate with its ReturnUrl needing the Android&#39;s App Id that it should redirect to.</p><p>The native integration in iOS is more streamlined with iOS handling the Auth flow with Apple&#39;s servers:</p><div class="language-dart"><pre><code><span class="token keyword">var</span> clientID <span class="token operator">=</span> <span class="token string">&quot;net.servicestack.myappid&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> redirect <span class="token operator">=</span> <span class="token string">&quot;https://dev.servicestack.com:5001/auth/apple?ReturnUrl=android:com.servicestack.auth&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> scopes <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token class-name">AppleIDAuthorizationScopes</span><span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token class-name">AppleIDAuthorizationScopes</span><span class="token punctuation">.</span>fullName <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> credentials <span class="token operator">=</span> <span class="token class-name">Platform</span><span class="token punctuation">.</span>isAndroid
  <span class="token operator">?</span> <span class="token keyword">await</span> <span class="token class-name">SignInWithApple</span><span class="token punctuation">.</span><span class="token function">getAppleIDCredential</span><span class="token punctuation">(</span>scopes<span class="token punctuation">:</span>scopes<span class="token punctuation">,</span>
      webAuthenticationOptions<span class="token punctuation">:</span><span class="token class-name">WebAuthenticationOptions</span><span class="token punctuation">(</span>clientId<span class="token punctuation">:</span>clientID<span class="token punctuation">,</span>redirectUri<span class="token punctuation">:</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span> <span class="token keyword">await</span> <span class="token class-name">SignInWithApple</span><span class="token punctuation">.</span><span class="token function">getAppleIDCredential</span><span class="token punctuation">(</span>scopes<span class="token punctuation">:</span>scopes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="new-user-registration" tabindex="-1">New User Registration <a class="header-anchor" href="#new-user-registration" aria-hidden="true">#</a></h3><p>When a user signs into your App the first time they&#39;ll be presented with the option on what name they want to use and whether or not they want to provide their own email or use Apple&#39;s hidden email forwarding service:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-flutter-sign-in-with-apple-new-user.png" alt=""></p><p>Subsequent re-authentication attempts in iOS are more seamless &amp; effortless for users whilst Android users will still need to go through the OAuth web flow:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/android-flutter-auth-request.png" alt=""></p><p>If Sign in is successful it will return the identity token which we can use to Authenticate against our remote ServiceStack instance. Importantly Apple only returns the Users name on its initial sign in which we&#39;ll need to include in our <code>Authenticate</code> request in order for it to be used when creating the new user account. The same code can also be used to re-authenticate existing users:</p><div class="language-dart"><pre><code><span class="token comment">// Sign in with Apple success!</span>
<span class="token keyword">var</span> idToken <span class="token operator">=</span> credentials<span class="token punctuation">.</span>identityToken<span class="token punctuation">;</span>

<span class="token comment">// Authenticate with server using idToken &amp; convert into stateless JWT Cookie + persistent auth token</span>
<span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">await</span> state<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>provider <span class="token operator">=</span> <span class="token string">&#39;apple&#39;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>accessToken <span class="token operator">=</span> idToken<span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&#39;authorizationCode&#39;</span><span class="token punctuation">:</span> credentials<span class="token punctuation">.</span>authorizationCode<span class="token punctuation">,</span>
        <span class="token string">&#39;givenName&#39;</span><span class="token punctuation">:</span> credentials<span class="token punctuation">.</span>givenName<span class="token punctuation">,</span>
        <span class="token string">&#39;familyName&#39;</span><span class="token punctuation">:</span> credentials<span class="token punctuation">.</span>familyName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// JwtAuthProvider.UseTokenCookie returns session as JWT</span>

state<span class="token punctuation">.</span><span class="token function">saveAuth</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="persistent-authenticated-sessions" tabindex="-1">Persistent Authenticated Sessions <a class="header-anchor" href="#persistent-authenticated-sessions" aria-hidden="true">#</a></h3><p>We recommend using JWT to store authenticated sessions as it allows using a single approach to support multiple OAuth providers, inc. Username/Password Credentials Auth if you want your App to support it, it&#39;s also the fastest &amp; most resilient Auth Provider which requires no I/O to validate &amp; no server state as it&#39;s all encapsulated within the stateless client JWT token.</p><p>As all DTOs are JSON Serializable, the easiest way to persist Authentication is to save the <code>AuthenticateResponse</code> (which contains both JWT Bearer &amp; Refresh Tokens) in Flutter&#39;s <code>SharedPreferences</code> abstraction which has implementations available in all its supported platforms.</p><p>Populating a Service Client with <code>bearerToken</code> and <code>refreshToken</code> enables it to make authenticated requests which is done on successful Sign in requests and when the App is initialized which is also what allows for persistent authentication across App restarts.</p><div class="language-dart"><pre><code><span class="token keyword">class</span> <span class="token class-name">AppState</span> <span class="token keyword">extends</span> <span class="token class-name">ChangeNotifier</span> <span class="token punctuation">{</span>
  <span class="token class-name">SharedPreferences</span> prefs<span class="token punctuation">;</span>
  <span class="token class-name">IServiceClient</span> client<span class="token punctuation">;</span>
  <span class="token class-name">AuthenticateResponse</span> auth<span class="token punctuation">;</span>
  bool hasInit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  bool <span class="token keyword">get</span> isAuthenticated <span class="token operator">=</span><span class="token operator">&gt;</span> auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token class-name">AppState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppState</span><span class="token punctuation">&gt;</span></span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    prefs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token class-name">SharedPreferences</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> json <span class="token operator">=</span> prefs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    auth <span class="token operator">=</span> json <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">AuthenticateResponse</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span><span class="token function">jsonDecode</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token function">initClientAuth</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">await</span> <span class="token function">checkIsAuthenticated</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      auth <span class="token operator">=</span> client<span class="token punctuation">.</span>bearerToken <span class="token operator">=</span> client<span class="token punctuation">.</span>refreshToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      prefs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    hasInit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">saveAuth</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">saveAuth</span><span class="token punctuation">(</span><span class="token class-name">AuthenticateResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    auth <span class="token operator">=</span> response<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token function">jsonEncode</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      prefs<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      prefs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">initClientAuth</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">initClientAuth</span><span class="token punctuation">(</span><span class="token class-name">IServiceClient</span> client<span class="token punctuation">,</span> <span class="token class-name">AuthenticateResponse</span> auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">.</span>bearerToken <span class="token operator">=</span> auth<span class="token operator">?</span><span class="token punctuation">.</span>bearerToken<span class="token punctuation">;</span>
  client<span class="token punctuation">.</span>refreshToken <span class="token operator">=</span> auth<span class="token operator">?</span><span class="token punctuation">.</span>refreshToken<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">clearCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span> <span class="token function">checkIsAuthenticated</span><span class="token punctuation">(</span><span class="token class-name">IServiceClient</span> client<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When signing out we also want to remove its cookies to clear its <code>ss-tok</code> authenticated JWT Cookie inc. any other user identifying cookies.</p><p>The call to <code>notifyListeners()</code> is part of Flutter&#39;s <code>ChangeNotifier</code><a href="https://flutter.dev/docs/development/data-and-backend/state-mgmt/simple" target="_blank" rel="noopener noreferrer">Simple app state management</a> solution which notifies widgets using it of state changes, triggering re-rendering of its UI.</p><h3 id="authenticated-api-requests" tabindex="-1">Authenticated API Requests <a class="header-anchor" href="#authenticated-api-requests" aria-hidden="true">#</a></h3><p>To test Authentication the App makes a call to <code>HelloSecure</code> Secured C# ServiceStack Service that validates Auth only access using the <code>[ValidateIsAuthenticated]</code> <a href="/declarative-validation.html">declarative validation attribute</a>:</p><div class="language-csharp"><pre><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateIsAuthenticated</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/hello/secure&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;/hello/secure/{Name}&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloSecure</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IReturn<span class="token punctuation">&lt;</span>HelloResponse<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloResponse</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Result <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServices</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">HelloSecure</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HelloResponse</span> <span class="token punctuation">{</span> Result <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Secure </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">request<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">!&quot;</span></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Which uses the Dart client DTOs generated using the <a href="/dart-add-servicestack-reference.html">Dart ServiceStack Reference</a> feature to perform its Typed API Request:</p><div class="language-dart"><pre><code>  floatingActionButton<span class="token punctuation">:</span> <span class="token class-name">FloatingActionButton</span><span class="token punctuation">(</span>
    onPressed<span class="token punctuation">:</span> _callService<span class="token punctuation">,</span>
    tooltip<span class="token punctuation">:</span> <span class="token string">&#39;HTTP API Example&#39;</span><span class="token punctuation">,</span>
    child<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>play_arrow<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// This trailing comma makes auto-formatting nicer for build methods.</span>

<span class="token comment">//...</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">_callService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token class-name">Provider</span><span class="token punctuation">.</span>of<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> listen<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>client<span class="token punctuation">;</span>
      <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token class-name">HelloSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Flutter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> response<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">on</span> <span class="token class-name">WebServiceException</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token string">&quot;\${e.statusCode}: \${e.message}&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>Which if authenticated will update the UI with API Response for both iOS:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-flutter-auth-request.jpeg" alt=""></p><p>and Android:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/android-flutter-secure.png" alt=""></p><p>Or fail with an <code>Unauthorized: Not Authenticated</code> error if the user is not Signed in.</p><h3 id="resetting-app-sign-in" tabindex="-1">Resetting App Sign in <a class="header-anchor" href="#resetting-app-sign-in" aria-hidden="true">#</a></h3><p>As the Sign in behavior is different for new &amp; existing users you may need to find yourself needing to retest the new user workflow which you can do by removing your existing relationship to your App by signing into your Apple Id:</p><ul><li><a href="https://appleid.apple.com" target="_blank" rel="noopener noreferrer">appleid.apple.com</a></li></ul><p>Then under <strong>Security</strong> click on <strong>Manage apps &amp; websites...</strong></p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/appleid-manage-signin.png" alt=""></p><p>Which will let you delete your existing user id and relationship with existing Apps you&#39;ve signed into:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/appleid-reset-signin.png" alt=""></p><p>Now next time you Sign in to your App it will behave as an initial new User request complete with a new unique user id.</p><h3 id="flutter-android-sign-in-with-apple-requirements" tabindex="-1">Flutter Android sign_in_with_apple requirements <a class="header-anchor" href="#flutter-android-sign-in-with-apple-requirements" aria-hidden="true">#</a></h3><p>It&#39;s already configured in this project, but to be able to use <a href="https://pub.dev/packages/sign_in_with_apple" target="_blank" rel="noopener noreferrer">sign_in_with_apple</a> in your own Flutter Android Apps you&#39;ll need to register this Android intent in your <strong>AndroidManifest.xml</strong>:</p><div class="language-xml"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Set up the Sign in with Apple activity, such that it&#39;s callable from the browser-redirect --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.aboutyou.dart_packages.sign_in_with_apple.SignInWithAppleCallback<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.intent.action.VIEW<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.intent.category.DEFAULT<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.intent.category.BROWSABLE<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signinwithapple<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>callback<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- Don&#39;t delete the meta-data below.
            This is used by the Flutter tool to generate GeneratedPluginRegistrant.java --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flutterEmbedding<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="servicestack-appleauthprovider-configuration" tabindex="-1">ServiceStack AppleAuthProvider configuration <a class="header-anchor" href="#servicestack-appleauthprovider-configuration" aria-hidden="true">#</a></h4><p>This client App configuration works in combination with the Server&#39;s <code>AppleAuthProvider</code> to redirect to your Android&#39;s App intent which needs to be configured with:</p><div class="language-csharp"><pre><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppleAuthProvider</span><span class="token punctuation">(</span>AppSettings<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>AppleAuthFeature<span class="token punctuation">.</span>FlutterSignInWithApple<span class="token punctuation">)</span><span class="token punctuation">,</span> 
</code></pre></div><p>Where it adds support for <code>?ReturnUrl=android:&lt;android-package-id&gt;</code> Callback URLs that your Flutter Android App needs to use.</p><h2 id="swiftui-app" tabindex="-1">SwiftUI App <a class="header-anchor" href="#swiftui-app" aria-hidden="true">#</a></h2><p>The <a href="https://github.com/NetCoreApps/AppleSignIn" target="_blank" rel="noopener noreferrer">/NetCoreApps/AppleSignIn</a> repo also includes a SwiftUI iOS Example App available at <a href="https://github.com/NetCoreApps/AppleSignIn/tree/master/swift/MyApp" target="_blank" rel="noopener noreferrer">/swift/MyApp</a> as it&#39;ll likely end up being another popular platform that will utilize <strong>Sign in with Apple</strong>.</p><p>It&#39;s a good idea to checkout Apple&#39;s official docs for their recommended approach for <a href="https://developer.apple.com/documentation/authenticationservices/implementing_user_authentication_with_sign_in_with_apple" target="_blank" rel="noopener noreferrer">Implementing User Authentication with Sign in with Apple</a> in Swift Apps which includes a sample iOS Storyboard Swift App which enlists the built-in <a href="https://developer.apple.com/documentation/authenticationservices" target="_blank" rel="noopener noreferrer">Authentication Services Framework</a> for iOS&#39;s native Sign in feature.</p><p>For simplicity &amp; comparison purposes we&#39;ve developed an App similar to the Flutter example using Apple&#39;s new declarative state-of-the-art <a href="https://developer.apple.com/xcode/swiftui/" target="_blank" rel="noopener noreferrer">SwiftUI Framework</a>, which like Flutter is a declarative Reactive UI Framework allowing you to construct your App&#39;s UI &amp; logic in code - most of which is contained within <a href="https://github.com/NetCoreApps/AppleSignIn/blob/master/swift/MyApp/MyApp/ContentView.swift" target="_blank" rel="noopener noreferrer">ContentView.swift</a>.</p><h4 id="real-device-needed-to-test-sign-in-with-apple" tabindex="-1">Real device needed to test Sign in with Apple <a class="header-anchor" href="#real-device-needed-to-test-sign-in-with-apple" aria-hidden="true">#</a></h4><p>Whilst the iOS Simulator can run the rest of the App, a real device was needed to test the actual Sign in functionality which otherwise hangs in the simulator which has been reported is due to 2FA which is required to use Sign in with Apple.</p><h3 id="enabling-sign-in-with-apple-capability" tabindex="-1">Enabling Sign In With Apple Capability <a class="header-anchor" href="#enabling-sign-in-with-apple-capability" aria-hidden="true">#</a></h3><p>To enable Sign In functionality in your iOS App you&#39;ll need to add the <strong>Sign in with Apple</strong> capability in your App&#39;s <strong>Target</strong> &gt; <strong>Signing &amp; Capabilities</strong> window:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-swiftui-xcode-capability.png" alt=""></p><h3 id="swiftui-layout" tabindex="-1">SwiftUI Layout <a class="header-anchor" href="#swiftui-layout" aria-hidden="true">#</a></h3><p>SwiftUI&#39;s declarative API is able to expressively capture our UI in its different states within this code fragment below:</p><div class="language-swift"><pre><code><span class="token keyword">struct</span> <span class="token class-name">ContentView</span><span class="token punctuation">:</span> <span class="token class-name">View</span> <span class="token punctuation">{</span>
    <span class="token attribute atrule">@ObservedObject</span> <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token class-name">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">var</span> body<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">View</span> <span class="token punctuation">{</span>
         <span class="token class-name">VStack</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>hasInit <span class="token punctuation">{</span>
                <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Loading...&quot;</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">Text</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
                <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Go!&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    vm<span class="token punctuation">.</span><span class="token function">doSecureRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> auth <span class="token operator">=</span> vm<span class="token punctuation">.</span>auth <span class="token punctuation">{</span>
                    <span class="token class-name">VStack</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Hi </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">auth<span class="token punctuation">.</span>displayName <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> vm<span class="token punctuation">.</span>authState <span class="token operator">!=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span> <span class="token punctuation">{</span>
                            <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;authState: </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">vm<span class="token punctuation">.</span>authState</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">foregroundColor</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>authState <span class="token operator">==</span> <span class="token string-literal"><span class="token string">&quot;authorized&quot;</span></span> <span class="token operator">?</span> <span class="token punctuation">.</span>green <span class="token punctuation">:</span> <span class="token punctuation">.</span>primary<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Sign Out&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> vm<span class="token punctuation">.</span><span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AppleSignInButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">frame</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span>onTapGesture <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">AppleSignInButton</span><span class="token punctuation">:</span> <span class="token class-name">UIViewRepresentable</span> <span class="token punctuation">{</span>
 <span class="token keyword">func</span> <span class="token function-definition function">makeUIView</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">ASAuthorizationAppleIDButton</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">ASAuthorizationAppleIDButton</span><span class="token punctuation">(</span>
    authorizationButtonType<span class="token punctuation">:</span> <span class="token punctuation">.</span>signUp<span class="token punctuation">,</span>
    authorizationButtonStyle<span class="token punctuation">:</span> <span class="token punctuation">.</span>white<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">func</span> <span class="token function-definition function">updateUIView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> uiView<span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationAppleIDButton</span><span class="token punctuation">,</span> context<span class="token punctuation">:</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Which for an initialized unauthenticated user will render the <strong>Go!</strong> button with a Sign in button:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-swiftui-home.png" alt=""></p><p>The Sign in buttons UI is defined by <code>AppleSignInButton()</code> which is our wrapper around Apple&#39;s <code>ASAuthorizationAppleIDButton()</code> that allows for several customizations to change its appearance. When the button is pressed it calls our ViewModel <code>getRequest()</code> method to initiate the Sign in request.</p><p><code>@ObservedObject</code> is one of SwiftUI&#39;s constructs for managing state, effectively it&#39;s the mechanism by which your App modifies to re-render its UI. A good article explaining the features and differences of each construct can be found in <a href="https://purple.telstra.com/blog/swiftui---state-vs--stateobject-vs--observedobject-vs--environme" target="_blank" rel="noopener noreferrer">SwiftUI: @State vs @StateObject vs @ObservedObject vs @EnvironmentObject</a>.</p><p>Inside <code>getRequest()</code> we can see it&#39;s just calling <code>signInWithApple.getAppleRequest()</code> which is our custom controller used to manage the Sign in request.</p><div class="language-swift"><pre><code><span class="token keyword">class</span> <span class="token class-name">ViewModel</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">lazy</span> <span class="token keyword">var</span> signInWithApple <span class="token operator">=</span> <span class="token class-name">SignInWithAppleCoordinator</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">lazy</span> <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">JsonServiceClient</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> client <span class="token operator">=</span> <span class="token class-name">JsonServiceClient</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;https://dev.servicestack.com:5001&quot;</span></span><span class="token punctuation">)</span>
        client<span class="token punctuation">.</span>ignoreCert <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> client
    <span class="token punctuation">}</span>
    
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> auth<span class="token punctuation">:</span> <span class="token class-name">AuthenticateResponse</span><span class="token operator">?</span>
    <span class="token keyword">var</span> isAuthenticated<span class="token punctuation">:</span><span class="token class-name">Bool</span> <span class="token punctuation">{</span> auth <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">}</span>
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> hasInit<span class="token punctuation">:</span><span class="token class-name">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> result<span class="token punctuation">:</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span>
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> authState<span class="token punctuation">:</span><span class="token class-name">String</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        signInWithApple<span class="token punctuation">.</span><span class="token function">getAppleRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//....</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>SignInWithAppleCoordinator</code> uses the <code>ASAuthorizationController</code> to initiate the request and assigns itself as the <code>ASAuthorizationControllerDelegate</code> used to handle its success &amp; error callbacks:</p><div class="language-swift"><pre><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SignInWithAppleCoordinator</span> <span class="token punctuation">:</span> <span class="token class-name">NSObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> vm<span class="token punctuation">:</span> <span class="token class-name">ViewModel</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">getAppleRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> appleIdProvider <span class="token operator">=</span> <span class="token class-name">ASAuthorizationAppleIDProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> request <span class="token operator">=</span> appleIdProvider<span class="token punctuation">.</span><span class="token function">createRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>requestedScopes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>fullName<span class="token punctuation">,</span> <span class="token punctuation">.</span>email<span class="token punctuation">]</span>
        <span class="token keyword">let</span> authController <span class="token operator">=</span> <span class="token class-name">ASAuthorizationController</span><span class="token punctuation">(</span>authorizationRequests<span class="token punctuation">:</span> <span class="token punctuation">[</span>request<span class="token punctuation">]</span><span class="token punctuation">)</span>
        authController<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
        authController<span class="token punctuation">.</span><span class="token function">performRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">setUserInfo</span><span class="token punctuation">(</span><span class="token keyword">for</span> credential<span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationAppleIDCredential</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ASAuthorizationAppleIDProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCredentialState</span><span class="token punctuation">(</span>forUserID<span class="token punctuation">:</span> credential<span class="token punctuation">.</span>user<span class="token punctuation">,</span> completion<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
          credentialState<span class="token punctuation">,</span> error <span class="token keyword">in</span>
            <span class="token keyword">var</span> authState<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>
            <span class="token keyword">switch</span> credentialState <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token punctuation">.</span>authorized<span class="token punctuation">:</span> authState <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;authorized&quot;</span></span>
            <span class="token keyword">case</span> <span class="token punctuation">.</span>notFound<span class="token punctuation">:</span> authState <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;notFound&quot;</span></span>
            <span class="token keyword">case</span> <span class="token punctuation">.</span>revoked<span class="token punctuation">:</span> authState <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;revoked&quot;</span></span>
            <span class="token keyword">case</span> <span class="token punctuation">.</span>transferred<span class="token punctuation">:</span> authState <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;transferred&quot;</span></span>
            <span class="token attribute atrule">@unknown</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>credential<span class="token punctuation">:</span>credential<span class="token punctuation">,</span> authState<span class="token punctuation">:</span>authState<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token class-name">SignInWithAppleCoordinator</span> <span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationControllerDelegate</span> 
<span class="token punctuation">{</span>    
    <span class="token keyword">func</span> <span class="token function-definition function">authorizationController</span><span class="token punctuation">(</span>controller<span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationController</span><span class="token punctuation">,</span> 
      didCompleteWithAuthorization authorization<span class="token punctuation">:</span> <span class="token class-name">ASAuthorization</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> credential <span class="token operator">=</span> authorization<span class="token punctuation">.</span>credential <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">ASAuthorizationAppleIDCredential</span> <span class="token punctuation">{</span>
            <span class="token function">setUserInfo</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> credential<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">authorizationController</span><span class="token punctuation">(</span>controller<span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationController</span><span class="token punctuation">,</span> didCompleteWithError error<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Sign In with Apple Error: </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">error<span class="token punctuation">.</span>localizedDescription</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The Sign in request is initiated with <code>authController.performRequests()</code> which on first usage launches a splash screen explaining the benefits of <strong>Sign in with Apple</strong>:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-swiftui-signin-with-apple-splash.png" alt=""></p><p>Then new users will be able to customize the name &amp; email they&#39;ll share with your App:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-swiftui-signin-with-apple-new-user.png" alt=""></p><p>Upon successful authentication the <code>authorizationController</code> callback gets invoked with the users credentials captured in the <code>ASAuthorizationAppleIDCredential</code> struct that eventually calls <code>setUser()</code> with both the authenticated <code>credential</code> and its <code>authState</code>.</p><p><code>setUser()</code> then uses the authorized <code>credential</code> to authenticate with our remote ServiceStack instance, passing through the <code>givenName</code> and <code>familyName</code> that are only populated on a new Users initial Sign in request with the App.</p><div class="language-swift"><pre><code><span class="token keyword">func</span> <span class="token function-definition function">setUser</span><span class="token punctuation">(</span>credential<span class="token punctuation">:</span> <span class="token class-name">ASAuthorizationAppleIDCredential</span><span class="token punctuation">,</span> authState<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>authState <span class="token operator">=</span> authState

        <span class="token keyword">if</span> authState <span class="token operator">==</span> <span class="token string-literal"><span class="token string">&quot;authorized&quot;</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token class-name">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            request<span class="token punctuation">.</span>provider <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;apple&quot;</span></span>
            request<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoding<span class="token punctuation">:</span>credential<span class="token punctuation">.</span>identityToken<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> UTF8<span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span>
            request<span class="token punctuation">.</span>meta <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string-literal"><span class="token string">&quot;authorizationCode&quot;</span></span><span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoding<span class="token punctuation">:</span>credential<span class="token punctuation">.</span>authorizationCode<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> UTF8<span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string-literal"><span class="token string">&quot;givenName&quot;</span></span><span class="token punctuation">:</span> credential<span class="token punctuation">.</span>fullName<span class="token operator">?</span><span class="token punctuation">.</span>givenName <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span><span class="token punctuation">,</span>
                <span class="token string-literal"><span class="token string">&quot;familyName&quot;</span></span><span class="token punctuation">:</span> credential<span class="token punctuation">.</span>fullName<span class="token operator">?</span><span class="token punctuation">.</span>familyName <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
            <span class="token omit keyword">_</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">postAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>done <span class="token punctuation">{</span> r <span class="token keyword">in</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>auth <span class="token operator">=</span> r
                    <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;auth&quot;</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>bearerToken <span class="token operator">=</span> r<span class="token punctuation">.</span>bearerToken
                    <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>refreshToken <span class="token operator">=</span> r<span class="token punctuation">.</span>refreshToken
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token punctuation">{</span> error <span class="token keyword">in</span>
                    <span class="token keyword">let</span> status<span class="token punctuation">:</span><span class="token class-name">ResponseStatus</span> <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">convertUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">status<span class="token punctuation">.</span>errorCode <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">: </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">status<span class="token punctuation">.</span>message <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Like the Flutter example, we save the JSON serialized <code>AuthenticateResponse</code> DTO to enable persistent Authentication across App restarts and populate the <code>JsonServiceClient</code> with the JWT <code>bearerToken</code> and <code>refreshToken</code> to configure the authenticated Service Client.</p><p>To Sign out the user we can use a new fresh client instance and remove any shared cookies that were created by the previous client.</p><div class="language-swift"><pre><code><span class="token keyword">func</span> <span class="token function-definition function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token nil constant">nil</span>
        <span class="token class-name">HTTPCookieStorage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>cookies<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">HTTPCookieStorage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>deleteCookie<span class="token punctuation">)</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;auth&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="loading-persistent-jwt-auth-tokens" tabindex="-1">Loading persistent JWT Auth Tokens <a class="header-anchor" href="#loading-persistent-jwt-auth-tokens" aria-hidden="true">#</a></h3><p>Which is restored on App start and verified the JWT Token is still valid by calling the <code>Authenticate</code> Service with an empty DTO which returns if Authenticated otherwise throws a <strong>401 Unauthorized</strong> Error if they&#39;re not.</p><div class="language-swift"><pre><code><span class="token keyword">class</span> <span class="token class-name">ViewModel</span><span class="token punctuation">:</span> <span class="token class-name">ObservableObject</span> <span class="token punctuation">{</span>
  <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token comment">//...</span>

  <span class="token keyword">func</span> <span class="token function-definition function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token keyword">let</span> authJson <span class="token operator">=</span> <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;auth&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">let</span> auth <span class="token operator">=</span> <span class="token class-name">AuthenticateResponse</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>authJson<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          client<span class="token punctuation">.</span>bearerToken <span class="token operator">=</span> auth<span class="token punctuation">.</span>bearerToken
          client<span class="token punctuation">.</span>refreshToken <span class="token operator">=</span> auth<span class="token punctuation">.</span>refreshToken
          client<span class="token punctuation">.</span><span class="token function">postAsync</span><span class="token punctuation">(</span><span class="token class-name">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span>done <span class="token punctuation">{</span> r <span class="token keyword">in</span>
                  <span class="token keyword">self</span><span class="token punctuation">.</span>auth <span class="token operator">=</span> auth
              <span class="token punctuation">}</span>
              <span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token punctuation">{</span> error <span class="token keyword">in</span>
                  <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>bearerToken <span class="token operator">=</span> <span class="token nil constant">nil</span>
                  <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>refreshToken <span class="token operator">=</span> <span class="token nil constant">nil</span>
                  <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;auth&quot;</span></span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token punctuation">.</span>finally <span class="token punctuation">{</span>
                  <span class="token keyword">self</span><span class="token punctuation">.</span>hasInit <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">self</span><span class="token punctuation">.</span>hasInit <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="apple-recommends-maintaining-auth-tokens-in-keychain" tabindex="-1">Apple recommends maintaining Auth tokens in Keychain <a class="header-anchor" href="#apple-recommends-maintaining-auth-tokens-in-keychain" aria-hidden="true">#</a></h4><p>Whilst this example uses <code>UserDefaults</code>, Apple&#39;s recommendation is to instead <a href="https://developer.apple.com/documentation/authenticationservices/implementing_user_authentication_with_sign_in_with_apple#3546459" target="_blank" rel="noopener noreferrer">save auth tokens in the User&#39;s Keychain</a>.</p><h3 id="authenticated-requests" tabindex="-1">Authenticated Requests <a class="header-anchor" href="#authenticated-requests" aria-hidden="true">#</a></h3><p>With our Service Client configured with our JWT Auth Tokens it can now be used to perform authenticated requests using the generic <code>JsonServiceClient</code> to send typed Swift DTOs generated from the <a href="/swift-add-servicestack-reference.html">Swift ServiceStack Reference</a> feature:</p><div class="language-swift"><pre><code><span class="token keyword">func</span> <span class="token function-definition function">doSecureRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span>
    <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token class-name">HelloSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;SwiftUI&quot;</span></span>
        <span class="token omit keyword">_</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>done <span class="token punctuation">{</span> r <span class="token keyword">in</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>result <span class="token operator">=</span> r<span class="token punctuation">.</span>result <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span> <span class="token punctuation">{</span> error <span class="token keyword">in</span>
                <span class="token keyword">let</span> status<span class="token punctuation">:</span><span class="token class-name">ResponseStatus</span> <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">convertUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">status<span class="token punctuation">.</span>errorCode <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">: </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">status<span class="token punctuation">.</span>message <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Which when sent from an authenticated Service Client will result in the expected:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/dev/ios-swiftui-auth-request.jpeg" alt=""></p><h3 id="advanced-configuration" tabindex="-1">Advanced Configuration <a class="header-anchor" href="#advanced-configuration" aria-hidden="true">#</a></h3><p>As with ServiceStack&#39;s other <a href="/authentication-and-authorization.html#oauth-providers">OAuth Providers</a>, the behavior of the <code>AppleAuthProvider</code> can be further customized with the below configuration, when registering the <code>AppleAuthProvider</code> or in your App&#39;s configured <a href="/appsettings.html">App Settings</a>:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppleAuthProvider</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Apple Developer Membership Team ID</span>
    <span class="token comment">// appsettings: oauth.apple.TeamId</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> TeamId
    
    <span class="token comment">// Service ID</span>
    <span class="token comment">// appsettings: oauth.apple.ClientId</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ClientId
        
    <span class="token comment">// Bundle ID</span>
    <span class="token comment">// appsettings: oauth.apple.BundleId</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> BundleId

    <span class="token comment">// The Private Key ID</span>
    <span class="token comment">// appsettings: oauth.apple.KeyId</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> KeyId
    
    <span class="token comment">// Path to .p8 Private Key </span>
    <span class="token comment">// appsettings: oauth.apple.KeyPath</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> KeyPath

    <span class="token comment">// Base64 of .p8 Private Key bytes </span>
    <span class="token comment">// appsettings: oauth.apple.KeyBase64</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> KeyBase64
    
    <span class="token comment">// .p8 Private Key bytes </span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> KeyBytes
    
    <span class="token comment">// Customize ClientSecret JWT</span>
    <span class="token keyword">public</span> Func<span class="token operator">&lt;</span>AppleAuthProvider<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">&gt;</span> ClientSecretFactory
    
    <span class="token comment">// When JWT Client Secret expires, defaults to Apple Max 6 Month Expiry </span>
    <span class="token comment">// default: 6 months in secs </span>
    <span class="token comment">// appsettings: oauth.apple.ClientSecretExpiry</span>
    <span class="token keyword">public</span> TimeSpan ClientSecretExpiry
    
    <span class="token comment">// JSON list of Apple&#39;s public keys, defaults to fetching from https://appleid.apple.com/auth/keys</span>
    <span class="token comment">// appsettings: oauth.apple.IssuerSigningKeysJson</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> IssuerSigningKeysJson

    <span class="token comment">// Whether to cache private Key if loading from KeyPath, </span>
    <span class="token comment">// default: true</span>
    <span class="token comment">// appsettings: oauth.apple.CacheKey</span>
    <span class="token keyword">public</span> <span class="token keyword">bool</span> CacheKey

    <span class="token comment">// Whether to cache Apple&#39;s public keys</span>
    <span class="token comment">// default: true</span>
    <span class="token comment">// appsettings: oauth.apple.CacheKey</span>
    <span class="token keyword">public</span> <span class="token keyword">bool</span> CacheIssuerSigningKeys

    <span class="token comment">// How long before re-validating Sign in RefreshToken, default: 1 day.</span>
    <span class="token comment">// Set to null to disable RefreshToken validation.</span>
    <span class="token keyword">public</span> TimeSpan<span class="token punctuation">?</span> ValidateRefreshTokenExpiry

    <span class="token comment">// Custom DisplayName resolver function when not sent by Apple</span>
    <span class="token keyword">public</span> Func<span class="token operator">&lt;</span>IAuthSession<span class="token punctuation">,</span>IAuthTokens<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">&gt;</span> ResolveUnknownDisplayName
<span class="token punctuation">}</span>
</code></pre></div>__VP_STATIC_END__`,132),o=[p];function c(i,l,u,r,k,d){return a(),s("div",null,o)}var m=n(e,[["render",c]]);export{g as __pageData,m as default};
